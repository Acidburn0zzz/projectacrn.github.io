

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>ACPI Virtualization high-level design &mdash; Project ACRN™ v 0.2-unstable documentation</title>
  

  
  
    <link rel="shortcut icon" href="../_static/ACRN-favicon-32x32.png"/>
  
  
  

  

  
  
    

  

  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../_static/acrn-custom.css" type="text/css" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Interrupt Management high-level design" href="interrupt-hld.html" />
    <link rel="prev" title="UART Virtualization" href="uart-virtualization.html" /> 

  
  <script src="../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../index.html" class="icon icon-home"> Project ACRN™
          

          
            
            <img src="../_static/ACRN_Logo_200w.png" class="logo" alt="Logo"/>
          
          </a>

          
            
            
              <div class="version">
                latest
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../introduction/index.html">Introduction to Project ACRN</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../introduction/index.html#automotive-use-case-example">Automotive Use Case Example</a></li>
<li class="toctree-l2"><a class="reference internal" href="../introduction/index.html#licensing">Licensing</a></li>
<li class="toctree-l2"><a class="reference internal" href="../introduction/index.html#acrn-device-model-service-os-and-user-os">ACRN Device Model, Service OS, and User OS</a></li>
<li class="toctree-l2"><a class="reference internal" href="../introduction/index.html#boot-sequence">Boot Sequence</a></li>
<li class="toctree-l2"><a class="reference internal" href="../introduction/index.html#acrn-hypervisor-architecture">ACRN Hypervisor Architecture</a></li>
<li class="toctree-l2"><a class="reference internal" href="../introduction/index.html#acrn-device-model-architecture">ACRN Device Model Architecture</a></li>
<li class="toctree-l2"><a class="reference internal" href="../introduction/index.html#device-pass-through">Device pass through</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../introduction/index.html#hardware-support-for-device-passthrough">Hardware support for device passthrough</a></li>
<li class="toctree-l3"><a class="reference internal" href="../introduction/index.html#hypervisor-support-for-device-passthrough">Hypervisor support for device passthrough</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../introduction/index.html#acrn-i-o-mediator">ACRN I/O mediator</a></li>
<li class="toctree-l2"><a class="reference internal" href="../introduction/index.html#virtio-framework-architecture">Virtio framework architecture</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../getting-started/index.html">Getting Started Guides</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../getting-started/apl-nuc.html">Getting started guide for Intel NUC</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../getting-started/apl-nuc.html#hardware-setup">Hardware setup</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../getting-started/apl-nuc.html#firmware-update-on-the-nuc">Firmware update on the NUC</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../getting-started/apl-nuc.html#software-setup">Software setup</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../getting-started/apl-nuc.html#set-up-a-clear-linux-operating-system">Set up a Clear Linux Operating System</a></li>
<li class="toctree-l4"><a class="reference internal" href="../getting-started/apl-nuc.html#add-the-acrn-hypervisor-to-the-efi-partition">Add the ACRN hypervisor to the EFI Partition</a></li>
<li class="toctree-l4"><a class="reference internal" href="../getting-started/apl-nuc.html#acrn-network-bridge">ACRN Network Bridge</a></li>
<li class="toctree-l4"><a class="reference internal" href="../getting-started/apl-nuc.html#set-up-reference-uos">Set up Reference UOS</a></li>
<li class="toctree-l4"><a class="reference internal" href="../getting-started/apl-nuc.html#device-manager-memory-allocation-mechanism">Device Manager memory allocation mechanism</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../getting-started/apl-nuc.html#build-acrn-from-source">Build ACRN from Source</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../getting-started/apl-nuc.html#install-build-tools-and-dependencies">Install build tools and dependencies</a></li>
<li class="toctree-l4"><a class="reference internal" href="../getting-started/apl-nuc.html#build-the-hypervisor-device-model-and-tools">Build the hypervisor, device model and tools</a></li>
<li class="toctree-l4"><a class="reference internal" href="../getting-started/apl-nuc.html#generate-the-hypervisor-configurations">Generate the hypervisor configurations</a></li>
<li class="toctree-l4"><a class="reference internal" href="../getting-started/apl-nuc.html#modify-the-hypervisor-configurations">Modify the hypervisor configurations</a></li>
<li class="toctree-l4"><a class="reference internal" href="../getting-started/apl-nuc.html#create-a-new-default-configuration">Create a new default configuration</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../getting-started/up2.html">Getting started guide for UP2 board</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../getting-started/up2.html#hardware-setup">Hardware setup</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../getting-started/up2.html#connecting-to-the-serial-port">Connecting to the serial port</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../getting-started/up2.html#software-setup">Software setup</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../getting-started/up2.html#up2-serial-port-setting">UP2 serial port setting</a></li>
<li class="toctree-l4"><a class="reference internal" href="../getting-started/up2.html#up2-block-device">UP2 block device</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../getting-started/up2.html#running-the-hypervisor">Running the hypervisor</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../hardware.html">Supported Hardware</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../hardware.html#intel-apollo-lake-nuc">Intel Apollo Lake NUC</a></li>
<li class="toctree-l2"><a class="reference internal" href="../hardware.html#up-squared-board">UP Squared board</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../user-guides/index.html">User Guides</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../user-guides/acrn-shell.html">ACRN Shell Commands</a></li>
<li class="toctree-l2"><a class="reference internal" href="../user-guides/tools.html">Tools</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../tools/acrn-crashlog/README.html">ACRN-Crashlog</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../tools/acrn-crashlog/README.html#introduction">Introduction</a></li>
<li class="toctree-l4"><a class="reference internal" href="../tools/acrn-crashlog/README.html#building">Building</a></li>
<li class="toctree-l4"><a class="reference internal" href="../tools/acrn-crashlog/README.html#installing">Installing</a></li>
<li class="toctree-l4"><a class="reference internal" href="../tools/acrn-crashlog/README.html#usage">Usage</a></li>
<li class="toctree-l4"><a class="reference internal" href="../tools/acrn-crashlog/README.html#source-code">Source Code</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../tools/acrn-crashlog/acrnprobe/README.html">acrnprobe</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../tools/acrn-crashlog/acrnprobe/README.html#description">Description</a></li>
<li class="toctree-l4"><a class="reference internal" href="../tools/acrn-crashlog/acrnprobe/README.html#usage">Usage</a></li>
<li class="toctree-l4"><a class="reference internal" href="../tools/acrn-crashlog/acrnprobe/README.html#architecture">Architecture</a></li>
<li class="toctree-l4"><a class="reference internal" href="../tools/acrn-crashlog/acrnprobe/README.html#source-files">Source files</a></li>
<li class="toctree-l4"><a class="reference internal" href="../tools/acrn-crashlog/acrnprobe/README.html#configuration-files">Configuration files</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../tools/acrn-crashlog/usercrash/README.html">usercrash</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../tools/acrn-crashlog/usercrash/README.html#description">Description</a></li>
<li class="toctree-l4"><a class="reference internal" href="../tools/acrn-crashlog/usercrash/README.html#design">Design</a></li>
<li class="toctree-l4"><a class="reference internal" href="../tools/acrn-crashlog/usercrash/README.html#usage">Usage</a></li>
<li class="toctree-l4"><a class="reference internal" href="../tools/acrn-crashlog/usercrash/README.html#souce-code">Souce Code</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../tools/acrn-manager/README.html">acrnctl and acrnd</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../tools/acrn-manager/README.html#description">Description</a></li>
<li class="toctree-l4"><a class="reference internal" href="../tools/acrn-manager/README.html#usage">Usage</a></li>
<li class="toctree-l4"><a class="reference internal" href="../tools/acrn-manager/README.html#acrnd">acrnd</a></li>
<li class="toctree-l4"><a class="reference internal" href="../tools/acrn-manager/README.html#build-and-install">Build and Install</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../tools/acrnlog/README.html">acrnlog</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../tools/acrnlog/README.html#description">Description</a></li>
<li class="toctree-l4"><a class="reference internal" href="../tools/acrnlog/README.html#usage">Usage</a></li>
<li class="toctree-l4"><a class="reference internal" href="../tools/acrnlog/README.html#build-and-install">Build and Install</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../tools/acrntrace/README.html">acrntrace</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../tools/acrntrace/README.html#description">Description</a></li>
<li class="toctree-l4"><a class="reference internal" href="../tools/acrntrace/README.html#usage">Usage</a></li>
<li class="toctree-l4"><a class="reference internal" href="../tools/acrntrace/README.html#build-and-install">Build and Install</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Developer Guides</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="primer.html">Developer Primer</a><ul>
<li class="toctree-l3"><a class="reference internal" href="primer.html#source-tree-structure">Source Tree Structure</a><ul>
<li class="toctree-l4"><a class="reference internal" href="primer.html#acrn-hypervisor-source-tree">ACRN hypervisor source tree</a></li>
<li class="toctree-l4"><a class="reference internal" href="primer.html#acrn-device-model-source-tree">ACRN Device Model source tree</a></li>
<li class="toctree-l4"><a class="reference internal" href="primer.html#acrn-tools-source-tree">ACRN Tools source tree</a></li>
<li class="toctree-l4"><a class="reference internal" href="primer.html#acrn-documentation-source-tree">ACRN documentation source tree</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="primer.html#cpu-virtualization">CPU virtualization</a><ul>
<li class="toctree-l4"><a class="reference internal" href="primer.html#host-gdt">Host GDT</a></li>
<li class="toctree-l4"><a class="reference internal" href="primer.html#host-idt">Host IDT</a></li>
<li class="toctree-l4"><a class="reference internal" href="primer.html#guest-smp-booting">Guest SMP Booting</a></li>
<li class="toctree-l4"><a class="reference internal" href="primer.html#vmx-configuration">VMX configuration</a></li>
<li class="toctree-l4"><a class="reference internal" href="primer.html#cpuid-and-guest-tsc-calibration">CPUID and Guest TSC calibration</a></li>
<li class="toctree-l4"><a class="reference internal" href="primer.html#rdtsc-rdtscp">RDTSC/RDTSCP</a></li>
<li class="toctree-l4"><a class="reference internal" href="primer.html#cr-register-virtualization">CR Register virtualization</a></li>
<li class="toctree-l4"><a class="reference internal" href="primer.html#msr-bitmap">MSR BITMAP</a></li>
<li class="toctree-l4"><a class="reference internal" href="primer.html#i-o-bitmap">I/O BITMAP</a></li>
<li class="toctree-l4"><a class="reference internal" href="primer.html#exceptions">Exceptions</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="primer.html#memory-virtualization">Memory virtualization</a><ul>
<li class="toctree-l4"><a class="reference internal" href="primer.html#physical-memory-layout">Physical Memory Layout</a></li>
<li class="toctree-l4"><a class="reference internal" href="primer.html#pv-mmu-memory-mapping-in-the-hypervisor">PV (MMU) Memory Mapping in the Hypervisor</a></li>
<li class="toctree-l4"><a class="reference internal" href="primer.html#pv-mmu-memory-mapping-in-vms">PV (MMU) Memory Mapping in VMs</a></li>
<li class="toctree-l4"><a class="reference internal" href="primer.html#host-guest-ept-memory-mapping">Host-Guest (EPT) Memory Mapping</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="primer.html#graphic-mediation">Graphic mediation</a></li>
<li class="toctree-l3"><a class="reference internal" href="primer.html#i-o-emulation">I/O emulation</a><ul>
<li class="toctree-l4"><a class="reference internal" href="primer.html#device-assignment-management">Device Assignment Management</a></li>
<li class="toctree-l4"><a class="reference internal" href="primer.html#pio-mmio-trap-flow">PIO/MMIO trap Flow</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="primer.html#virtual-interrupt">Virtual interrupt</a><ul>
<li class="toctree-l4"><a class="reference internal" href="primer.html#virtual-lapic">Virtual LAPIC</a></li>
<li class="toctree-l4"><a class="reference internal" href="primer.html#virtual-ioapic">Virtual IOAPIC</a></li>
<li class="toctree-l4"><a class="reference internal" href="primer.html#virtual-pic">Virtual PIC</a></li>
<li class="toctree-l4"><a class="reference internal" href="primer.html#virtual-interrupt-injection">Virtual Interrupt Injection</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="primer.html#vt-x-and-vt-d">VT-x and VT-d</a></li>
<li class="toctree-l3"><a class="reference internal" href="primer.html#hypercall">Hypercall</a></li>
<li class="toctree-l3"><a class="reference internal" href="primer.html#device-emulation">Device emulation</a></li>
<li class="toctree-l3"><a class="reference internal" href="primer.html#virtio-devices">Virtio Devices</a><ul>
<li class="toctree-l4"><a class="reference internal" href="primer.html#virtio-rnd">Virtio-rnd</a></li>
<li class="toctree-l4"><a class="reference internal" href="primer.html#virtio-blk">Virtio-blk</a></li>
<li class="toctree-l4"><a class="reference internal" href="primer.html#virtio-net">Virtio-net</a></li>
<li class="toctree-l4"><a class="reference internal" href="primer.html#virtio-console">Virtio-console</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../api/index.html">API Documentation</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../api/hypercall_api.html">Hypercall APIs</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/devicemodel_api.html">Device Model APIs</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/GVT-g_api.html">ACRN GVT-g APIs</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/GVT-g_api.html#core-driver-infrastructure">Core Driver Infrastructure</a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/GVT-g_api.html#vhm-apis-called-from-acrn-gt">VHM APIs called from ACRN-GT</a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/GVT-g_api.html#acrn-gt-mediated-pass-through-mpt-interface">ACRN-GT mediated pass-through (MPT) interface</a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/GVT-g_api.html#gvt-g-intel-gvt-ops-interface">GVT-g intel_gvt_ops interface</a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/GVT-g_api.html#acrn-gt-sysfs-interface">ACRN-GT sysfs interface</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../reference/kconfig/index.html">Configuration Symbol Reference</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../reference/kconfig/index.html#introduction">Introduction</a></li>
<li class="toctree-l3"><a class="reference internal" href="../reference/kconfig/index.html#supported-options">Supported Options</a></li>
</ul>
</li>
<li class="toctree-l2 current"><a class="reference internal" href="index.html#high-level-design-guides">High-Level Design Guides</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="memmgt-hld.html">Memory Management high-level design</a><ul>
<li class="toctree-l4"><a class="reference internal" href="memmgt-hld.html#overview">Overview</a></li>
<li class="toctree-l4"><a class="reference internal" href="memmgt-hld.html#hypervisor-memory-management">Hypervisor Memory Management</a></li>
<li class="toctree-l4"><a class="reference internal" href="memmgt-hld.html#service-os-memory-management">Service OS Memory Management</a></li>
<li class="toctree-l4"><a class="reference internal" href="memmgt-hld.html#user-os-memory-management">User OS Memory Management</a></li>
<li class="toctree-l4"><a class="reference internal" href="memmgt-hld.html#memory-interaction">Memory Interaction</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="virtio-hld.html">Virtio high-level design</a><ul>
<li class="toctree-l4"><a class="reference internal" href="virtio-hld.html#virtio-device">Virtio Device</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="virtio-console.html">Virtio-Console High-Level design</a><ul>
<li class="toctree-l4"><a class="reference internal" href="virtio-console.html#console-backend-use-cases">Console Backend Use Cases</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="uart-virtualization.html">UART Virtualization</a><ul>
<li class="toctree-l4"><a class="reference internal" href="uart-virtualization.html#architecture">Architecture</a></li>
</ul>
</li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">ACPI Virtualization high-level design</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#acpi-introduction">ACPI introduction</a></li>
<li class="toctree-l4"><a class="reference internal" href="#acpi-virtualization">ACPI virtualization</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="interrupt-hld.html">Interrupt Management high-level design</a><ul>
<li class="toctree-l4"><a class="reference internal" href="interrupt-hld.html#overview">Overview</a></li>
<li class="toctree-l4"><a class="reference internal" href="interrupt-hld.html#hypervisor-physical-interrupt-management">Hypervisor Physical Interrupt Management</a></li>
<li class="toctree-l4"><a class="reference internal" href="interrupt-hld.html#guest-virtual-interrupt-management">Guest Virtual Interrupt Management</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="APL_GVT-g-hld.html">GVT-G high-level design</a><ul>
<li class="toctree-l4"><a class="reference internal" href="APL_GVT-g-hld.html#introduction">Introduction</a></li>
<li class="toctree-l4"><a class="reference internal" href="APL_GVT-g-hld.html#background">Background</a></li>
<li class="toctree-l4"><a class="reference internal" href="APL_GVT-g-hld.html#mediated-pass-through">Mediated Pass-Through</a></li>
<li class="toctree-l4"><a class="reference internal" href="APL_GVT-g-hld.html#high-level-architecture">High Level Architecture</a></li>
<li class="toctree-l4"><a class="reference internal" href="APL_GVT-g-hld.html#key-techniques">Key Techniques</a></li>
<li class="toctree-l4"><a class="reference internal" href="APL_GVT-g-hld.html#acrn-gt">ACRN-GT</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="GVT-G-porting.html">GVT-G Enabling and Porting Guide</a><ul>
<li class="toctree-l4"><a class="reference internal" href="GVT-G-porting.html#introduction">Introduction</a></li>
<li class="toctree-l4"><a class="reference internal" href="GVT-G-porting.html#purpose-of-this-document">Purpose of this document</a></li>
<li class="toctree-l4"><a class="reference internal" href="GVT-G-porting.html#overall-components">Overall Components</a></li>
<li class="toctree-l4"><a class="reference internal" href="GVT-G-porting.html#core-scenario-interaction-sequences">Core scenario interaction sequences</a></li>
<li class="toctree-l4"><a class="reference internal" href="GVT-G-porting.html#api-details">API details</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="index.html#contributing-to-the-project">Contributing to the project</a><ul>
<li class="toctree-l3"><a class="reference internal" href="contribute_guidelines.html">Contribution Guidelines</a><ul>
<li class="toctree-l4"><a class="reference internal" href="contribute_guidelines.html#licensing">Licensing</a></li>
<li class="toctree-l4"><a class="reference internal" href="contribute_guidelines.html#developer-certification-of-origin-dco">Developer Certification of Origin (DCO)</a></li>
<li class="toctree-l4"><a class="reference internal" href="contribute_guidelines.html#prerequisites">Prerequisites</a></li>
<li class="toctree-l4"><a class="reference internal" href="contribute_guidelines.html#repository-layout">Repository layout</a></li>
<li class="toctree-l4"><a class="reference internal" href="contribute_guidelines.html#submitting-issues">Submitting Issues</a></li>
<li class="toctree-l4"><a class="reference internal" href="contribute_guidelines.html#contribution-tools-and-git-setup">Contribution Tools and Git Setup</a></li>
<li class="toctree-l4"><a class="reference internal" href="contribute_guidelines.html#coding-style">Coding Style</a></li>
<li class="toctree-l4"><a class="reference internal" href="contribute_guidelines.html#contribution-workflow">Contribution Workflow</a></li>
<li class="toctree-l4"><a class="reference internal" href="contribute_guidelines.html#commit-guidelines">Commit Guidelines</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="doc_guidelines.html">Documentation Guidelines</a><ul>
<li class="toctree-l4"><a class="reference internal" href="doc_guidelines.html#headings">Headings</a></li>
<li class="toctree-l4"><a class="reference internal" href="doc_guidelines.html#content-highlighting">Content Highlighting</a></li>
<li class="toctree-l4"><a class="reference internal" href="doc_guidelines.html#lists">Lists</a></li>
<li class="toctree-l4"><a class="reference internal" href="doc_guidelines.html#multi-column-lists">Multi-column lists</a></li>
<li class="toctree-l4"><a class="reference internal" href="doc_guidelines.html#file-names-and-commands">File names and Commands</a></li>
<li class="toctree-l4"><a class="reference internal" href="doc_guidelines.html#internal-cross-reference-linking">Internal Cross-Reference Linking</a></li>
<li class="toctree-l4"><a class="reference internal" href="doc_guidelines.html#non-ascii-characters">Non-ASCII Characters</a></li>
<li class="toctree-l4"><a class="reference internal" href="doc_guidelines.html#code-and-command-examples">Code and Command Examples</a></li>
<li class="toctree-l4"><a class="reference internal" href="doc_guidelines.html#tabs-spaces-and-indenting">Tabs, spaces, and indenting</a></li>
<li class="toctree-l4"><a class="reference internal" href="doc_guidelines.html#drawings">Drawings</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="graphviz.html">Drawings using graphviz</a><ul>
<li class="toctree-l4"><a class="reference internal" href="graphviz.html#simple-directed-graph">Simple directed graph</a></li>
<li class="toctree-l4"><a class="reference internal" href="graphviz.html#adding-edge-labels">Adding edge labels</a></li>
<li class="toctree-l4"><a class="reference internal" href="graphviz.html#tables">Tables</a></li>
<li class="toctree-l4"><a class="reference internal" href="graphviz.html#finite-state-machine">Finite-State Machine</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../tutorials/index.html">Tutorials</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../tutorials/docbuild.html">ACRN documentation generation</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../tutorials/docbuild.html#documentation-overview">Documentation overview</a></li>
<li class="toctree-l3"><a class="reference internal" href="../tutorials/docbuild.html#set-up-the-documentation-working-folders">Set up the documentation working folders</a></li>
<li class="toctree-l3"><a class="reference internal" href="../tutorials/docbuild.html#installing-the-documentation-tools">Installing the documentation tools</a></li>
<li class="toctree-l3"><a class="reference internal" href="../tutorials/docbuild.html#documentation-presentation-theme">Documentation presentation theme</a></li>
<li class="toctree-l3"><a class="reference internal" href="../tutorials/docbuild.html#running-the-documentation-processors">Running the documentation processors</a></li>
<li class="toctree-l3"><a class="reference internal" href="../tutorials/docbuild.html#publishing-content">Publishing content</a></li>
<li class="toctree-l3"><a class="reference internal" href="../tutorials/docbuild.html#filtering-expected-warnings">Filtering expected warnings</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../tutorials/static-ip.html">Using a static IP address</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../tutorials/static-ip.html#acrn-network-setup">ACRN Network Setup</a></li>
<li class="toctree-l3"><a class="reference internal" href="../tutorials/static-ip.html#setting-up-the-static-ip-address">Setting up the static IP address</a></li>
<li class="toctree-l3"><a class="reference internal" href="../tutorials/static-ip.html#activate-the-new-configuration">Activate the new configuration</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../tutorials/using_ubuntu_as_sos.html">Using Ubuntu as the Service OS</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../tutorials/using_ubuntu_as_sos.html#install-ubuntu-natively">Install Ubuntu (natively)</a></li>
<li class="toctree-l3"><a class="reference internal" href="../tutorials/using_ubuntu_as_sos.html#install-acrn">Install ACRN</a></li>
<li class="toctree-l3"><a class="reference internal" href="../tutorials/using_ubuntu_as_sos.html#install-the-service-os-kernel">Install the Service OS kernel</a></li>
<li class="toctree-l3"><a class="reference internal" href="../tutorials/using_ubuntu_as_sos.html#prepare-the-user-os-uos">Prepare the User OS (UOS)</a></li>
<li class="toctree-l3"><a class="reference internal" href="../tutorials/using_ubuntu_as_sos.html#start-the-user-os-uos">Start the User OS (UOS)</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../release_notes.html">Release Notes</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../release_notes.html#version-0-1-release-july-2018">Version 0.1 release (July 2018)</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../release_notes.html#version-0-1-new-features">Version 0.1 new features</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../release_notes.html#hardware-support">Hardware Support</a></li>
<li class="toctree-l4"><a class="reference internal" href="../release_notes.html#gvt-g-for-acrn">GVT-g for ACRN</a></li>
<li class="toctree-l4"><a class="reference internal" href="../release_notes.html#virtio-standard-is-supported">Virtio standard is supported</a></li>
<li class="toctree-l4"><a class="reference internal" href="../release_notes.html#device-pass-through-support">Device pass-through support</a></li>
<li class="toctree-l4"><a class="reference internal" href="../release_notes.html#hypervisor-configuration">Hypervisor configuration</a></li>
<li class="toctree-l4"><a class="reference internal" href="../release_notes.html#new-acrn-tools">New ACRN tools</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../release_notes.html#known-issues">Known Issues</a></li>
<li class="toctree-l3"><a class="reference internal" href="../release_notes.html#change-log">Change Log</a></li>
</ul>
</li>
</ul>
</li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Project ACRN™</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
          <li><a href="index.html">Developer Guides</a> &raquo;</li>
        
      <li>ACPI Virtualization high-level design</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="acpi-virtualization-high-level-design">
<span id="acpi-virt-hld"></span><h1>ACPI Virtualization high-level design<a class="headerlink" href="#acpi-virtualization-high-level-design" title="Permalink to this headline">¶</a></h1>
<div class="section" id="acpi-introduction">
<h2>ACPI introduction<a class="headerlink" href="#acpi-introduction" title="Permalink to this headline">¶</a></h2>
<p>Advanced Configuration and Power Interface (ACPI) provides an open
standard that operating systems can use to discover and configure
computer hardware components to perform power management for example, by
monitoring status and putting unused components to sleep.</p>
<p>Functions implemented by ACPI include:</p>
<ul class="simple">
<li>System/Device/Processor power management</li>
<li>Device/Processor performance management</li>
<li>Configuration / Plug and Play</li>
<li>System event</li>
<li>Battery management</li>
<li>Thermal management</li>
</ul>
<p>ACPI enumerates and lists the different DMA engines in the platform, and
device scope relationships between PCI devices and which DMA engine
controls them. All critical functions depend on ACPI tables. Here’s an
example on an Apollo Lake platform (APL) with Linux installed:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>root@:Dom0 ~ $ ls /sys/firmware/acpi/tables/
APIC  data  DMAR  DSDT  dynamic  FACP  FACS  HPET  MCFG  NHLT  TPM2
</pre></div>
</div>
<p>These tables provide different information and functions:</p>
<ul class="simple">
<li>Advanced Programmable Interrupt Controller (APIC) for Symmetric
Multiprocessor systems (SMP),</li>
<li>DMA remapping (DMAR) for Intel® Virtualization Technology for
Directed I/O (VT-d),</li>
<li>Non-HD Audio Link Table (NHLT) for supporting audio device,</li>
<li>and Differentiated System Description Table (DSDT) for system
configuration info. DSDT is a major ACPI table used to describe what
peripherals the machine has, and information on PCI IRQ mappings and
power management</li>
</ul>
<p>Most of the ACPI functionality is provided in ACPI Machine Language
(AML) bytecode stored in the ACPI tables. To make use of these tables,
Linux implements an interpreter for the AML bytecode. At BIOS
development time, the AML bytecode is compiled from the ASL (ACPI Source
Language) code.  The <code class="docutils literal notranslate"><span class="pre">iasl</span></code> command is used to disassemble the ACPI table
and display its contents:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>root@:Dom0 ~ $ cp /sys/firmware/acpi/tables/DMAR .
root@:Dom0 ~ $ iasl -d DMAR

Intel ACPI Component Architecture
ASL+ Optimizing Compiler/Disassembler version 20170728
Copyright (c) 2000 - 2017 Intel Corporation
Input file DMAR, Length 0xB0 (176) bytes
ACPI: DMAR 0x0000000000000000 0000B0 (v01 INTEL  BDW      00000001 INTL 00000001)
Acpi Data Table [DMAR] decoded
Formatted output:  DMAR.dsl - 5286 bytes

root@:Dom0 ~ $ cat DMAR.dsl
[000h 0000   4]                    Signature : &quot;DMAR&quot;    [DMA Remapping table]
[004h 0004   4]                 Table Length : 000000B0
[008h 0008   1]                     Revision : 01
...
[030h 0048   2]                Subtable Type : 0000 [Hardware Unit Definition]
[032h 0050   2]                       Length : 0018
[034h 0052   1]                        Flags : 00
[035h 0053   1]                     Reserved : 00
[036h 0054   2]           PCI Segment Number : 0000
[038h 0056   8]        Register Base Address : 00000000FED64000
</pre></div>
</div>
<p>From the displayed ASL, we can see some generic table fields, such as
the version information, and one VTd remapping engine description with
FED64000 as base address.</p>
<p>We can modify DMAR.dsl and assemble it again to AML:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>root@:Dom0 ~ $ iasl DMAR.dsl
Intel ACPI Component Architecture
ASL+ Optimizing Compiler/Disassembler version 20170728
Copyright (c) 2000 - 2017 Intel Corporation
Table Input:   DMAR.dsl - 113 lines, 5286 bytes, 72 fields
Binary Output: DMAR.aml - 176 bytes
Compilation complete. 0 Errors, 0 Warnings, 0 Remarks
</pre></div>
</div>
<p>We can see the new AML file <code class="docutils literal notranslate"><span class="pre">DMAR.aml</span></code> is created.</p>
<p>There are many ACPI tables in the system, linked together via table
pointers.  In all ACPI-compatible system, the OS can enumerate all
needed tables starting with the Root System Description Pointer (RSDP)
provided at a known place in the system low address space, and pointing
to  an XSDT (Extended System Description Table). The following picture
shows a typical ACPI table layout in an Intel APL platform:</p>
<div class="figure align-center" id="acpi-layout">
<a class="reference internal image-reference" href="../_images/acpi-image1.png"><img alt="../_images/acpi-image1.png" src="../_images/acpi-image1.png" style="width: 700px;" /></a>
<p class="caption"><span class="caption-number">Figure 40 </span><span class="caption-text">Typical ACPI table layout in an Intel APL platform</span></p>
</div>
</div>
<div class="section" id="acpi-virtualization">
<h2>ACPI virtualization<a class="headerlink" href="#acpi-virtualization" title="Permalink to this headline">¶</a></h2>
<p>Most modern OSes requires ACPI, so ACRN provides ACPI virtualization to
emulate an ACPI-capable virtual platform for the guest OS. To achieve
this, there are two options, depending on physical device and ACPI
resources are abstracted: Partitioning and Emulation.</p>
<div class="section" id="partitioning">
<h3>Partitioning<a class="headerlink" href="#partitioning" title="Permalink to this headline">¶</a></h3>
<p>One option is to assign and partition physical devices and ACPI
resources among all guest OSes. That means each guest OS owns specific
devices with passthrough, such as shown below:</p>
<table border="1" class="docutils">
<colgroup>
<col width="33%" />
<col width="33%" />
<col width="33%" />
</colgroup>
<tbody valign="top">
<tr class="row-odd"><td>PCI Devices</td>
<td>VM0(Cluster VM)</td>
<td>VM1(IVI VM)</td>
</tr>
<tr class="row-even"><td>I2C</td>
<td>I2C3, I2C0</td>
<td>I2C1, I2C2, I2C4, I2C5,
I2C6, I2C7</td>
</tr>
<tr class="row-odd"><td>SPI</td>
<td>SPI1</td>
<td>SPI0, SPI2</td>
</tr>
<tr class="row-even"><td>USB</td>
<td>&#160;</td>
<td>USB-Host (xHCI) and
USB-Device (xDCI)</td>
</tr>
<tr class="row-odd"><td>SDIO</td>
<td>&#160;</td>
<td>SDIO</td>
</tr>
<tr class="row-even"><td>IPU</td>
<td>&#160;</td>
<td>IPU</td>
</tr>
<tr class="row-odd"><td>Ethernet</td>
<td>Ethernet</td>
<td>&#160;</td>
</tr>
<tr class="row-even"><td>WIFI</td>
<td>&#160;</td>
<td>WIFI</td>
</tr>
<tr class="row-odd"><td>Bluetooth</td>
<td>&#160;</td>
<td>Bluetooth</td>
</tr>
<tr class="row-even"><td>Audio</td>
<td>&#160;</td>
<td>Audio</td>
</tr>
<tr class="row-odd"><td>GPIO</td>
<td>GPIO</td>
<td>&#160;</td>
</tr>
<tr class="row-even"><td>UART</td>
<td>UART</td>
<td>&#160;</td>
</tr>
</tbody>
</table>
<p>In an early ACRN development phase, partitioning was used for
simplicity. To implement partitioning, we need to hack the PCI logic to
make different VMs see a different subset of devices, and create one
copy of the ACPI tables for each of them, as shown in the following
picture:</p>
<div class="figure align-center">
<a class="reference internal image-reference" href="../_images/acpi-image3.png"><img alt="../_images/acpi-image3.png" src="../_images/acpi-image3.png" style="width: 900px;" /></a>
</div>
<p>For each VM, its ACPI tables are standalone copies and not related to
other VMs. Opregion also needs to be copied for different VM.</p>
<p>For each table, we make modifications, based on the physical table, to
reflect the assigned devices to a particular VM. In the picture below,
we can see keep SP2(0:19.1) for VM0, and SP1(0:19.0)/SP3(0:19.2) for
VM1. Any time a partition policy changes, we need to modify both tables
again, including dissembling, modification, and assembling, which is
tricky and bug-prone.</p>
<div class="figure align-center">
<a class="reference internal image-reference" href="../_images/acpi-image2.png"><img alt="../_images/acpi-image2.png" src="../_images/acpi-image2.png" style="width: 900px;" /></a>
</div>
<div class="section" id="emulation">
<h4>Emulation<a class="headerlink" href="#emulation" title="Permalink to this headline">¶</a></h4>
<p>A second option is for the SOS (VM0) to “own” all devices and emulate a
set of virtual devices for each of the UOS (VM1). This is the most
popular model for virtualization, as show below. ACRN currently uses
device emulation plus some device passthrough for UOS.</p>
<div class="figure align-center">
<a class="reference internal image-reference" href="../_images/acpi-image5.png"><img alt="../_images/acpi-image5.png" src="../_images/acpi-image5.png" style="width: 400px;" /></a>
</div>
<p>Regarding ACPI virtualization in ACRN, different policy are used for
different components:</p>
<ul class="simple">
<li>Hypervisor - ACPI is transparent to the Hypervisor, which has no
knowledge of ACPI at all.</li>
<li>SOS - All ACPI resources are physically owned by the SOS, which
enumerates all ACPI tables and devices.</li>
<li>UOS - Virtual ACPI resources exposed by the device model are owned by
UOS.</li>
</ul>
<p>Source for the ACPI emulation code for the device model is found in
<code class="docutils literal notranslate"><span class="pre">hw/platform/acpi/acpi.c</span></code>.</p>
<p>Each entry in <code class="docutils literal notranslate"><span class="pre">basl_ftables</span></code> is related to each virtual ACPI table,
including following elements:</p>
<ul class="simple">
<li>wsect - output handler to write related ACPI table contents to
specific file</li>
<li>offset - related ACPI table offset in the memory</li>
<li>valid - dynamically indicate if this table is needed</li>
</ul>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">static</span> <span class="k">struct</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">wsect</span><span class="p">)(</span><span class="kt">FILE</span> <span class="o">*</span><span class="n">fp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">vmctx</span> <span class="o">*</span><span class="n">ctx</span><span class="p">);</span>
    <span class="kt">uint64_t</span>  <span class="n">offset</span><span class="p">;</span>
    <span class="kt">bool</span>    <span class="n">valid</span><span class="p">;</span>
<span class="p">}</span> <span class="n">basl_ftables</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
    <span class="p">{</span> <span class="n">basl_fwrite_rsdp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>       <span class="nb">true</span>  <span class="p">},</span>
    <span class="p">{</span> <span class="n">basl_fwrite_rsdt</span><span class="p">,</span> <span class="n">RSDT_OFFSET</span><span class="p">,</span> <span class="nb">true</span>  <span class="p">},</span>
    <span class="p">{</span> <span class="n">basl_fwrite_xsdt</span><span class="p">,</span> <span class="n">XSDT_OFFSET</span><span class="p">,</span> <span class="nb">true</span>  <span class="p">},</span>
    <span class="p">{</span> <span class="n">basl_fwrite_madt</span><span class="p">,</span> <span class="n">MADT_OFFSET</span><span class="p">,</span> <span class="nb">true</span>  <span class="p">},</span>
    <span class="p">{</span> <span class="n">basl_fwrite_fadt</span><span class="p">,</span> <span class="n">FADT_OFFSET</span><span class="p">,</span> <span class="nb">true</span>  <span class="p">},</span>
    <span class="p">{</span> <span class="n">basl_fwrite_hpet</span><span class="p">,</span> <span class="n">HPET_OFFSET</span><span class="p">,</span> <span class="nb">true</span>  <span class="p">},</span>
    <span class="p">{</span> <span class="n">basl_fwrite_mcfg</span><span class="p">,</span> <span class="n">MCFG_OFFSET</span><span class="p">,</span> <span class="nb">true</span>  <span class="p">},</span>
    <span class="p">{</span> <span class="n">basl_fwrite_facs</span><span class="p">,</span> <span class="n">FACS_OFFSET</span><span class="p">,</span> <span class="nb">true</span>  <span class="p">},</span>
    <span class="p">{</span> <span class="n">basl_fwrite_nhlt</span><span class="p">,</span> <span class="n">NHLT_OFFSET</span><span class="p">,</span> <span class="nb">false</span> <span class="p">},</span> <span class="cm">/*valid with audio ptdev*/</span>
    <span class="p">{</span> <span class="n">basl_fwrite_dsdt</span><span class="p">,</span> <span class="n">DSDT_OFFSET</span><span class="p">,</span> <span class="nb">true</span>  <span class="p">}</span>
<span class="p">};</span>
</pre></div>
</div>
<p>The main function to create virtual ACPI tables is <code class="docutils literal notranslate"><span class="pre">acpi_build</span></code> that
calls <code class="docutils literal notranslate"><span class="pre">basl_compile</span></code> for each table and performs the following:</p>
<ol class="arabic simple">
<li>create two temp files: infile and outfile</li>
<li>with output handler, write table contents stream to infile</li>
<li>use <code class="docutils literal notranslate"><span class="pre">iasl</span></code> tool to assemble infile into outfile</li>
<li>load outfile contents to the required memory offset</li>
</ol>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">static</span> <span class="kt">int</span>
<span class="nf">basl_compile</span><span class="p">(</span><span class="k">struct</span> <span class="n">vmctx</span> <span class="o">*</span><span class="n">ctx</span><span class="p">,</span>
        <span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">fwrite_section</span><span class="p">)(</span><span class="kt">FILE</span> <span class="o">*</span><span class="p">,</span> <span class="k">struct</span> <span class="n">vmctx</span> <span class="o">*</span><span class="p">),</span>
        <span class="kt">uint64_t</span> <span class="n">offset</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">struct</span> <span class="n">basl_fio</span> <span class="n">io</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
    <span class="k">static</span> <span class="kt">char</span> <span class="n">iaslbuf</span><span class="p">[</span><span class="mi">3</span><span class="o">*</span><span class="n">MAXPATHLEN</span> <span class="o">+</span> <span class="mi">10</span><span class="p">];</span>
    <span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

    <span class="n">err</span> <span class="o">=</span> <span class="n">basl_start</span><span class="p">(</span><span class="o">&amp;</span><span class="n">io</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">io</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">err</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">fwrite_section</span><span class="p">)(</span><span class="n">io</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">fp</span><span class="p">,</span> <span class="n">ctx</span><span class="p">);</span>

        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
            <span class="cm">/*</span>
<span class="cm">             * iasl sends the results of the compilation to</span>
<span class="cm">             * stdout. Shut this down by using the shell to</span>
<span class="cm">             * redirect stdout to /dev/null, unless the user</span>
<span class="cm">             * has requested verbose output for debugging</span>
<span class="cm">             * purposes</span>
<span class="cm">             */</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">basl_verbose_iasl</span><span class="p">)</span>
                <span class="n">snprintf</span><span class="p">(</span><span class="n">iaslbuf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">iaslbuf</span><span class="p">),</span>
                     <span class="s">&quot;%s -p %s %s&quot;</span><span class="p">,</span>
                     <span class="n">ASL_COMPILER</span><span class="p">,</span>
                     <span class="n">io</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">f_name</span><span class="p">,</span> <span class="n">io</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">f_name</span><span class="p">);</span>
            <span class="k">else</span>
                <span class="n">snprintf</span><span class="p">(</span><span class="n">iaslbuf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">iaslbuf</span><span class="p">),</span>
                     <span class="s">&quot;/bin/sh -c </span><span class="se">\&quot;</span><span class="s">%s -p %s %s</span><span class="se">\&quot;</span><span class="s"> 1&gt; /dev/null&quot;</span><span class="p">,</span>
                     <span class="n">ASL_COMPILER</span><span class="p">,</span>
                     <span class="n">io</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">f_name</span><span class="p">,</span> <span class="n">io</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">f_name</span><span class="p">);</span>

            <span class="n">err</span> <span class="o">=</span> <span class="n">system</span><span class="p">(</span><span class="n">iaslbuf</span><span class="p">);</span>

            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
                <span class="cm">/*</span>
<span class="cm">                 * Copy the aml output file into guest</span>
<span class="cm">                 * memory at the specified location</span>
<span class="cm">                 */</span>
                <span class="n">err</span> <span class="o">=</span> <span class="n">basl_load</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">io</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">fd</span><span class="p">,</span> <span class="n">offset</span><span class="p">);</span>
            <span class="p">}</span> <span class="k">else</span>
                <span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">basl_end</span><span class="p">(</span><span class="o">&amp;</span><span class="n">io</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">io</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
    <span class="p">}</span>
</pre></div>
</div>
<p>After processing each entry, the virtual ACPI tables are present in UOS
memory.</p>
<p>For pass-through devices in UOS, we likely need to add some ACPI
description in the UOS virtual DSDT table. There is one hook
(<code class="docutils literal notranslate"><span class="pre">passthrough_write_dsdt</span></code>) in <code class="docutils literal notranslate"><span class="pre">hw/pci/passthrough.c</span></code> for it. The following
source code shows calls to different functions to add different contents
for each vendor and device id.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">static</span> <span class="kt">void</span>
<span class="nf">passthru_write_dsdt</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_vdev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">struct</span> <span class="n">passthru_dev</span> <span class="o">*</span><span class="n">ptdev</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">passthru_dev</span> <span class="o">*</span><span class="p">)</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">arg</span><span class="p">;</span>
    <span class="kt">uint32_t</span> <span class="n">vendor</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">device</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="n">vendor</span> <span class="o">=</span> <span class="n">read_config</span><span class="p">(</span><span class="n">ptdev</span><span class="o">-&gt;</span><span class="n">phys_dev</span><span class="p">,</span> <span class="n">PCIR_VENDOR</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">vendor</span> <span class="o">!=</span> <span class="mh">0x8086</span><span class="p">)</span>
        <span class="k">return</span><span class="p">;</span>

    <span class="n">device</span> <span class="o">=</span> <span class="n">read_config</span><span class="p">(</span><span class="n">ptdev</span><span class="o">-&gt;</span><span class="n">phys_dev</span><span class="p">,</span> <span class="n">PCIR_DEVICE</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>

    <span class="cm">/* Provides ACPI extra info */</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">device</span> <span class="o">==</span> <span class="mh">0x5aaa</span><span class="p">)</span>
        <span class="cm">/* XDCI @ 00:15.1 to enable ADB */</span>
        <span class="n">write_dsdt_xhci</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">device</span> <span class="o">==</span> <span class="mh">0x5ab4</span><span class="p">)</span>
        <span class="cm">/* HDAC @ 00:17.0 as codec */</span>
        <span class="n">write_dsdt_hdac</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">device</span> <span class="o">==</span> <span class="mh">0x5a98</span><span class="p">)</span>
        <span class="cm">/* HDAS @ 00:e.0 */</span>
        <span class="n">write_dsdt_hdas</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">device</span> <span class="o">==</span> <span class="mh">0x5aac</span><span class="p">)</span>
        <span class="cm">/* i2c @ 00:16.0 for ipu */</span>
        <span class="n">write_dsdt_ipu_i2c</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">device</span> <span class="o">==</span> <span class="mh">0x5abc</span><span class="p">)</span>
        <span class="cm">/* URT1 @ 00:18.0 for bluetooth*/</span>
        <span class="n">write_dsdt_urt1</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

<span class="p">}</span>
</pre></div>
</div>
<p>For instance, <code class="docutils literal notranslate"><span class="pre">write_dsdt_urt1</span></code> provides ACPI contents for Bluetooth
UART device when pass-throughed to the UOS. It provides virtual PCI
device/function as <code class="docutils literal notranslate"><span class="pre">_ADR</span></code>, with other descriptions possible for Bluetooth
UART enumeration.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">static</span> <span class="kt">void</span>
<span class="nf">write_dsdt_urt1</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_vdev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&quot;write virt-%x:%x.%x in dsdt for URT1 @ 00:18.0</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
           <span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">,</span>
           <span class="n">dev</span><span class="o">-&gt;</span><span class="n">slot</span><span class="p">,</span>
           <span class="n">dev</span><span class="o">-&gt;</span><span class="n">func</span><span class="p">);</span>
    <span class="n">dsdt_line</span><span class="p">(</span><span class="s">&quot;Device (URT1)&quot;</span><span class="p">);</span>
    <span class="n">dsdt_line</span><span class="p">(</span><span class="s">&quot;{&quot;</span><span class="p">);</span>
    <span class="n">dsdt_line</span><span class="p">(</span><span class="s">&quot;    Name (_ADR, 0x%04X%04X)&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">slot</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">func</span><span class="p">);</span>
    <span class="n">dsdt_line</span><span class="p">(</span><span class="s">&quot;    Name (_DDN, </span><span class="se">\&quot;</span><span class="s">Intel(R) HS-UART Controller #1</span><span class="se">\&quot;</span><span class="s">)&quot;</span><span class="p">);</span>
    <span class="n">dsdt_line</span><span class="p">(</span><span class="s">&quot;    Name (_UID, One)&quot;</span><span class="p">);</span>
    <span class="n">dsdt_line</span><span class="p">(</span><span class="s">&quot;    Name (RBUF, ResourceTemplate ()&quot;</span><span class="p">);</span>
    <span class="n">dsdt_line</span><span class="p">(</span><span class="s">&quot;    {&quot;</span><span class="p">);</span>
    <span class="n">dsdt_line</span><span class="p">(</span><span class="s">&quot;    })&quot;</span><span class="p">);</span>
    <span class="n">dsdt_line</span><span class="p">(</span><span class="s">&quot;    Method (_CRS, 0, NotSerialized)&quot;</span><span class="p">);</span>
    <span class="n">dsdt_line</span><span class="p">(</span><span class="s">&quot;    {&quot;</span><span class="p">);</span>
    <span class="n">dsdt_line</span><span class="p">(</span><span class="s">&quot;        Return (RBUF)&quot;</span><span class="p">);</span>
    <span class="n">dsdt_line</span><span class="p">(</span><span class="s">&quot;    }&quot;</span><span class="p">);</span>
    <span class="n">dsdt_line</span><span class="p">(</span><span class="s">&quot;}&quot;</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>This document introduces basic ACPI virtualization. Other topics such as
power management virtualization, adds more requirement for ACPI, and
will be discussed in the power management documentation.</p>
</div>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2018, Project ACRN.
      Last updated on Aug 08, 2018.

    </p>
  </div> 

</footer>

        </div>
      </div>

    </section>

  </div>
  
  <div class="rst-versions" data-toggle="rst-versions" role="note" aria-label="versions">
    <span class="rst-current-version" data-toggle="rst-current-version">
      <span class="fa fa-book"> Project ACRN</span>
      v: latest
      <span class="fa fa-caret-down"></span>
    </span>
    <div class="rst-other-versions">
      <dl>
        <dt>Versions</dt>
        
          <dd><a href="/latest/">latest</a></dd>
        
          <dd><a href="/0.1/">0.1</a></dd>
        
      </dl>
      <dl>
        <dt>On projectacrn.org</dt>
          <dd>
            <a href="https://www.projectacrn.org/">Project Home</a>
          </dd>
          <dd>
            <a href="https://github.com/projectacrn/acrn-hypervisor/wiki">Wiki</a>
          </dd>
      </dl>
    </div>
  </div>

  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../',
            VERSION:'v 0.2-unstable',
            LANGUAGE:'None',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="../_static/jquery.js"></script>
      <script type="text/javascript" src="../_static/underscore.js"></script>
      <script type="text/javascript" src="../_static/doctools.js"></script>
      <script type="text/javascript" src="../_static/acrn-custom.js"></script>

  

  <script type="text/javascript" src="../_static/js/theme.js"></script>

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>