

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Memory Management high-level design &mdash; Project ACRN™ v 0.5-unstable documentation</title>
  

  
  
    <link rel="shortcut icon" href="../../_static/ACRN-favicon-32x32.png"/>
  
  
  

  

  
  
    

  

  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/acrn-custom.css" type="text/css" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="I/O Emulation high-level design" href="hv-io-emulation.html" />
    <link rel="prev" title="CPU Virtualization" href="hv-cpu-virt.html" /> 

  
  <script src="../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../../index.html" class="icon icon-home"> Project ACRN™
          

          
            
            <img src="../../_static/ACRN_Logo_200w.png" class="logo" alt="Logo"/>
          
          </a>

          
            
            
              <div class="version">
                latest
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../introduction/index.html">Introduction to Project ACRN</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../introduction/index.html#automotive-use-case-example">Automotive Use Case Example</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../introduction/index.html#licensing">Licensing</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../introduction/index.html#acrn-device-model-service-os-and-user-os">ACRN Device Model, Service OS, and User OS</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../introduction/index.html#boot-sequence">Boot Sequence</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../introduction/index.html#acrn-hypervisor-architecture">ACRN Hypervisor Architecture</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../introduction/index.html#acrn-device-model-architecture">ACRN Device Model Architecture</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../introduction/index.html#device-pass-through">Device pass through</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../introduction/index.html#hardware-support-for-device-passthrough">Hardware support for device passthrough</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../introduction/index.html#hypervisor-support-for-device-passthrough">Hypervisor support for device passthrough</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../introduction/index.html#acrn-i-o-mediator">ACRN I/O mediator</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../introduction/index.html#virtio-framework-architecture">Virtio framework architecture</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../getting-started/index.html">Getting Started Guides</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../getting-started/apl-nuc.html">Getting started guide for Intel NUC</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../getting-started/apl-nuc.html#hardware-setup">Hardware setup</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../getting-started/apl-nuc.html#firmware-update-on-the-nuc">Firmware update on the NUC</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../getting-started/apl-nuc.html#software-setup">Software setup</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../getting-started/apl-nuc.html#set-up-a-clear-linux-operating-system">Set up a Clear Linux Operating System</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../getting-started/apl-nuc.html#add-the-acrn-hypervisor-to-the-efi-partition">Add the ACRN hypervisor to the EFI Partition</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../getting-started/apl-nuc.html#acrn-network-bridge">ACRN Network Bridge</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../getting-started/apl-nuc.html#set-up-reference-uos">Set up Reference UOS</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../getting-started/apl-nuc.html#build-acrn-from-source">Build ACRN from Source</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../getting-started/apl-nuc.html#install-build-tools-and-dependencies">Install build tools and dependencies</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../getting-started/apl-nuc.html#build-the-hypervisor-device-model-and-tools">Build the hypervisor, device model and tools</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../getting-started/apl-nuc.html#generate-the-hypervisor-configurations">Generate the hypervisor configurations</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../getting-started/apl-nuc.html#modify-the-hypervisor-configurations">Modify the hypervisor configurations</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../getting-started/apl-nuc.html#create-a-new-default-configuration">Create a new default configuration</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../getting-started/up2.html">Getting started guide for UP2 board</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../getting-started/up2.html#hardware-setup">Hardware setup</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../getting-started/up2.html#connecting-to-the-serial-port">Connecting to the serial port</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../getting-started/up2.html#software-setup">Software setup</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../getting-started/up2.html#up2-serial-port-setting">UP2 serial port setting</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../getting-started/up2.html#up2-block-device">UP2 block device</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../getting-started/up2.html#running-the-hypervisor">Running the hypervisor</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../hardware.html">Supported Hardware</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../hardware.html#intel-apollo-lake-nuc">Intel Apollo Lake NUC</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../hardware.html#up-squared-board">UP Squared board</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../user-guides/index.html">User Guides</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../user-guides/acrn-dm-parameters.html">Device Model Parameters</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../user-guides/acrn-shell.html">ACRN Shell Commands</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../user-guides/tools.html">Tools</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../tools/README.html">ACRN tools</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../tools/acrn-crashlog/README.html">ACRN-Crashlog</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../tools/acrn-crashlog/README.html#introduction">Introduction</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../tools/acrn-crashlog/README.html#building">Building</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../tools/acrn-crashlog/README.html#installing">Installing</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../tools/acrn-crashlog/README.html#enabling-disabling">Enabling/Disabling</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../tools/acrn-crashlog/README.html#usage">Usage</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../tools/acrn-crashlog/README.html#source-code">Source Code</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../tools/acrn-crashlog/acrnprobe/README.html">acrnprobe</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../tools/acrn-crashlog/acrnprobe/README.html#description">Description</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../tools/acrn-crashlog/acrnprobe/README.html#usage">Usage</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../tools/acrn-crashlog/acrnprobe/README.html#architecture">Architecture</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../tools/acrn-crashlog/acrnprobe/README.html#source-files">Source files</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../tools/acrn-crashlog/acrnprobe/README.html#configuration-files">Configuration files</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../tools/acrn-crashlog/acrnprobe/conf.html">acrnprobe Configuration</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../tools/acrn-crashlog/acrnprobe/conf.html#description">Description</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../tools/acrn-crashlog/acrnprobe/conf.html#layout">Layout</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../tools/acrn-crashlog/acrnprobe/conf.html#properties-of-group-members">Properties of group members</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../tools/acrn-crashlog/acrnprobe/conf.html#crash-tree-in-acrnprobe">Crash tree in acrnprobe</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../tools/acrn-crashlog/acrnprobe/conf.html#sections">Sections</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../tools/acrn-crashlog/usercrash/README.html">usercrash</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../tools/acrn-crashlog/usercrash/README.html#description">Description</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../tools/acrn-crashlog/usercrash/README.html#design">Design</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../tools/acrn-crashlog/usercrash/README.html#usage">Usage</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../tools/acrn-crashlog/usercrash/README.html#souce-code">Souce Code</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../tools/acrn-manager/README.html">acrnctl and acrnd</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../tools/acrn-manager/README.html#description">Description</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../tools/acrn-manager/README.html#usage">Usage</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../tools/acrn-manager/README.html#acrnd">acrnd</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../tools/acrn-manager/README.html#build-and-install">Build and Install</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../tools/acrnlog/README.html">acrnlog</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../tools/acrnlog/README.html#description">Description</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../tools/acrnlog/README.html#usage">Usage</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../tools/acrnlog/README.html#build-and-install">Build and Install</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../tools/acrntrace/README.html">acrntrace</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../tools/acrntrace/README.html#description">Description</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../tools/acrntrace/README.html#usage">Usage</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../tools/acrntrace/README.html#build-and-install">Build and Install</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1 current"><a class="reference internal" href="../index.html">Developer Guides</a><ul class="current">
<li class="toctree-l2 current"><a class="reference internal" href="index.html">High-Level Design Guides</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="hld-overview.html">Overview</a><ul>
<li class="toctree-l4"><a class="reference internal" href="hld-overview.html#acrn-supported-use-cases">ACRN Supported Use Cases</a></li>
<li class="toctree-l4"><a class="reference internal" href="hld-overview.html#hardware-requirements">Hardware Requirements</a></li>
<li class="toctree-l4"><a class="reference internal" href="hld-overview.html#acrn-architecture">ACRN Architecture</a></li>
<li class="toctree-l4"><a class="reference internal" href="hld-overview.html#hypervisor">Hypervisor</a></li>
<li class="toctree-l4"><a class="reference internal" href="hld-overview.html#sos">SOS</a></li>
<li class="toctree-l4"><a class="reference internal" href="hld-overview.html#uos">UOS</a></li>
<li class="toctree-l4"><a class="reference internal" href="hld-overview.html#freedom-from-interference">Freedom From Interference</a></li>
<li class="toctree-l4"><a class="reference internal" href="hld-overview.html#boot-flow">Boot Flow</a></li>
<li class="toctree-l4"><a class="reference internal" href="hld-overview.html#power-management">Power Management</a></li>
</ul>
</li>
<li class="toctree-l3 current"><a class="reference internal" href="hld-hypervisor.html">Hypervisor</a><ul class="current">
<li class="toctree-l4"><a class="reference internal" href="hv-startup.html">Hypervisor Startup</a></li>
<li class="toctree-l4"><a class="reference internal" href="hv-cpu-virt.html">CPU Virtualization</a></li>
<li class="toctree-l4 current"><a class="current reference internal" href="#">Memory management</a></li>
<li class="toctree-l4"><a class="reference internal" href="hv-io-emulation.html">I/O Emulation</a></li>
<li class="toctree-l4"><a class="reference internal" href="hv-interrupt.html">Physical Interrupt</a></li>
<li class="toctree-l4"><a class="reference internal" href="hv-timer.html">Timer</a></li>
<li class="toctree-l4"><a class="reference internal" href="hv-virt-interrupt.html">Virtual Interrupt</a></li>
<li class="toctree-l4"><a class="reference internal" href="hv-vt-d.html">VT-d</a></li>
<li class="toctree-l4"><a class="reference internal" href="hv-dev-passthrough.html">Device Passthrough</a></li>
<li class="toctree-l4"><a class="reference internal" href="hv-partitionmode.html">Partition mode</a></li>
<li class="toctree-l4"><a class="reference internal" href="hv-pm.html">Power Management</a></li>
<li class="toctree-l4"><a class="reference internal" href="hv-console.html">Console, Shell, and vUART</a></li>
<li class="toctree-l4"><a class="reference internal" href="hv-hypercall.html">Hypercall / VHM upcall</a></li>
<li class="toctree-l4"><a class="reference internal" href="hv-config.html">Compile-time configuration</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="hld-devicemodel.html">Device Model</a><ul>
<li class="toctree-l4"><a class="reference internal" href="hld-devicemodel.html#configuration">Configuration</a></li>
<li class="toctree-l4"><a class="reference internal" href="hld-devicemodel.html#dm-initialization">DM Initialization</a></li>
<li class="toctree-l4"><a class="reference internal" href="hld-devicemodel.html#vhm">VHM</a></li>
<li class="toctree-l4"><a class="reference internal" href="hld-devicemodel.html#i-o-emulation-in-sos">I/O Emulation in SOS</a></li>
<li class="toctree-l4"><a class="reference internal" href="hld-devicemodel.html#device-emulation">Device Emulation</a></li>
<li class="toctree-l4"><a class="reference internal" href="hld-devicemodel.html#isa-and-pci-emulation">ISA and PCI Emulation</a></li>
<li class="toctree-l4"><a class="reference internal" href="hld-devicemodel.html#acpi-virtualization">ACPI Virtualization</a></li>
<li class="toctree-l4"><a class="reference internal" href="hld-devicemodel.html#pm-in-device-model">PM in Device Model</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="hld-emulated-devices.html">Emulated Devices</a><ul>
<li class="toctree-l4"><a class="reference internal" href="usb-virt-hld.html">USB Virtualization</a></li>
<li class="toctree-l4"><a class="reference internal" href="uart-virt-hld.html">UART virtualization</a></li>
<li class="toctree-l4"><a class="reference internal" href="watchdog-hld.html">Watchdoc virtualization</a></li>
<li class="toctree-l4"><a class="reference internal" href="random-virt-hld.html">Random device virtualization</a></li>
<li class="toctree-l4"><a class="reference internal" href="hld-APL_GVT-g.html">GVT-g GPU Virtualization</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="hld-virtio-devices.html">Virtio Devices</a><ul>
<li class="toctree-l4"><a class="reference internal" href="hld-virtio-devices.html#virtio-introduction">Virtio introduction</a></li>
<li class="toctree-l4"><a class="reference internal" href="hld-virtio-devices.html#key-concepts">Key Concepts</a></li>
<li class="toctree-l4"><a class="reference internal" href="hld-virtio-devices.html#virtio-frameworks">Virtio Frameworks</a></li>
<li class="toctree-l4"><a class="reference internal" href="hld-virtio-devices.html#virtio-apis">Virtio APIs</a></li>
<li class="toctree-l4"><a class="reference internal" href="hld-virtio-devices.html#supported-virtio-devices">Supported Virtio Devices</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="hld-vm-management.html">VM Management</a><ul>
<li class="toctree-l4"><a class="reference internal" href="hld-vm-management.html#vm-state">VM state</a></li>
<li class="toctree-l4"><a class="reference internal" href="hld-vm-management.html#scenarios-of-vm-state-change">Scenarios of VM state change</a></li>
<li class="toctree-l4"><a class="reference internal" href="hld-vm-management.html#vm-state-management">VM State management</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="hld-power-management.html">Power Management</a><ul>
<li class="toctree-l4"><a class="reference internal" href="hld-power-management.html#p-state-c-state-management">P-state/C-state management</a></li>
<li class="toctree-l4"><a class="reference internal" href="hld-power-management.html#s3-s5">S3/S5</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="hld-trace-log.html">Tracing and Logging</a><ul>
<li class="toctree-l4"><a class="reference internal" href="hld-trace-log.html#shared-buffer">Shared Buffer</a></li>
<li class="toctree-l4"><a class="reference internal" href="hld-trace-log.html#acrn-trace">ACRN Trace</a></li>
<li class="toctree-l4"><a class="reference internal" href="hld-trace-log.html#acrn-log">ACRN Log</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="hld-vsbl.html">Virtual Bootloader</a></li>
<li class="toctree-l3"><a class="reference internal" href="hld-security.html">Security</a><ul>
<li class="toctree-l4"><a class="reference internal" href="hld-security.html#introduction">Introduction</a></li>
<li class="toctree-l4"><a class="reference internal" href="hld-security.html#background">Background</a></li>
<li class="toctree-l4"><a class="reference internal" href="hld-security.html#acrn-high-level-security-architecture">ACRN High-Level Security Architecture</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../primer.html">Developer Primer</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../primer.html#source-tree-structure">Source Tree Structure</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../primer.html#acrn-hypervisor-source-tree">ACRN hypervisor source tree</a></li>
<li class="toctree-l4"><a class="reference internal" href="../primer.html#acrn-device-model-source-tree">ACRN Device Model source tree</a></li>
<li class="toctree-l4"><a class="reference internal" href="../primer.html#acrn-tools-source-tree">ACRN Tools source tree</a></li>
<li class="toctree-l4"><a class="reference internal" href="../primer.html#acrn-documentation-source-tree">ACRN documentation source tree</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../primer.html#cpu-virtualization">CPU virtualization</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../primer.html#host-gdt">Host GDT</a></li>
<li class="toctree-l4"><a class="reference internal" href="../primer.html#host-idt">Host IDT</a></li>
<li class="toctree-l4"><a class="reference internal" href="../primer.html#guest-smp-booting">Guest SMP Booting</a></li>
<li class="toctree-l4"><a class="reference internal" href="../primer.html#vmx-configuration">VMX configuration</a></li>
<li class="toctree-l4"><a class="reference internal" href="../primer.html#cpuid-and-guest-tsc-calibration">CPUID and Guest TSC calibration</a></li>
<li class="toctree-l4"><a class="reference internal" href="../primer.html#rdtsc-rdtscp">RDTSC/RDTSCP</a></li>
<li class="toctree-l4"><a class="reference internal" href="../primer.html#cr-register-virtualization">CR Register virtualization</a></li>
<li class="toctree-l4"><a class="reference internal" href="../primer.html#msr-bitmap">MSR BITMAP</a></li>
<li class="toctree-l4"><a class="reference internal" href="../primer.html#i-o-bitmap">I/O BITMAP</a></li>
<li class="toctree-l4"><a class="reference internal" href="../primer.html#exceptions">Exceptions</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../primer.html#memory-virtualization">Memory virtualization</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../primer.html#physical-memory-layout">Physical Memory Layout</a></li>
<li class="toctree-l4"><a class="reference internal" href="../primer.html#pv-mmu-memory-mapping-in-the-hypervisor">PV (MMU) Memory Mapping in the Hypervisor</a></li>
<li class="toctree-l4"><a class="reference internal" href="../primer.html#pv-mmu-memory-mapping-in-vms">PV (MMU) Memory Mapping in VMs</a></li>
<li class="toctree-l4"><a class="reference internal" href="../primer.html#host-guest-ept-memory-mapping">Host-Guest (EPT) Memory Mapping</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../primer.html#graphic-mediation">Graphic mediation</a></li>
<li class="toctree-l3"><a class="reference internal" href="../primer.html#i-o-emulation">I/O emulation</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../primer.html#device-assignment-management">Device Assignment Management</a></li>
<li class="toctree-l4"><a class="reference internal" href="../primer.html#pio-mmio-trap-flow">PIO/MMIO trap Flow</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../primer.html#virtual-interrupt">Virtual interrupt</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../primer.html#virtual-lapic">Virtual LAPIC</a></li>
<li class="toctree-l4"><a class="reference internal" href="../primer.html#virtual-ioapic">Virtual IOAPIC</a></li>
<li class="toctree-l4"><a class="reference internal" href="../primer.html#virtual-pic">Virtual PIC</a></li>
<li class="toctree-l4"><a class="reference internal" href="../primer.html#virtual-interrupt-injection">Virtual Interrupt Injection</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../primer.html#vt-x-and-vt-d">VT-x and VT-d</a></li>
<li class="toctree-l3"><a class="reference internal" href="../primer.html#hypercall">Hypercall</a></li>
<li class="toctree-l3"><a class="reference internal" href="../primer.html#device-emulation">Device emulation</a></li>
<li class="toctree-l3"><a class="reference internal" href="../primer.html#virtio-devices">Virtio Devices</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../primer.html#virtio-rnd">Virtio-rnd</a></li>
<li class="toctree-l4"><a class="reference internal" href="../primer.html#virtio-blk">Virtio-blk</a></li>
<li class="toctree-l4"><a class="reference internal" href="../primer.html#virtio-net">Virtio-net</a></li>
<li class="toctree-l4"><a class="reference internal" href="../primer.html#virtio-console">Virtio-console</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../GVT-g-porting.html">GVT-g Enabling and Porting Guide</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../GVT-g-porting.html#introduction">Introduction</a></li>
<li class="toctree-l3"><a class="reference internal" href="../GVT-g-porting.html#purpose-of-this-document">Purpose of this document</a></li>
<li class="toctree-l3"><a class="reference internal" href="../GVT-g-porting.html#overall-components">Overall Components</a></li>
<li class="toctree-l3"><a class="reference internal" href="../GVT-g-porting.html#core-scenario-interaction-sequences">Core scenario interaction sequences</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../GVT-g-porting.html#vgpu-creation-scenario">vGPU creation scenario</a></li>
<li class="toctree-l4"><a class="reference internal" href="../GVT-g-porting.html#vgpu-destroy-scenario">vGPU destroy scenario</a></li>
<li class="toctree-l4"><a class="reference internal" href="../GVT-g-porting.html#vgpu-pci-configure-space-write-scenario">vGPU pci configure space write scenario</a></li>
<li class="toctree-l4"><a class="reference internal" href="../GVT-g-porting.html#pci-configure-space-read-scenario">pci configure space read scenario</a></li>
<li class="toctree-l4"><a class="reference internal" href="../GVT-g-porting.html#ggtt-read-write-scenario">GGTT read/write scenario</a></li>
<li class="toctree-l4"><a class="reference internal" href="../GVT-g-porting.html#mmio-read-write-scenario">MMIO read/write scenario</a></li>
<li class="toctree-l4"><a class="reference internal" href="../GVT-g-porting.html#ppgtt-write-protection-page-set-unset-scenario">PPGTT write protection page set/unset scenario</a></li>
<li class="toctree-l4"><a class="reference internal" href="../GVT-g-porting.html#ppgtt-write-protection-page-write">PPGTT write protection page write</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../GVT-g-porting.html#api-details">API details</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../trusty.html">Trusty TEE</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../trusty.html#introduction">Introduction</a></li>
<li class="toctree-l3"><a class="reference internal" href="../trusty.html#trusty-architecture">Trusty Architecture</a></li>
<li class="toctree-l3"><a class="reference internal" href="../trusty.html#trusty-specific-hypercalls">Trusty specific Hypercalls</a></li>
<li class="toctree-l3"><a class="reference internal" href="../trusty.html#trusty-boot-flow">Trusty Boot flow</a></li>
<li class="toctree-l3"><a class="reference internal" href="../trusty.html#ept-hierarchy">EPT Hierarchy</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../trusty.html#design">Design</a></li>
<li class="toctree-l4"><a class="reference internal" href="../trusty.html#benefit">Benefit</a></li>
<li class="toctree-l4"><a class="reference internal" href="../trusty.html#api">API</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../l1tf.html">L1 Terminal Fault Mitigation</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../l1tf.html#overview">Overview</a></li>
<li class="toctree-l3"><a class="reference internal" href="../l1tf.html#l1tf-problem-in-acrn">L1TF Problem in ACRN</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../l1tf.html#guest-hypervisor-attack">Guest -&gt; hypervisor Attack</a></li>
<li class="toctree-l4"><a class="reference internal" href="../l1tf.html#guest-guest-attack">Guest -&gt; guest Attack</a></li>
<li class="toctree-l4"><a class="reference internal" href="../l1tf.html#normal-world-secure-world-attack">Normal_world -&gt; Secure_world Attack</a></li>
<li class="toctree-l4"><a class="reference internal" href="../l1tf.html#affected-processors">Affected Processors</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../l1tf.html#l1tf-mitigation-in-acrn">L1TF Mitigation in ACRN</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../l1tf.html#l1d-flush-on-vmentry">L1D flush on VMENTRY</a></li>
<li class="toctree-l4"><a class="reference internal" href="../l1tf.html#ept-sanitization">EPT Sanitization</a></li>
<li class="toctree-l4"><a class="reference internal" href="../l1tf.html#put-secret-data-into-uncached-memory">Put Secret Data into Uncached Memory</a></li>
<li class="toctree-l4"><a class="reference internal" href="../l1tf.html#l1d-flush-on-world-switch">L1D flush on World Switch</a></li>
<li class="toctree-l4"><a class="reference internal" href="../l1tf.html#core-based-scheduling">Core-based scheduling</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../l1tf.html#mitigation-recommendations">Mitigation Recommendations</a></li>
<li class="toctree-l3"><a class="reference internal" href="../l1tf.html#mitigation-status">Mitigation Status</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../modularity.html">ACRN Hypervisor: Modular Design</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../modularity.html#overview">Overview</a></li>
<li class="toctree-l3"><a class="reference internal" href="../modularity.html#principles">Principles</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../modularity.html#minimizing-cyclic-dependencies">Minimizing Cyclic Dependencies</a></li>
<li class="toctree-l4"><a class="reference internal" href="../modularity.html#measuring-complexity">Measuring Complexity</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../modularity.html#architecture">Architecture</a></li>
<li class="toctree-l3"><a class="reference internal" href="../modularity.html#references">References</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../api/index.html">API Documentation</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../api/hypercall_api.html">Hypercall APIs</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/devicemodel_api.html">Device Model APIs</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/GVT-g_api.html">ACRN GVT-g APIs</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../api/GVT-g_api.html#core-driver-infrastructure">Core Driver Infrastructure</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/GVT-g_api.html#vhm-apis-called-from-acrngt">VHM APIs called from AcrnGT</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/GVT-g_api.html#acrngt-mediated-pass-through-mpt-interface">AcrnGT mediated pass-through (MPT) interface</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/GVT-g_api.html#gvt-g-intel-gvt-ops-interface">GVT-g intel_gvt_ops interface</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/GVT-g_api.html#acrngt-sysfs-interface">AcrnGT sysfs interface</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../reference/kconfig/index.html">Configuration Symbol Reference</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../reference/kconfig/index.html#introduction">Introduction</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../reference/kconfig/index.html#supported-options">Supported Options</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../index.html#contributing-to-the-project">Contributing to the project</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../contribute_guidelines.html">Contribution Guidelines</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../contribute_guidelines.html#licensing">Licensing</a></li>
<li class="toctree-l4"><a class="reference internal" href="../contribute_guidelines.html#developer-certification-of-origin-dco">Developer Certification of Origin (DCO)</a></li>
<li class="toctree-l4"><a class="reference internal" href="../contribute_guidelines.html#prerequisites">Prerequisites</a></li>
<li class="toctree-l4"><a class="reference internal" href="../contribute_guidelines.html#repository-layout">Repository layout</a></li>
<li class="toctree-l4"><a class="reference internal" href="../contribute_guidelines.html#submitting-issues">Submitting Issues</a></li>
<li class="toctree-l4"><a class="reference internal" href="../contribute_guidelines.html#contribution-tools-and-git-setup">Contribution Tools and Git Setup</a></li>
<li class="toctree-l4"><a class="reference internal" href="../contribute_guidelines.html#coding-style">Coding Style</a></li>
<li class="toctree-l4"><a class="reference internal" href="../contribute_guidelines.html#contribution-workflow">Contribution Workflow</a></li>
<li class="toctree-l4"><a class="reference internal" href="../contribute_guidelines.html#commit-guidelines">Commit Guidelines</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../doc_guidelines.html">Documentation Guidelines</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../doc_guidelines.html#headings">Headings</a></li>
<li class="toctree-l4"><a class="reference internal" href="../doc_guidelines.html#content-highlighting">Content Highlighting</a></li>
<li class="toctree-l4"><a class="reference internal" href="../doc_guidelines.html#lists">Lists</a></li>
<li class="toctree-l4"><a class="reference internal" href="../doc_guidelines.html#multi-column-lists">Multi-column lists</a></li>
<li class="toctree-l4"><a class="reference internal" href="../doc_guidelines.html#file-names-and-commands">File names and Commands</a></li>
<li class="toctree-l4"><a class="reference internal" href="../doc_guidelines.html#internal-cross-reference-linking">Internal Cross-Reference Linking</a></li>
<li class="toctree-l4"><a class="reference internal" href="../doc_guidelines.html#non-ascii-characters">Non-ASCII Characters</a></li>
<li class="toctree-l4"><a class="reference internal" href="../doc_guidelines.html#code-and-command-examples">Code and Command Examples</a></li>
<li class="toctree-l4"><a class="reference internal" href="../doc_guidelines.html#tabs-spaces-and-indenting">Tabs, spaces, and indenting</a></li>
<li class="toctree-l4"><a class="reference internal" href="../doc_guidelines.html#drawings">Drawings</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../graphviz.html">Drawings using graphviz</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../graphviz.html#simple-directed-graph">Simple directed graph</a></li>
<li class="toctree-l4"><a class="reference internal" href="../graphviz.html#adding-edge-labels">Adding edge labels</a></li>
<li class="toctree-l4"><a class="reference internal" href="../graphviz.html#tables">Tables</a></li>
<li class="toctree-l4"><a class="reference internal" href="../graphviz.html#finite-state-machine">Finite-State Machine</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../tutorials/index.html">Tutorials</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../tutorials/building_uos_from_clearlinux.html">Building UOS from Clear Linux</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../tutorials/building_uos_from_clearlinux.html#build-uos-image-in-clear-linux-native">Build UOS image in Clear Linux native</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../tutorials/building_uos_from_clearlinux.html#start-the-user-os-uos">Start the User OS (UOS)</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../tutorials/docbuild.html">ACRN documentation generation</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../tutorials/docbuild.html#documentation-overview">Documentation overview</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../tutorials/docbuild.html#set-up-the-documentation-working-folders">Set up the documentation working folders</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../tutorials/docbuild.html#installing-the-documentation-tools">Installing the documentation tools</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../tutorials/docbuild.html#documentation-presentation-theme">Documentation presentation theme</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../tutorials/docbuild.html#running-the-documentation-processors">Running the documentation processors</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../tutorials/docbuild.html#publishing-content">Publishing content</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../tutorials/docbuild.html#document-versioning">Document Versioning</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../tutorials/docbuild.html#filtering-expected-warnings">Filtering expected warnings</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../tutorials/static-ip.html">Using a static IP address</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../tutorials/static-ip.html#acrn-network-setup">ACRN Network Setup</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../tutorials/static-ip.html#setting-up-the-static-ip-address">Setting up the static IP address</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../tutorials/static-ip.html#activate-the-new-configuration">Activate the new configuration</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../tutorials/using_agl_as_uos.html">Using AGL as the User OS</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../tutorials/using_agl_as_uos.html#introduction-to-agl">Introduction to AGL</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../tutorials/using_agl_as_uos.html#steps-for-using-agl-as-the-uos">Steps for using AGL as the UOS</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../tutorials/using_agl_as_uos.html#enable-the-agl-display">Enable the AGL display</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../tutorials/using_agl_as_uos.html#follow-up">Follow up</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../tutorials/using_partition_mode_on_up2.html">Using partition mode on UP2</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../tutorials/using_partition_mode_on_up2.html#prerequisites">Prerequisites</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../tutorials/using_partition_mode_on_up2.html#build-kernel-and-modules-for-partition-mode-uos">Build kernel and modules for partition mode UOS</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../tutorials/using_partition_mode_on_up2.html#enable-partition-mode-in-acrn-hypervisor">Enable partition mode in ACRN hypervisor</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../tutorials/using_partition_mode_on_up2.html#switch-between-privileged-vms">Switch between privileged VMs</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../tutorials/using_ubuntu_as_sos.html">Using Ubuntu as the Service OS</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../tutorials/using_ubuntu_as_sos.html#install-ubuntu-natively">Install Ubuntu (natively)</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../tutorials/using_ubuntu_as_sos.html#install-acrn">Install ACRN</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../tutorials/using_ubuntu_as_sos.html#install-the-service-os-kernel">Install the Service OS kernel</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../tutorials/using_ubuntu_as_sos.html#prepare-the-user-os-uos">Prepare the User OS (UOS)</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../tutorials/using_ubuntu_as_sos.html#start-the-user-os-uos">Start the User OS (UOS)</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../tutorials/using_ubuntu_as_sos.html#enabling-network-sharing">Enabling network sharing</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../tutorials/using_ubuntu_as_sos.html#enabling-usb-keyboard-and-mouse">Enabling USB keyboard and mouse</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../release_notes.html">Release Notes</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../release_notes_0.4.html">ACRN v0.4 (Dec 2018)</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../release_notes_0.4.html#version-0-4-new-features">Version 0.4 new features</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../release_notes_0.4.html#fixed-issues">Fixed Issues</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../release_notes_0.4.html#known-issues">Known Issues</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../release_notes_0.4.html#change-log">Change Log</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../release_notes_0.3.html">ACRN v0.3 (Nov 2018)</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../release_notes_0.3.html#version-0-3-new-features">Version 0.3 new features</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../release_notes_0.3.html#fixed-issues">Fixed Issues</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../release_notes_0.3.html#known-issues">Known Issues</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../release_notes_0.3.html#change-log">Change Log</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../release_notes_0.2.html">ACRN v0.2 (Sep 2018)</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../release_notes_0.2.html#version-0-2-new-features">Version 0.2 new features</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../release_notes_0.2.html#vt-x-vt-d">VT-x, VT-d</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../release_notes_0.2.html#pic-ioapic-msi-msi-x-pci-lapic">PIC/IOAPIC/MSI/MSI-X/PCI/LAPIC</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../release_notes_0.2.html#ethernet">Ethernet</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../release_notes_0.2.html#storage-emmc">Storage (eMMC)</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../release_notes_0.2.html#usb-xdci">USB (xDCI)</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../release_notes_0.2.html#usb-mediator-xhci-and-drd">USB Mediator (xHCI and DRD)</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../release_notes_0.2.html#csme">CSME</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../release_notes_0.2.html#wifi">WiFi</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../release_notes_0.2.html#ipu-mipi-cs2-hdmi-in">IPU (MIPI-CS2, HDMI-in)</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../release_notes_0.2.html#bluetooth">Bluetooth</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../release_notes_0.2.html#gpu-preemption">GPU  – Preemption</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../release_notes_0.2.html#gpu-display-surface-sharing-via-hyper-dma">GPU – display surface sharing via Hyper DMA</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../release_notes_0.2.html#s3">S3</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../release_notes_0.2.html#fixed-issues">Fixed Issues</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../release_notes_0.2.html#known-issues">Known Issues</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../release_notes_0.2.html#change-log">Change Log</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../release_notes_0.1.html">ACRN v0.1 (July 2018)</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../release_notes_0.1.html#version-0-1-new-features">Version 0.1 new features</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../release_notes_0.1.html#hardware-support">Hardware Support</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../release_notes_0.1.html#gvt-g-for-acrn">GVT-g for ACRN</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../release_notes_0.1.html#virtio-standard-is-supported">Virtio standard is supported</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../release_notes_0.1.html#device-pass-through-support">Device pass-through support</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../release_notes_0.1.html#hypervisor-configuration">Hypervisor configuration</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../release_notes_0.1.html#new-acrn-tools">New ACRN tools</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../release_notes_0.1.html#known-issues">Known Issues</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../release_notes_0.1.html#change-log">Change Log</a></li>
</ul>
</li>
</ul>
</li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Project ACRN™</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../index.html">Developer Guides</a> &raquo;</li>
        
          <li><a href="index.html">High-Level Design Guides</a> &raquo;</li>
        
          <li><a href="hld-hypervisor.html">Hypervisor high-level design</a> &raquo;</li>
        
      <li>Memory Management high-level design</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="memory-management-high-level-design">
<span id="memmgt-hld"></span><h1>Memory Management high-level design<a class="headerlink" href="#memory-management-high-level-design" title="Permalink to this headline">¶</a></h1>
<p>This document describes memory management for the ACRN hypervisor.</p>
<div class="section" id="overview">
<h2>Overview<a class="headerlink" href="#overview" title="Permalink to this headline">¶</a></h2>
<p>The hypervisor (HV) virtualizes real physical memory so an unmodified OS
(such as Linux or Android) running in a virtual machine, has the view of
managing its own contiguous physical memory.  HV uses virtual-processor
identifiers (VPIDs) and the extended page-table mechanism (EPT) to
translate guest-physical address into host-physical address. HV enables
EPT and VPID hardware virtualization features, establishes EPT page
tables for SOS/UOS, and provides EPT page tables operation interfaces to
others.</p>
<p>In the ACRN hypervisor system, there are few different memory spaces to
consider.  From the hypervisor’s point of view there are:</p>
<ul class="simple">
<li><strong>Host Physical Address (HPA)</strong>: the native physical address space, and</li>
<li><strong>Host Virtual Address (HVA)</strong>: the native virtual address space based on
a MMU. A page table is used to translate between HPA and HVA
spaces.</li>
</ul>
<p>From the Guest OS running on a hypervisor there are:</p>
<ul class="simple">
<li><strong>Guest Physical Address (GPA)</strong>: the guest physical address space from a
virtual machine.  GPA to HPA transition is usually based on a
MMU-like hardware module (EPT in X86), and associated with a page
table</li>
<li><strong>Guest Virtual Address (GVA)</strong>: the guest virtual address space from a
virtual machine based on a vMMU</li>
</ul>
<div class="figure align-center" id="mem-overview">
<a class="reference internal image-reference" href="../../_images/mem-image2.png"><img alt="../../_images/mem-image2.png" src="../../_images/mem-image2.png" style="width: 900px;" /></a>
<p class="caption"><span class="caption-number">Figure 35 </span><span class="caption-text">ACRN Memory Mapping Overview</span></p>
</div>
<p><a class="reference internal" href="#mem-overview"><span class="std std-numref">Figure 35</span></a> provides an overview of the ACRN system memory
mapping, showing:</p>
<ul class="simple">
<li>GVA to GPA mapping based on vMMU on a VCPU in a VM</li>
<li>GPA to HPA mapping based on EPT for a VM in the hypervisor</li>
<li>HVA to HPA mapping based on MMU in the hypervisor</li>
</ul>
<p>This document illustrates the memory management infrastructure for the
ACRN hypervisor and how it handles the different memory space views
inside the hypervisor and from a VM:</p>
<ul class="simple">
<li>How ACRN hypervisor manages host memory (HPA/HVA)</li>
<li>How ACRN hypervisor manages SOS guest memory (HPA/GPA)</li>
<li>How ACRN hypervisor &amp; SOS DM manage UOS guest memory (HPA/GPA)</li>
</ul>
</div>
<div class="section" id="hypervisor-physical-memory-management">
<h2>Hypervisor Physical Memory Management<a class="headerlink" href="#hypervisor-physical-memory-management" title="Permalink to this headline">¶</a></h2>
<p>In the ACRN, the HV initializes MMU page tables to manage all physical
memory and then switches to the new MMU page tables. After MMU page
tables are initialized at the platform initialization stage, no updates
are made for MMU page tables.</p>
<div class="section" id="hypervisor-physical-memory-layout-e820">
<h3>Hypervisor Physical Memory Layout - E820<a class="headerlink" href="#hypervisor-physical-memory-layout-e820" title="Permalink to this headline">¶</a></h3>
<p>The ACRN hypervisor is the primary owner to manage system memory.
Typically the boot firmware (e.g., EFI) passes the platform physical
memory layout - E820 table to the hypervisor. The ACRN hypervisor does
its memory management based on this table using 4-level paging.</p>
<p>The BIOS/bootloader firmware (e.g., EFI) passes the E820 table through a
multiboot protocol.  This table contains the original memory layout for
the platform.</p>
<div class="figure align-center" id="mem-layout">
<a class="reference internal image-reference" href="../../_images/mem-image1.png"><img alt="../../_images/mem-image1.png" src="../../_images/mem-image1.png" style="width: 900px;" /></a>
<p class="caption"><span class="caption-number">Figure 36 </span><span class="caption-text">Physical Memory Layout Example</span></p>
</div>
<p><a class="reference internal" href="#mem-layout"><span class="std std-numref">Figure 36</span></a> is an example of the physical memory layout based on a simple
platform E820 table.</p>
</div>
<div class="section" id="hypervisor-memory-initialization">
<h3>Hypervisor Memory Initialization<a class="headerlink" href="#hypervisor-memory-initialization" title="Permalink to this headline">¶</a></h3>
<p>The ACRN hypervisor runs under paging mode. After the bootstrap
processor (BSP) gets the platform E820 table, BSP creates its MMU page
table based on it. This is done by the function <em>init_paging()</em> and
<em>smep()</em>. After the application processor (AP) receives IPI CPU startup
interrupt, it uses the MMU page tables created by BSP and enable SMEP.
<a class="reference internal" href="#hv-mem-init"><span class="std std-numref">Figure 37</span></a>  describes the hypervisor memory initialization for BSP
and APs.</p>
<div class="figure align-center" id="hv-mem-init">
<img alt="../../_images/mem-image8.png" src="../../_images/mem-image8.png" />
<p class="caption"><span class="caption-number">Figure 37 </span><span class="caption-text">Hypervisor Memory Initialization</span></p>
</div>
<p>The memory mapping policy used is:</p>
<ul class="simple">
<li>Identical mapping (ACRN hypervisor memory could be relocatable in
the future)</li>
<li>Map all memory regions with UNCACHED type</li>
<li>Remap RAM regions to WRITE-BACK type</li>
</ul>
<div class="figure align-center" id="hv-mem-vm-init">
<img alt="../../_images/mem-image69.png" src="../../_images/mem-image69.png" />
<p class="caption"><span class="caption-number">Figure 38 </span><span class="caption-text">Hypervisor Virtual Memory Layout</span></p>
</div>
<p><a class="reference internal" href="#hv-mem-vm-init"><span class="std std-numref">Figure 38</span></a> above shows:</p>
<ul class="simple">
<li>Hypervisor has a view of and can access all system memory</li>
<li>Hypervisor has UNCACHED MMIO/PCI hole reserved for devices such as
LAPIC/IOAPIC accessing</li>
<li>Hypervisor has its own memory with WRITE-BACK cache type for its
code/data (&lt; 1M part is for secondary CPU reset code)</li>
</ul>
<p>The hypervisor should use minimum memory pages to map from virtual
address space into physical address space.</p>
<ul class="simple">
<li>If 1GB hugepage can be used
for virtual address space mapping, the corresponding PDPT entry shall be
set for this 1GB hugepage.</li>
<li>If 1GB hugepage can’t be used for virtual
address space mapping and 2MB hugepage can be used, the corresponding
PDT entry shall be set for this 2MB hugepage.</li>
<li>If both of 1GB hugepage
and 2MB hugepage can’t be used for virtual address space mapping, the
corresponding PT entry shall be set.</li>
</ul>
<p>If memory type or access rights of a page is updated, or some virtual
address space is deleted, it will lead to splitting of the corresponding
page. The hypervisor will still keep using minimum memory pages to map from
virtual address space into physical address space.</p>
</div>
<div class="section" id="memory-pages-pool-functions">
<h3>Memory Pages Pool Functions<a class="headerlink" href="#memory-pages-pool-functions" title="Permalink to this headline">¶</a></h3>
<p>Memory pages pool functions provide dynamic management of multiple
4KB page-size memory blocks, used by the hypervisor to store internal
data.  Through these functions, the hypervisor can allocate and
deallocate pages.</p>
</div>
<div class="section" id="data-flow-design">
<h3>Data Flow Design<a class="headerlink" href="#data-flow-design" title="Permalink to this headline">¶</a></h3>
<p>The physical memory management unit provides MMU 4-level page tables
creating and updating services, MMU page tables switching service, SMEP
enable service, and HPA/HVA retrieving service to other units.
<a class="reference internal" href="#mem-data-flow-physical"><span class="std std-numref">Figure 39</span></a> shows the data flow diagram
of physical memory management.</p>
<div class="figure align-center" id="mem-data-flow-physical">
<img alt="../../_images/mem-image45.png" src="../../_images/mem-image45.png" />
<p class="caption"><span class="caption-number">Figure 39 </span><span class="caption-text">Data Flow of Hypervisor Physical Memory Management</span></p>
</div>
</div>
<div class="section" id="data-structure-design">
<h3>Data Structure Design<a class="headerlink" href="#data-structure-design" title="Permalink to this headline">¶</a></h3>
<p>The page tables operation type:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">enum</span> <span class="n">_page_table_type</span> <span class="p">{</span>

   <span class="n">PTT_HOST</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>           <span class="cm">/* Operations for MMU page tables */</span>
   <span class="n">PTT_EPT</span>  <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>           <span class="cm">/* Operations for EPT page tables */</span>
   <span class="n">PAGETABLE_TYPE_UNKNOWN</span><span class="p">,</span> <span class="cm">/* Page tables operation type is unknown */</span>
<span class="p">};</span>
</pre></div>
</div>
</div>
<div class="section" id="interfaces-design">
<h3>Interfaces Design<a class="headerlink" href="#interfaces-design" title="Permalink to this headline">¶</a></h3>
<div class="section" id="mmu-initialization">
<h4>MMU Initialization<a class="headerlink" href="#mmu-initialization" title="Permalink to this headline">¶</a></h4>
<dl class="function">
<dt id="_CPPv311enable_smepv">
<span id="_CPPv211enable_smepv"></span><span id="enable_smep__void"></span><span class="target" id="group__acrn__mem_ga7bb574e29bce9e800481c5db00ef3cd3_1ga7bb574e29bce9e800481c5db00ef3cd3"></span>void <code class="descname">enable_smep</code><span class="sig-paren">(</span>void<span class="sig-paren">)</span><a class="headerlink" href="#_CPPv311enable_smepv" title="Permalink to this definition">¶</a><br /></dt>
<dd><p>Supervisor-mode execution prevention (SMEP) enable. </p>
<p><dl class="docutils">
<dt><strong>Return</strong></dt>
<dd>None </dd>
</dl>
</p>
</dd></dl>

<dl class="function">
<dt id="_CPPv313enable_pagingv">
<span id="_CPPv213enable_pagingv"></span><span id="enable_paging__void"></span><span class="target" id="group__acrn__mem_ga0ad77ccada03a5abedf6917e6f2649a5_1ga0ad77ccada03a5abedf6917e6f2649a5"></span>void <code class="descname">enable_paging</code><span class="sig-paren">(</span>void<span class="sig-paren">)</span><a class="headerlink" href="#_CPPv313enable_pagingv" title="Permalink to this definition">¶</a><br /></dt>
<dd><p>MMU paging enable. </p>
<p><dl class="docutils">
<dt><strong>Return</strong></dt>
<dd>None </dd>
</dl>
</p>
</dd></dl>

<dl class="function">
<dt id="_CPPv311init_pagingv">
<span id="_CPPv211init_pagingv"></span><span id="init_paging__void"></span><span class="target" id="group__acrn__mem_gac3abd519b92ce6ac308db69e4c4ff04e_1gac3abd519b92ce6ac308db69e4c4ff04e"></span>void <code class="descname">init_paging</code><span class="sig-paren">(</span>void<span class="sig-paren">)</span><a class="headerlink" href="#_CPPv311init_pagingv" title="Permalink to this definition">¶</a><br /></dt>
<dd><p>MMU page tables initialization. </p>
<p><dl class="docutils">
<dt><strong>Return</strong></dt>
<dd>None </dd>
</dl>
</p>
</dd></dl>

</div>
<div class="section" id="address-space-translation">
<h4>Address Space Translation<a class="headerlink" href="#address-space-translation" title="Permalink to this headline">¶</a></h4>
<dl class="function">
<dt id="_CPPv37hpa2hva8uint64_t">
<span id="_CPPv27hpa2hva8uint64_t"></span><span id="hpa2hva__uint64_t"></span><span class="target" id="group__acrn__mem_ga30c6f3439527ad05a3a70f384e14faf9_1ga30c6f3439527ad05a3a70f384e14faf9"></span><em class="property">static</em> void *<code class="descname">hpa2hva</code><span class="sig-paren">(</span>uint64_t <em>x</em><span class="sig-paren">)</span><a class="headerlink" href="#_CPPv37hpa2hva8uint64_t" title="Permalink to this definition">¶</a><br /></dt>
<dd><p>Translate host-physical address to host-virtual address. </p>
<p><dl class="docutils">
<dt><strong>Return</strong></dt>
<dd>The translated host-virtual address </dd>
<dt><strong>Parameters</strong></dt>
<dd><ul class="breatheparameterlist first last simple">
<li><code class="docutils literal notranslate"><span class="pre">x</span></code>: The specified host-physical address</li>
</ul>
</dd>
</dl>
</p>
</dd></dl>

<dl class="function">
<dt id="_CPPv37hva2hpaPv">
<span id="_CPPv27hva2hpaPv"></span><span id="hva2hpa__voidP"></span><span class="target" id="group__acrn__mem_gaa27dc61923169ac81da8fbe66bccf786_1gaa27dc61923169ac81da8fbe66bccf786"></span><em class="property">static</em> uint64_t <code class="descname">hva2hpa</code><span class="sig-paren">(</span>void *<em>x</em><span class="sig-paren">)</span><a class="headerlink" href="#_CPPv37hva2hpaPv" title="Permalink to this definition">¶</a><br /></dt>
<dd><p>Translate host-virtual address to host-physical address. </p>
<p><dl class="docutils">
<dt><strong>Return</strong></dt>
<dd>The translated host-physical address </dd>
<dt><strong>Parameters</strong></dt>
<dd><ul class="breatheparameterlist first last simple">
<li><code class="docutils literal notranslate"><span class="pre">x</span></code>: The specified host-virtual address</li>
</ul>
</dd>
</dl>
</p>
</dd></dl>

</div>
</div>
</div>
<div class="section" id="hypervisor-memory-virtualization">
<h2>Hypervisor Memory Virtualization<a class="headerlink" href="#hypervisor-memory-virtualization" title="Permalink to this headline">¶</a></h2>
<p>The hypervisor provides a contiguous region of physical memory for SOS
and each UOS. It also guarantees that the SOS and UOS can not access
code and internal data in the hypervisor, and each UOS can not access
code and internal data of the SOS and other UOSs.</p>
<p>The hypervisor:</p>
<ul class="simple">
<li>enables EPT and VPID hardware virtualization features,</li>
<li>establishes EPT page tables for SOS/UOS,</li>
<li>provides EPT page tables operations services,</li>
<li>virtualizes MTRR for SOS/UOS,</li>
<li>provides VPID operations services,</li>
<li>provides services for address spaces translation between GPA and HPA, and</li>
<li>provides services for data transfer between hypervisor and virtual machine.</li>
</ul>
<div class="section" id="memory-virtualization-capability-checking">
<h3>Memory Virtualization Capability Checking<a class="headerlink" href="#memory-virtualization-capability-checking" title="Permalink to this headline">¶</a></h3>
<p>In the hypervisor, memory virtualization provides EPT/VPID capability
checking service and EPT hugepage supporting checking service. Before HV
enables memory virtualization and uses EPT hugepage, these service need
to be invoked by other units.</p>
</div>
<div class="section" id="data-transfer-between-different-address-spaces">
<h3>Data Transfer between Different Address Spaces<a class="headerlink" href="#data-transfer-between-different-address-spaces" title="Permalink to this headline">¶</a></h3>
<p>In ACRN, different memory space management is used in the hypervisor,
Service OS, and User OS to achieve spatial isolation. Between memory
spaces, there are different kinds of data transfer, such as a SOS/UOS
may hypercall to request hypervisor services which includes data
transferring, or when the hypervisor does instruction emulation: the HV
needs to access the guest instruction pointer register to fetch guest
instruction data.</p>
<div class="section" id="access-gpa-from-hypervisor">
<h4>Access GPA from Hypervisor<a class="headerlink" href="#access-gpa-from-hypervisor" title="Permalink to this headline">¶</a></h4>
<p>When hypervisor need access GPA for data transfer, the caller from guest
must make sure this memory range’s GPA is continuous. But for HPA in
hypervisor, it could be dis-continuous (especially for UOS under hugetlb
allocation mechanism).  For example, a 4M GPA range may map to 2
different 2M huge host-physical pages. The ACRN hypervisor must take
care of this kind of data transfer by doing EPT page walking based on
its HPA.</p>
</div>
<div class="section" id="access-gva-from-hypervisor">
<h4>Access GVA from Hypervisor<a class="headerlink" href="#access-gva-from-hypervisor" title="Permalink to this headline">¶</a></h4>
<p>When hypervisor needs to access GVA for data transfer, it’s likely both
GPA and HPA could be address dis-continuous. The ACRN hypervisor must
watch for this kind of data transfer, and handle it by doing page
walking based on both its GPA and HPA.</p>
</div>
</div>
<div class="section" id="ept-page-tables-operations">
<h3>EPT Page Tables Operations<a class="headerlink" href="#ept-page-tables-operations" title="Permalink to this headline">¶</a></h3>
<p>The hypervisor should use a minimum of memory pages to map from
guest-physical address (GPA) space into host-physical address (HPA)
space.</p>
<ul class="simple">
<li>If 1GB hugepage can be used for GPA space mapping, the
corresponding EPT PDPT entry shall be set for this 1GB hugepage.</li>
<li>If 1GB hugepage can’t be used for GPA space mapping and 2MB hugepage can be
used, the corresponding EPT PDT entry shall be set for this 2MB
hugepage.</li>
<li>If both 1GB hugepage and 2MB hugepage can’t be used for GPA
space mapping, the corresponding EPT PT entry shall be set.</li>
</ul>
<p>If memory type or access rights of a page is updated or some GPA space
is deleted, it will lead to the corresponding EPT page being split. The
hypervisor should still keep to using minimum EPT pages to map from GPA
space into HPA space.</p>
<p>The hypervisor provides EPT guest-physical mappings adding service, EPT
guest-physical mappings modifying/deleting service, EPT page tables
deallocation, and EPT guest-physical mappings invalidation service.</p>
</div>
</div>
<div class="section" id="virtual-mtrr">
<h2>Virtual MTRR<a class="headerlink" href="#virtual-mtrr" title="Permalink to this headline">¶</a></h2>
<p>In ACRN, the hypervisor only virtualizes MTRRs fixed range (0~1MB).
The HV sets MTRRs of the fixed range as Write-Back for UOS, and the SOS reads
native MTRRs of the fixed range set by BIOS.</p>
<p>If the guest physical address is not in the fixed range (0~1MB), the
hypervisor uses the default memory type in the MTRR (Write-Back).</p>
<p>When the guest disables MTRRs, the HV sets the guest address memory type
as UC.</p>
<p>If the guest physical address is in fixed range (0~1MB), the HV sets
memory type according to the fixed virtual MTRRs.</p>
<p>When the guest enable MTRRs, MTRRs have no effect on the memory type
used for access to GPA. The HV first intercepts MTRR MSR registers
access through MSR access VM exit and updates EPT memory type field in EPT
PTE according to the memory type selected by MTRRs.  This combines with
PAT entry in the PAT MSR (which is determined by PAT, PCD, and PWT bits
from the guest paging structures) to determine the effective memory
type.</p>
<div class="section" id="vpid-operations">
<h3>VPID operations<a class="headerlink" href="#vpid-operations" title="Permalink to this headline">¶</a></h3>
<p>Virtual-processor identifier (VPID) is a hardware feature to optimize
TLB management. When VPID is enable, hardware will add a tag for TLB of
a logical processor and cache information for multiple linear-address
spaces. VMX transitions may retain cached information and the logical
processor switches to a different address space, avoiding unnecessary
TLB flushes.</p>
<p>In ACRN, an unique VPID must be allocated for each virtual CPU
when a virtual CPU is created. The logical processor invalidates linear
mappings and combined mapping associated with all VPIDs (except VPID
0000H), and with all PCIDs when the logical processor launches the virtual
CPU. The logical processor invalidates all linear mapping and combined
mappings associated with the specified VPID when the interrupt pending
request handling needs to invalidate cached mapping of the specified
VPID.</p>
</div>
<div class="section" id="id1">
<h3>Data Flow Design<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h3>
<p>The memory virtualization unit includes address space translation
functions, data transferring functions, VM EPT operations functions,
VPID operations functions, VM exit hanging about EPT violation and EPT
misconfiguration, and MTRR virtualization functions. This unit handles
guest-physical mapping updates by creating or updating related EPT page
tables. It virtualizes MTRR for guest OS by updating related EPT page
tables. It handles address translation from GPA to HPA by walking EPT
page tables. It copies data from VM into the HV or from the HV to VM by
walking guest MMU page tables and EPT page tables. It provides services
to allocate VPID for each virtual CPU and TLB invalidation related VPID.
It handles VM exit about EPT violation and EPT misconfiguration. The
following <a class="reference internal" href="#mem-flow-mem-virt"><span class="std std-numref">Figure 40</span></a> describes the data flow diagram of
the memory virtualization unit.</p>
<div class="figure align-center" id="mem-flow-mem-virt">
<img alt="../../_images/mem-image84.png" src="../../_images/mem-image84.png" />
<p class="caption"><span class="caption-number">Figure 40 </span><span class="caption-text">Data Flow of Hypervisor Memory Virtualization</span></p>
</div>
</div>
<div class="section" id="id2">
<h3>Data Structure Design<a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h3>
<p>EPT Memory Type Data Definition:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cm">/* EPT memory type is specified in bits 5:3 of the last EPT</span>
<span class="cm"> * paging-structure entry */</span>
<span class="cp">#define EPT_MT_SHIFT 3U</span>

<span class="cm">/* EPT memory type is uncacheable  */</span>
<span class="cp">#define EPT_UNCACHED (0UL &lt;&lt; EPT_MT_SHIFT)</span>

<span class="cm">/* EPT memory type is write combining  */</span>
<span class="cp">#define EPT_WC (1UL &lt;&lt; EPT_MT_SHIFT)</span>

<span class="cm">/* EPT memory type is write through */</span>
<span class="cp">#define EPT_WT (4UL &lt;&lt; EPT_MT_SHIFT)</span>

<span class="cm">/* EPT memory type is write protected  */</span>
<span class="cp">#define EPT_WP (5UL &lt;&lt; EPT_MT_SHIFT)</span>

<span class="cm">/* EPT memory type is write back */</span>
<span class="cp">#define EPT_WB (6UL &lt;&lt; EPT_MT_SHIFT)</span>
</pre></div>
</div>
<p>EPT Memory Access Right Definition:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cm">/* EPT memory access right is read-only */</span>
<span class="cp">#define EPT_RD (1UL &lt;&lt; 0U)</span>

<span class="cm">/* EPT memory access right is read/write */</span>
<span class="cp">#define EPT_WR (1UL &lt;&lt; 1U)</span>

<span class="cm">/* EPT memory access right is executable */</span>
<span class="cp">#define EPT_EXE (1UL &lt;&lt; 2U)</span>

<span class="cm">/* EPT memory access right is read/write and executable */</span>
<span class="n">define</span> <span class="n">EPT_RWX</span> <span class="p">(</span><span class="n">EPT_RD</span> <span class="o">|</span> <span class="n">EPT_WR</span> <span class="o">|</span> <span class="n">EPT_EXE</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="id3">
<h3>Interfaces Design<a class="headerlink" href="#id3" title="Permalink to this headline">¶</a></h3>
<p>The memory virtualization unit interacts with external units through VM
exit and APIs.</p>
</div>
<div class="section" id="vm-exit-about-ept">
<h3>VM Exit about EPT<a class="headerlink" href="#vm-exit-about-ept" title="Permalink to this headline">¶</a></h3>
<p>There are two VM exit handlers for EPT violation and EPT
misconfiguration in the hypervisor. EPT page tables are
always configured correctly for SOS and UOS. If EPT misconfiguration is
detected, a fatal error is reported by HV. The hypervisor
uses EPT violation to intercept MMIO access to do device emulation. EPT
violation handling data flow is described in the
<a class="reference internal" href="hv-cpu-virt.html#instruction-emulation"><span class="std std-ref">Instruction Emulation</span></a>.</p>
</div>
<div class="section" id="memory-virtualization-apis">
<h3>Memory Virtualization APIs<a class="headerlink" href="#memory-virtualization-apis" title="Permalink to this headline">¶</a></h3>
<p>Here is a list of major memory related APIs in HV:</p>
<div class="section" id="ept-vpid-capability-checking">
<h4>EPT/VPID Capability Checking<a class="headerlink" href="#ept-vpid-capability-checking" title="Permalink to this headline">¶</a></h4>
</div>
<div class="section" id="data-transferring-between-hypervisor-and-vm">
<h4>Data Transferring between hypervisor and VM<a class="headerlink" href="#data-transferring-between-hypervisor-and-vm" title="Permalink to this headline">¶</a></h4>
<dl class="function">
<dt id="_CPPv313copy_from_gpaP7acrn_vmPv8uint64_t8uint32_t">
<span id="_CPPv213copy_from_gpaP7acrn_vmPv8uint64_t8uint32_t"></span><span id="copy_from_gpa__acrn_vmP.voidP.uint64_t.uint32_t"></span><span class="target" id="group__acrn__mem_gaf76b800fc29948379f856ea78ea0eb34_1gaf76b800fc29948379f856ea78ea0eb34"></span>int32_t <code class="descname">copy_from_gpa</code><span class="sig-paren">(</span><em class="property">struct</em> acrn_vm *<em>vm</em>, void *<em>h_ptr</em>, uint64_t <em>gpa</em>, uint32_t <em>size</em><span class="sig-paren">)</span><a class="headerlink" href="#_CPPv313copy_from_gpaP7acrn_vmPv8uint64_t8uint32_t" title="Permalink to this definition">¶</a><br /></dt>
<dd><p>Copy data from VM GPA space to HV address space. </p>
<p><dl class="docutils">
<dt><strong>Pre</strong></dt>
<dd>Caller(Guest) should make sure gpa is continuous.<ul class="simple">
<li>gpa from hypercall input which from kernel stack is gpa continuous, not support kernel stack from vmap</li>
<li>some other gpa from hypercall parameters, VHM should make sure it’s continuous </li>
</ul>
</dd>
<dt><strong>Pre</strong></dt>
<dd>Pointer vm is non-NULL </dd>
<dt><strong>Parameters</strong></dt>
<dd><ul class="breatheparameterlist first last simple">
<li><code class="docutils literal notranslate"><span class="pre">vm</span></code>: The pointer that points to VM data structure </li>
<li><code class="docutils literal notranslate"><span class="pre">h_ptr</span></code>: The pointer that points the start HV address of HV memory region which data is stored in </li>
<li><code class="docutils literal notranslate"><span class="pre">gpa</span></code>: The start GPA address of GPA memory region which data will be copied into </li>
<li><code class="docutils literal notranslate"><span class="pre">size</span></code>: The size (bytes) of GPA memory region which data is stored in</li>
</ul>
</dd>
</dl>
</p>
</dd></dl>

<dl class="function">
<dt id="_CPPv311copy_to_gpaP7acrn_vmPv8uint64_t8uint32_t">
<span id="_CPPv211copy_to_gpaP7acrn_vmPv8uint64_t8uint32_t"></span><span id="copy_to_gpa__acrn_vmP.voidP.uint64_t.uint32_t"></span><span class="target" id="group__acrn__mem_gabc8ab821205d666d41a90b4c7d2e7976_1gabc8ab821205d666d41a90b4c7d2e7976"></span>int32_t <code class="descname">copy_to_gpa</code><span class="sig-paren">(</span><em class="property">struct</em> acrn_vm *<em>vm</em>, void *<em>h_ptr</em>, uint64_t <em>gpa</em>, uint32_t <em>size</em><span class="sig-paren">)</span><a class="headerlink" href="#_CPPv311copy_to_gpaP7acrn_vmPv8uint64_t8uint32_t" title="Permalink to this definition">¶</a><br /></dt>
<dd><p>Copy data from HV address space to VM GPA space. </p>
<p><dl class="docutils">
<dt><strong>Pre</strong></dt>
<dd>Caller(Guest) should make sure gpa is continuous.<ul class="simple">
<li>gpa from hypercall input which from kernel stack is gpa continuous, not support kernel stack from vmap</li>
<li>some other gpa from hypercall parameters, VHM should make sure it’s continuous </li>
</ul>
</dd>
<dt><strong>Pre</strong></dt>
<dd>Pointer vm is non-NULL </dd>
<dt><strong>Parameters</strong></dt>
<dd><ul class="breatheparameterlist first last simple">
<li><code class="docutils literal notranslate"><span class="pre">vm</span></code>: The pointer that points to VM data structure </li>
<li><code class="docutils literal notranslate"><span class="pre">h_ptr</span></code>: The pointer that points the start HV address of HV memory region which data is stored in </li>
<li><code class="docutils literal notranslate"><span class="pre">gpa</span></code>: The start GPA address of GPA memory region which data will be copied into </li>
<li><code class="docutils literal notranslate"><span class="pre">size</span></code>: The size (bytes) of GPA memory region which data will be copied into</li>
</ul>
</dd>
</dl>
</p>
</dd></dl>

<dl class="function">
<dt id="_CPPv313copy_from_gvaP9acrn_vcpuPv8uint64_t8uint32_tP8uint32_tP8uint64_t">
<span id="_CPPv213copy_from_gvaP9acrn_vcpuPv8uint64_t8uint32_tP8uint32_tP8uint64_t"></span><span id="copy_from_gva__acrn_vcpuP.voidP.uint64_t.uint32_t.uint32_tP.uint64_tP"></span><span class="target" id="group__acrn__mem_ga8d917d7c9042547c7ddc9d706f413673_1ga8d917d7c9042547c7ddc9d706f413673"></span>int32_t <code class="descname">copy_from_gva</code><span class="sig-paren">(</span><em class="property">struct</em> acrn_vcpu *<em>vcpu</em>, void *<em>h_ptr</em>, uint64_t <em>gva</em>, uint32_t <em>size</em>, uint32_t *<em>err_code</em>, uint64_t *<em>fault_addr</em><span class="sig-paren">)</span><a class="headerlink" href="#_CPPv313copy_from_gvaP9acrn_vcpuPv8uint64_t8uint32_tP8uint32_tP8uint64_t" title="Permalink to this definition">¶</a><br /></dt>
<dd><p>Copy data from VM GVA space to HV address space. </p>
<p><dl class="docutils">
<dt><strong>Parameters</strong></dt>
<dd><ul class="breatheparameterlist first last simple">
<li><code class="docutils literal notranslate"><span class="pre">vcpu</span></code>: The pointer that points to vcpu data structure </li>
<li><code class="docutils literal notranslate"><span class="pre">h_ptr</span></code>: The pointer that returns the start HV address of HV memory region which data will be copied to </li>
<li><code class="docutils literal notranslate"><span class="pre">gva</span></code>: The start GVA address of GVA memory region which data is stored in </li>
<li><code class="docutils literal notranslate"><span class="pre">size</span></code>: The size (bytes) of GVA memory region which data is stored in </li>
<li><code class="docutils literal notranslate"><span class="pre">err_code</span></code>: The page fault flags </li>
<li><code class="docutils literal notranslate"><span class="pre">fault_addr</span></code>: The GVA address that causes a page fault </li>
</ul>
</dd>
</dl>
</p>
</dd></dl>

<dl class="function">
<dt id="_CPPv311copy_to_gvaP9acrn_vcpuPv8uint64_t8uint32_tP8uint32_tP8uint64_t">
<span id="_CPPv211copy_to_gvaP9acrn_vcpuPv8uint64_t8uint32_tP8uint32_tP8uint64_t"></span><span id="copy_to_gva__acrn_vcpuP.voidP.uint64_t.uint32_t.uint32_tP.uint64_tP"></span><span class="target" id="group__acrn__mem_ga317b247644260220970c5abfd3df0e2f_1ga317b247644260220970c5abfd3df0e2f"></span>int32_t <code class="descname">copy_to_gva</code><span class="sig-paren">(</span><em class="property">struct</em> acrn_vcpu *<em>vcpu</em>, void *<em>h_ptr</em>, uint64_t <em>gva</em>, uint32_t <em>size</em>, uint32_t *<em>err_code</em>, uint64_t *<em>fault_addr</em><span class="sig-paren">)</span><a class="headerlink" href="#_CPPv311copy_to_gvaP9acrn_vcpuPv8uint64_t8uint32_tP8uint32_tP8uint64_t" title="Permalink to this definition">¶</a><br /></dt>
<dd><p>Copy data from HV address space to VM GVA space. </p>
<p><dl class="docutils">
<dt><strong>Parameters</strong></dt>
<dd><ul class="breatheparameterlist first last simple">
<li><code class="docutils literal notranslate"><span class="pre">vcpu</span></code>: The pointer that points to vcpu data structure </li>
<li><code class="docutils literal notranslate"><span class="pre">h_ptr</span></code>: The pointer that points the start HV address of HV memory region which data is stored in </li>
<li><code class="docutils literal notranslate"><span class="pre">gva</span></code>: The start GVA address of GVA memory region which data will be copied into </li>
<li><code class="docutils literal notranslate"><span class="pre">size</span></code>: The size (bytes) of GVA memory region which data will be copied into </li>
<li><code class="docutils literal notranslate"><span class="pre">err_code</span></code>: The page fault flags </li>
<li><code class="docutils literal notranslate"><span class="pre">fault_addr</span></code>: The GVA address that causes a page fault </li>
</ul>
</dd>
</dl>
</p>
</dd></dl>

</div>
<div class="section" id="id4">
<h4>Address Space Translation<a class="headerlink" href="#id4" title="Permalink to this headline">¶</a></h4>
<dl class="function">
<dt id="_CPPv37gpa2hpaP7acrn_vm8uint64_t">
<span id="_CPPv27gpa2hpaP7acrn_vm8uint64_t"></span><span id="gpa2hpa__acrn_vmP.uint64_t"></span><span class="target" id="group__acrn__mem_ga952f4921ff63f1287c48a9fbf2550dc9_1ga952f4921ff63f1287c48a9fbf2550dc9"></span>uint64_t <code class="descname">gpa2hpa</code><span class="sig-paren">(</span><em class="property">struct</em> acrn_vm *<em>vm</em>, uint64_t <em>gpa</em><span class="sig-paren">)</span><a class="headerlink" href="#_CPPv37gpa2hpaP7acrn_vm8uint64_t" title="Permalink to this definition">¶</a><br /></dt>
<dd><p>Translating from guest-physical address to host-physcial address. </p>
<p><dl class="docutils">
<dt><strong>Parameters</strong></dt>
<dd><ul class="breatheparameterlist first last simple">
<li><code class="docutils literal notranslate"><span class="pre">vm</span></code>: the pointer that points to VM data structure </li>
<li><code class="docutils literal notranslate"><span class="pre">gpa</span></code>: the specified guest-physical address</li>
</ul>
</dd>
<dt><strong>Return Value</strong></dt>
<dd><ul class="breatheparameterlist first last simple">
<li><code class="docutils literal notranslate"><span class="pre">hpa</span></code>: the host physical address mapping to the <code class="docutils literal notranslate"><span class="pre">gpa</span></code> </li>
<li><code class="docutils literal notranslate"><span class="pre">INVALID_HPA</span></code>: the HPA of parameter gpa is unmapping </li>
</ul>
</dd>
</dl>
</p>
</dd></dl>

<dl class="function">
<dt id="_CPPv311vm0_hpa2gpa8uint64_t">
<span id="_CPPv211vm0_hpa2gpa8uint64_t"></span><span id="vm0_hpa2gpa__uint64_t"></span><span class="target" id="group__acrn__mem_gaa9fc301c844218369a7bf6860765a841_1gaa9fc301c844218369a7bf6860765a841"></span>uint64_t <code class="descname">vm0_hpa2gpa</code><span class="sig-paren">(</span>uint64_t <em>hpa</em><span class="sig-paren">)</span><a class="headerlink" href="#_CPPv311vm0_hpa2gpa8uint64_t" title="Permalink to this definition">¶</a><br /></dt>
<dd><p>Translating from host-physical address to guest-physical address for VM0. </p>
<p><dl class="docutils">
<dt><strong>Pre</strong></dt>
<dd>: the gpa and hpa are identical mapping in SOS. </dd>
<dt><strong>Parameters</strong></dt>
<dd><ul class="breatheparameterlist first last simple">
<li><code class="docutils literal notranslate"><span class="pre">hpa</span></code>: the specified host-physical address</li>
</ul>
</dd>
</dl>
</p>
</dd></dl>

</div>
<div class="section" id="ept">
<h4>EPT<a class="headerlink" href="#ept" title="Permalink to this headline">¶</a></h4>
<dl class="function">
<dt id="_CPPv310ept_mr_addP7acrn_vmP8uint64_t8uint64_t8uint64_t8uint64_t8uint64_t">
<span id="_CPPv210ept_mr_addP7acrn_vmP8uint64_t8uint64_t8uint64_t8uint64_t8uint64_t"></span><span id="ept_mr_add__acrn_vmP.uint64_tP.uint64_t.uint64_t.uint64_t.uint64_t"></span><span class="target" id="group__acrn__mem_gac4ea9643d432bef0b3256df3b55da84b_1gac4ea9643d432bef0b3256df3b55da84b"></span>void <code class="descname">ept_mr_add</code><span class="sig-paren">(</span><em class="property">struct</em> acrn_vm *<em>vm</em>, uint64_t *<em>pml4_page</em>, uint64_t <em>hpa</em>, uint64_t <em>gpa</em>, uint64_t <em>size</em>, uint64_t <em>prot_orig</em><span class="sig-paren">)</span><a class="headerlink" href="#_CPPv310ept_mr_addP7acrn_vmP8uint64_t8uint64_t8uint64_t8uint64_t8uint64_t" title="Permalink to this definition">¶</a><br /></dt>
<dd><p>Guest-physical memory region mapping. </p>
<p><dl class="docutils">
<dt><strong>Return</strong></dt>
<dd>None </dd>
<dt><strong>Parameters</strong></dt>
<dd><ul class="breatheparameterlist first last simple">
<li><code class="docutils literal notranslate"><span class="pre">vm</span></code>: the pointer that points to VM data structure </li>
<li><code class="docutils literal notranslate"><span class="pre">pml4_page</span></code>: The physical address of The EPTP </li>
<li><code class="docutils literal notranslate"><span class="pre">hpa</span></code>: The specified start host physical address of host physical memory region that GPA will be mapped </li>
<li><code class="docutils literal notranslate"><span class="pre">gpa</span></code>: The specified start guest physical address of guest physical memory region that needs to be mapped </li>
<li><code class="docutils literal notranslate"><span class="pre">size</span></code>: The size of guest physical memory region that needs to be mapped </li>
<li><code class="docutils literal notranslate"><span class="pre">prot_orig</span></code>: The specified memory access right and memory type</li>
</ul>
</dd>
</dl>
</p>
</dd></dl>

<dl class="function">
<dt id="_CPPv310ept_mr_delP7acrn_vmP8uint64_t8uint64_t8uint64_t">
<span id="_CPPv210ept_mr_delP7acrn_vmP8uint64_t8uint64_t8uint64_t"></span><span id="ept_mr_del__acrn_vmP.uint64_tP.uint64_t.uint64_t"></span><span class="target" id="group__acrn__mem_ga6b6e32444196fe56540e921cd3afdc3d_1ga6b6e32444196fe56540e921cd3afdc3d"></span>void <code class="descname">ept_mr_del</code><span class="sig-paren">(</span><em class="property">struct</em> acrn_vm *<em>vm</em>, uint64_t *<em>pml4_page</em>, uint64_t <em>gpa</em>, uint64_t <em>size</em><span class="sig-paren">)</span><a class="headerlink" href="#_CPPv310ept_mr_delP7acrn_vmP8uint64_t8uint64_t8uint64_t" title="Permalink to this definition">¶</a><br /></dt>
<dd><p>Guest-physical memory region unmapping. </p>
<p><dl class="docutils">
<dt><strong>Return</strong></dt>
<dd>None</dd>
<dt><strong>Pre</strong></dt>
<dd>[gpa,gpa+size) has been mapped into host physical memory region </dd>
<dt><strong>Parameters</strong></dt>
<dd><ul class="breatheparameterlist first last simple">
<li><code class="docutils literal notranslate"><span class="pre">vm</span></code>: the pointer that points to VM data structure </li>
<li><code class="docutils literal notranslate"><span class="pre">pml4_page</span></code>: The physical address of The EPTP </li>
<li><code class="docutils literal notranslate"><span class="pre">gpa</span></code>: The specified start guest physical address of guest physical memory region whoes mapping needs to be deleted </li>
<li><code class="docutils literal notranslate"><span class="pre">size</span></code>: The size of guest physical memory region</li>
</ul>
</dd>
</dl>
</p>
</dd></dl>

<dl class="function">
<dt id="_CPPv313ept_mr_modifyP7acrn_vmP8uint64_t8uint64_t8uint64_t8uint64_t8uint64_t">
<span id="_CPPv213ept_mr_modifyP7acrn_vmP8uint64_t8uint64_t8uint64_t8uint64_t8uint64_t"></span><span id="ept_mr_modify__acrn_vmP.uint64_tP.uint64_t.uint64_t.uint64_t.uint64_t"></span><span class="target" id="group__acrn__mem_ga6211bc050f39b65bec9e3bba3a39df8e_1ga6211bc050f39b65bec9e3bba3a39df8e"></span>void <code class="descname">ept_mr_modify</code><span class="sig-paren">(</span><em class="property">struct</em> acrn_vm *<em>vm</em>, uint64_t *<em>pml4_page</em>, uint64_t <em>gpa</em>, uint64_t <em>size</em>, uint64_t <em>prot_set</em>, uint64_t <em>prot_clr</em><span class="sig-paren">)</span><a class="headerlink" href="#_CPPv313ept_mr_modifyP7acrn_vmP8uint64_t8uint64_t8uint64_t8uint64_t8uint64_t" title="Permalink to this definition">¶</a><br /></dt>
<dd><p>Guest-physical memory page access right or memory type updating. </p>
<p><dl class="docutils">
<dt><strong>Return</strong></dt>
<dd>None </dd>
<dt><strong>Parameters</strong></dt>
<dd><ul class="breatheparameterlist first last simple">
<li><code class="docutils literal notranslate"><span class="pre">vm</span></code>: the pointer that points to VM data structure </li>
<li><code class="docutils literal notranslate"><span class="pre">pml4_page</span></code>: The physical address of The EPTP </li>
<li><code class="docutils literal notranslate"><span class="pre">gpa</span></code>: The specified start guest physical address of guest physical memory region whoes mapping needs to be updated </li>
<li><code class="docutils literal notranslate"><span class="pre">size</span></code>: The size of guest physical memory region </li>
<li><code class="docutils literal notranslate"><span class="pre">prot_set</span></code>: The specified memory access right and memory type that will be set </li>
<li><code class="docutils literal notranslate"><span class="pre">prot_clr</span></code>: The specified memory access right and memory type that will be cleared</li>
</ul>
</dd>
</dl>
</p>
</dd></dl>

<dl class="function">
<dt id="_CPPv311destroy_eptP7acrn_vm">
<span id="_CPPv211destroy_eptP7acrn_vm"></span><span id="destroy_ept__acrn_vmP"></span><span class="target" id="group__acrn__mem_ga2df86e77ed6bcb68cd35eaea4f00b0af_1ga2df86e77ed6bcb68cd35eaea4f00b0af"></span>void <code class="descname">destroy_ept</code><span class="sig-paren">(</span><em class="property">struct</em> acrn_vm *<em>vm</em><span class="sig-paren">)</span><a class="headerlink" href="#_CPPv311destroy_eptP7acrn_vm" title="Permalink to this definition">¶</a><br /></dt>
<dd><p>EPT page tables destroy. </p>
<p><dl class="docutils">
<dt><strong>Return</strong></dt>
<dd>None </dd>
<dt><strong>Parameters</strong></dt>
<dd><ul class="breatheparameterlist first last simple">
<li><code class="docutils literal notranslate"><span class="pre">vm</span></code>: the pointer that points to VM data structure</li>
</ul>
</dd>
</dl>
</p>
</dd></dl>

<dl class="function">
<dt id="_CPPv36inveptPK9acrn_vcpu">
<span id="_CPPv26inveptPK9acrn_vcpu"></span><span id="invept__acrn_vcpuCP"></span><span class="target" id="group__acrn__mem_ga67b5d682943ca53f9fda9b867f2349ae_1ga67b5d682943ca53f9fda9b867f2349ae"></span>void <code class="descname">invept</code><span class="sig-paren">(</span><em class="property">const</em> <em class="property">struct</em> acrn_vcpu *<em>vcpu</em><span class="sig-paren">)</span><a class="headerlink" href="#_CPPv36inveptPK9acrn_vcpu" title="Permalink to this definition">¶</a><br /></dt>
<dd><p>Guest-physical mappings and combined mappings invalidation. </p>
<p><dl class="docutils">
<dt><strong>Return</strong></dt>
<dd>None </dd>
<dt><strong>Parameters</strong></dt>
<dd><ul class="breatheparameterlist first last simple">
<li><code class="docutils literal notranslate"><span class="pre">vcpu</span></code>: the pointer that points the vcpu data structure</li>
</ul>
</dd>
</dl>
</p>
</dd></dl>

<dl class="function">
<dt id="_CPPv328ept_violation_vmexit_handlerP9acrn_vcpu">
<span id="_CPPv228ept_violation_vmexit_handlerP9acrn_vcpu"></span><span id="ept_violation_vmexit_handler__acrn_vcpuP"></span><span class="target" id="group__acrn__mem_ga968b723ea881ad223badd1d8633fe6e3_1ga968b723ea881ad223badd1d8633fe6e3"></span>int32_t <code class="descname">ept_violation_vmexit_handler</code><span class="sig-paren">(</span><em class="property">struct</em> acrn_vcpu *<em>vcpu</em><span class="sig-paren">)</span><a class="headerlink" href="#_CPPv328ept_violation_vmexit_handlerP9acrn_vcpu" title="Permalink to this definition">¶</a><br /></dt>
<dd><p>EPT violation handling. </p>
<p><dl class="docutils">
<dt><strong>Parameters</strong></dt>
<dd><ul class="breatheparameterlist first last simple">
<li><code class="docutils literal notranslate"><span class="pre">vcpu</span></code>: the pointer that points to vcpu data structure</li>
</ul>
</dd>
<dt><strong>Return Value</strong></dt>
<dd><ul class="breatheparameterlist first last simple">
<li><code class="docutils literal notranslate"><span class="pre">-EINVAL</span></code>: fail to handle the EPT violation </li>
<li><code class="docutils literal notranslate"><span class="pre">0</span></code>: Success to handle the EPT violation </li>
</ul>
</dd>
</dl>
</p>
</dd></dl>

<dl class="function">
<dt id="_CPPv328ept_misconfig_vmexit_handlerP9acrn_vcpu">
<span id="_CPPv228ept_misconfig_vmexit_handlerP9acrn_vcpu"></span><span id="ept_misconfig_vmexit_handler__acrn_vcpuP"></span><span class="target" id="group__acrn__mem_gaaef31925fc86072935ac1f91135a4c5d_1gaaef31925fc86072935ac1f91135a4c5d"></span>int32_t <code class="descname">ept_misconfig_vmexit_handler</code><span class="sig-paren">(</span><em class="property">struct</em> acrn_vcpu *<em>vcpu</em><span class="sig-paren">)</span><a class="headerlink" href="#_CPPv328ept_misconfig_vmexit_handlerP9acrn_vcpu" title="Permalink to this definition">¶</a><br /></dt>
<dd><p>EPT misconfiguration handling. </p>
<p><dl class="docutils">
<dt><strong>Parameters</strong></dt>
<dd><ul class="breatheparameterlist first last simple">
<li><code class="docutils literal notranslate"><span class="pre">vcpu</span></code>: the pointer that points to vcpu data structure</li>
</ul>
</dd>
<dt><strong>Return Value</strong></dt>
<dd><ul class="breatheparameterlist first last simple">
<li><code class="docutils literal notranslate"><span class="pre">-EINVAL</span></code>: fail to handle the EPT misconfig </li>
<li><code class="docutils literal notranslate"><span class="pre">0</span></code>: Success to handle the EPT misconfig </li>
</ul>
</dd>
</dl>
</p>
</dd></dl>

</div>
<div class="section" id="id5">
<h4>Virtual MTRR<a class="headerlink" href="#id5" title="Permalink to this headline">¶</a></h4>
<dl class="function">
<dt id="_CPPv310init_vmtrrP9acrn_vcpu">
<span id="_CPPv210init_vmtrrP9acrn_vcpu"></span><span id="init_vmtrr__acrn_vcpuP"></span><span class="target" id="group__acrn__mem_ga635875e8f1671d8992f7b3056ef95a57_1ga635875e8f1671d8992f7b3056ef95a57"></span>void <code class="descname">init_vmtrr</code><span class="sig-paren">(</span><em class="property">struct</em> acrn_vcpu *<em>vcpu</em><span class="sig-paren">)</span><a class="headerlink" href="#_CPPv310init_vmtrrP9acrn_vcpu" title="Permalink to this definition">¶</a><br /></dt>
<dd><p>Virtual MTRR initialization. </p>
<p><dl class="docutils">
<dt><strong>Return</strong></dt>
<dd>None </dd>
<dt><strong>Parameters</strong></dt>
<dd><ul class="breatheparameterlist first last simple">
<li><code class="docutils literal notranslate"><span class="pre">vcpu</span></code>: The pointer that points VCPU data structure</li>
</ul>
</dd>
</dl>
</p>
</dd></dl>

<dl class="function">
<dt id="_CPPv311write_vmtrrP9acrn_vcpu8uint32_t8uint64_t">
<span id="_CPPv211write_vmtrrP9acrn_vcpu8uint32_t8uint64_t"></span><span id="write_vmtrr__acrn_vcpuP.uint32_t.uint64_t"></span><span class="target" id="group__acrn__mem_gab4d55d5cb7fc588801f2dcfdd248d471_1gab4d55d5cb7fc588801f2dcfdd248d471"></span>void <code class="descname">write_vmtrr</code><span class="sig-paren">(</span><em class="property">struct</em> acrn_vcpu *<em>vcpu</em>, uint32_t <em>msr</em>, uint64_t <em>value</em><span class="sig-paren">)</span><a class="headerlink" href="#_CPPv311write_vmtrrP9acrn_vcpu8uint32_t8uint64_t" title="Permalink to this definition">¶</a><br /></dt>
<dd><p>Virtual MTRR MSR write. </p>
<p><dl class="docutils">
<dt><strong>Return</strong></dt>
<dd>None </dd>
<dt><strong>Parameters</strong></dt>
<dd><ul class="breatheparameterlist first last simple">
<li><code class="docutils literal notranslate"><span class="pre">vcpu</span></code>: The pointer that points VCPU data structure </li>
<li><code class="docutils literal notranslate"><span class="pre">msr</span></code>: Virtual MTRR MSR Address </li>
<li><code class="docutils literal notranslate"><span class="pre">value</span></code>: The value that will be writen into virtual MTRR MSR</li>
</ul>
</dd>
</dl>
</p>
</dd></dl>

<dl class="function">
<dt id="_CPPv310read_vmtrrPK9acrn_vcpu8uint32_t">
<span id="_CPPv210read_vmtrrPK9acrn_vcpu8uint32_t"></span><span id="read_vmtrr__acrn_vcpuCP.uint32_t"></span><span class="target" id="group__acrn__mem_ga64b08edce2649aecf61a13abae5b4b26_1ga64b08edce2649aecf61a13abae5b4b26"></span>uint64_t <code class="descname">read_vmtrr</code><span class="sig-paren">(</span><em class="property">const</em> <em class="property">struct</em> acrn_vcpu *<em>vcpu</em>, uint32_t <em>msr</em><span class="sig-paren">)</span><a class="headerlink" href="#_CPPv310read_vmtrrPK9acrn_vcpu8uint32_t" title="Permalink to this definition">¶</a><br /></dt>
<dd><p>Virtual MTRR MSR read. </p>
<p><dl class="docutils">
<dt><strong>Return</strong></dt>
<dd>The specified virtual MTRR MSR value </dd>
<dt><strong>Parameters</strong></dt>
<dd><ul class="breatheparameterlist first last simple">
<li><code class="docutils literal notranslate"><span class="pre">vcpu</span></code>: The pointer that points VCPU data structure </li>
<li><code class="docutils literal notranslate"><span class="pre">msr</span></code>: Virtual MTRR MSR Address</li>
</ul>
</dd>
</dl>
</p>
</dd></dl>

</div>
<div class="section" id="vpid">
<h4>VPID<a class="headerlink" href="#vpid" title="Permalink to this headline">¶</a></h4>
<dl class="function">
<dt id="_CPPv313allocate_vpidv">
<span id="_CPPv213allocate_vpidv"></span><span id="allocate_vpid__void"></span><span class="target" id="group__acrn__mem_gade89b29d886fa5eaaa08878ab8b0e2a0_1gade89b29d886fa5eaaa08878ab8b0e2a0"></span>uint16_t <code class="descname">allocate_vpid</code><span class="sig-paren">(</span>void<span class="sig-paren">)</span><a class="headerlink" href="#_CPPv313allocate_vpidv" title="Permalink to this definition">¶</a><br /></dt>
<dd><p>VPID allocation. </p>
<p><dl class="docutils">
<dt><strong>Return Value</strong></dt>
<dd><ul class="breatheparameterlist first last simple">
<li><code class="docutils literal notranslate"><span class="pre">0</span></code>: VPID overflow </li>
<li><code class="docutils literal notranslate"><span class="pre">&gt;0</span></code>: the valid VPID </li>
</ul>
</dd>
</dl>
</p>
</dd></dl>

<dl class="function">
<dt id="_CPPv317flush_vpid_single8uint16_t">
<span id="_CPPv217flush_vpid_single8uint16_t"></span><span id="flush_vpid_single__uint16_t"></span><span class="target" id="group__acrn__mem_gacfc5041fe000c3cc78e1063a1f51207a_1gacfc5041fe000c3cc78e1063a1f51207a"></span>void <code class="descname">flush_vpid_single</code><span class="sig-paren">(</span>uint16_t <em>vpid</em><span class="sig-paren">)</span><a class="headerlink" href="#_CPPv317flush_vpid_single8uint16_t" title="Permalink to this definition">¶</a><br /></dt>
<dd><p>Specified signle VPID flush. </p>
<p><dl class="docutils">
<dt><strong>Return</strong></dt>
<dd>None </dd>
<dt><strong>Parameters</strong></dt>
<dd><ul class="breatheparameterlist first last simple">
<li><code class="docutils literal notranslate"><span class="pre">vpid</span></code>: the specified VPID</li>
</ul>
</dd>
</dl>
</p>
</dd></dl>

<dl class="function">
<dt id="_CPPv317flush_vpid_globalv">
<span id="_CPPv217flush_vpid_globalv"></span><span id="flush_vpid_global__void"></span><span class="target" id="group__acrn__mem_ga5c02afec6c9e9ecbdda3ff5b93f4b579_1ga5c02afec6c9e9ecbdda3ff5b93f4b579"></span>void <code class="descname">flush_vpid_global</code><span class="sig-paren">(</span>void<span class="sig-paren">)</span><a class="headerlink" href="#_CPPv317flush_vpid_globalv" title="Permalink to this definition">¶</a><br /></dt>
<dd><p>All VPID flush. </p>
<p><dl class="docutils">
<dt><strong>Return</strong></dt>
<dd>None </dd>
</dl>
</p>
</dd></dl>

</div>
</div>
</div>
<div class="section" id="service-os-memory-management">
<h2>Service OS Memory Management<a class="headerlink" href="#service-os-memory-management" title="Permalink to this headline">¶</a></h2>
<p>After the ACRN hypervisor starts, it creates the Service OS as its first
VM. The Service OS runs all the native device drivers, manage the
hardware devices, and provides I/O mediation to guest VMs. The Service
OS is in charge of the memory allocation for Guest VMs as well.</p>
<p>ACRN hypervisor passes the whole system memory access (except its own
part) to the Service OS. The Service OS must be able to access all of
the system memory except the hypervisor part.</p>
<div class="section" id="guest-physical-memory-layout-e820">
<h3>Guest Physical Memory Layout - E820<a class="headerlink" href="#guest-physical-memory-layout-e820" title="Permalink to this headline">¶</a></h3>
<p>The ACRN hypervisor passes the original E820 table to the Service OS
after filtering out its own part. So from Service OS’s view, it sees
almost all the system memory as shown here:</p>
<div class="figure align-center" id="sos-mem-layout">
<a class="reference internal image-reference" href="../../_images/mem-image3.png"><img alt="../../_images/mem-image3.png" src="../../_images/mem-image3.png" style="width: 900px;" /></a>
<p class="caption"><span class="caption-number">Figure 41 </span><span class="caption-text">SOS Physical Memory Layout</span></p>
</div>
</div>
<div class="section" id="host-to-guest-mapping">
<h3>Host to Guest Mapping<a class="headerlink" href="#host-to-guest-mapping" title="Permalink to this headline">¶</a></h3>
<p>ACRN hypervisor creates Service OS’s host (HPA) to guest (GPA) mapping
(EPT mapping) through the function <code class="docutils literal notranslate"><span class="pre">prepare_vm0_memmap_and_e820()</span></code>
when it creates the SOS VM. It follows these rules:</p>
<ul class="simple">
<li>Identical mapping</li>
<li>Map all memory range with UNCACHED type</li>
<li>Remap RAM entries in E820 (revised) with WRITE-BACK type</li>
<li>Unmap ACRN hypervisor memory range</li>
<li>Unmap ACRN hypervisor emulated vLAPIC/vIOAPIC MMIO range</li>
</ul>
<p>The host to guest mapping is static for the Service OS; it will not
change after the Service OS begins running. Each native device driver
can access its MMIO through this static mapping. EPT violation is only
serving for vLAPIC/vIOAPIC’s emulation in the hypervisor for Service OS
VM.</p>
</div>
</div>
<div class="section" id="trusty">
<h2>Trusty<a class="headerlink" href="#trusty" title="Permalink to this headline">¶</a></h2>
<p>For an Android User OS, there is a secure world named trusty world
support, whose memory must be secured by the ACRN hypervisor and
must not be accessible by SOS and UOS normal world.</p>
<div class="figure align-center" id="id6">
<img alt="../../_images/mem-image18.png" src="../../_images/mem-image18.png" />
<p class="caption"><span class="caption-number">Figure 42 </span><span class="caption-text">UOS Physical Memory Layout with Trusty</span></p>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2018, Project ACRN.
      Last updated on Dec 21, 2018.

    </p>
  </div> 

</footer>

        </div>
      </div>

    </section>

  </div>
  
  <div class="rst-versions" data-toggle="rst-versions" role="note" aria-label="versions">
    <span class="rst-current-version" data-toggle="rst-current-version">
      <span class="fa fa-book"> Project ACRN</span>
      v: latest
      <span class="fa fa-caret-down"></span>
    </span>
    <div class="rst-other-versions">
      <dl>
        <dt>Versions</dt>
        
          <dd><a href="/latest/">latest</a></dd>
        
          <dd><a href="/0.4/">0.4</a></dd>
        
          <dd><a href="/0.3/">0.3</a></dd>
        
          <dd><a href="/0.2/">0.2</a></dd>
        
          <dd><a href="/0.1/">0.1</a></dd>
        
      </dl>
      <dl>
        <dt>On projectacrn.org</dt>
          <dd>
            <a href="https://www.projectacrn.org/">Project Home</a>
          </dd>
          <dd>
            <a href="https://github.com/projectacrn/acrn-hypervisor/wiki">Wiki</a>
          </dd>
      </dl>
    </div>
  </div>

  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../',
            VERSION:'v 0.5-unstable',
            LANGUAGE:'None',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../_static/doctools.js"></script>
      <script type="text/javascript" src="../../_static/acrn-custom.js"></script>

  

  <script type="text/javascript" src="../../_static/js/theme.js"></script>

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>