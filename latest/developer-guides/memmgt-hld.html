

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Memory Management high-level design &mdash; Project ACRN™ v 0.2-unstable documentation</title>
  

  
  
    <link rel="shortcut icon" href="../_static/ACRN-favicon-32x32.png"/>
  
  
  

  

  
  
    

  

  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../_static/acrn-custom.css" type="text/css" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Network Virtualization" href="network-virt-hld.html" />
    <link rel="prev" title="Interrupt Management high-level design" href="interrupt-hld.html" /> 

  
  <script src="../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../index.html" class="icon icon-home"> Project ACRN™
          

          
            
            <img src="../_static/ACRN_Logo_200w.png" class="logo" alt="Logo"/>
          
          </a>

          
            
            
              <div class="version">
                latest
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../introduction/index.html">Introduction to Project ACRN</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../introduction/index.html#automotive-use-case-example">Automotive Use Case Example</a></li>
<li class="toctree-l2"><a class="reference internal" href="../introduction/index.html#licensing">Licensing</a></li>
<li class="toctree-l2"><a class="reference internal" href="../introduction/index.html#acrn-device-model-service-os-and-user-os">ACRN Device Model, Service OS, and User OS</a></li>
<li class="toctree-l2"><a class="reference internal" href="../introduction/index.html#boot-sequence">Boot Sequence</a></li>
<li class="toctree-l2"><a class="reference internal" href="../introduction/index.html#acrn-hypervisor-architecture">ACRN Hypervisor Architecture</a></li>
<li class="toctree-l2"><a class="reference internal" href="../introduction/index.html#acrn-device-model-architecture">ACRN Device Model Architecture</a></li>
<li class="toctree-l2"><a class="reference internal" href="../introduction/index.html#device-pass-through">Device pass through</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../introduction/index.html#hardware-support-for-device-passthrough">Hardware support for device passthrough</a></li>
<li class="toctree-l3"><a class="reference internal" href="../introduction/index.html#hypervisor-support-for-device-passthrough">Hypervisor support for device passthrough</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../introduction/index.html#acrn-i-o-mediator">ACRN I/O mediator</a></li>
<li class="toctree-l2"><a class="reference internal" href="../introduction/index.html#virtio-framework-architecture">Virtio framework architecture</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../getting-started/index.html">Getting Started Guides</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../getting-started/apl-nuc.html">Getting started guide for Intel NUC</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../getting-started/apl-nuc.html#hardware-setup">Hardware setup</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../getting-started/apl-nuc.html#firmware-update-on-the-nuc">Firmware update on the NUC</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../getting-started/apl-nuc.html#software-setup">Software setup</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../getting-started/apl-nuc.html#set-up-a-clear-linux-operating-system">Set up a Clear Linux Operating System</a></li>
<li class="toctree-l4"><a class="reference internal" href="../getting-started/apl-nuc.html#add-the-acrn-hypervisor-to-the-efi-partition">Add the ACRN hypervisor to the EFI Partition</a></li>
<li class="toctree-l4"><a class="reference internal" href="../getting-started/apl-nuc.html#acrn-network-bridge">ACRN Network Bridge</a></li>
<li class="toctree-l4"><a class="reference internal" href="../getting-started/apl-nuc.html#set-up-reference-uos">Set up Reference UOS</a></li>
<li class="toctree-l4"><a class="reference internal" href="../getting-started/apl-nuc.html#device-manager-memory-allocation-mechanism">Device Manager memory allocation mechanism</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../getting-started/apl-nuc.html#build-acrn-from-source">Build ACRN from Source</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../getting-started/apl-nuc.html#install-build-tools-and-dependencies">Install build tools and dependencies</a></li>
<li class="toctree-l4"><a class="reference internal" href="../getting-started/apl-nuc.html#build-the-hypervisor-device-model-and-tools">Build the hypervisor, device model and tools</a></li>
<li class="toctree-l4"><a class="reference internal" href="../getting-started/apl-nuc.html#generate-the-hypervisor-configurations">Generate the hypervisor configurations</a></li>
<li class="toctree-l4"><a class="reference internal" href="../getting-started/apl-nuc.html#modify-the-hypervisor-configurations">Modify the hypervisor configurations</a></li>
<li class="toctree-l4"><a class="reference internal" href="../getting-started/apl-nuc.html#create-a-new-default-configuration">Create a new default configuration</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../getting-started/up2.html">Getting started guide for UP2 board</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../getting-started/up2.html#hardware-setup">Hardware setup</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../getting-started/up2.html#connecting-to-the-serial-port">Connecting to the serial port</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../getting-started/up2.html#software-setup">Software setup</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../getting-started/up2.html#up2-serial-port-setting">UP2 serial port setting</a></li>
<li class="toctree-l4"><a class="reference internal" href="../getting-started/up2.html#up2-block-device">UP2 block device</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../getting-started/up2.html#running-the-hypervisor">Running the hypervisor</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../hardware.html">Supported Hardware</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../hardware.html#intel-apollo-lake-nuc">Intel Apollo Lake NUC</a></li>
<li class="toctree-l2"><a class="reference internal" href="../hardware.html#up-squared-board">UP Squared board</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../user-guides/index.html">User Guides</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../user-guides/acrn-shell.html">ACRN Shell Commands</a></li>
<li class="toctree-l2"><a class="reference internal" href="../user-guides/tools.html">Tools</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../tools/acrn-crashlog/README.html">ACRN-Crashlog</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../tools/acrn-crashlog/README.html#introduction">Introduction</a></li>
<li class="toctree-l4"><a class="reference internal" href="../tools/acrn-crashlog/README.html#building">Building</a></li>
<li class="toctree-l4"><a class="reference internal" href="../tools/acrn-crashlog/README.html#installing">Installing</a></li>
<li class="toctree-l4"><a class="reference internal" href="../tools/acrn-crashlog/README.html#usage">Usage</a></li>
<li class="toctree-l4"><a class="reference internal" href="../tools/acrn-crashlog/README.html#source-code">Source Code</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../tools/acrn-crashlog/acrnprobe/README.html">acrnprobe</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../tools/acrn-crashlog/acrnprobe/README.html#description">Description</a></li>
<li class="toctree-l4"><a class="reference internal" href="../tools/acrn-crashlog/acrnprobe/README.html#usage">Usage</a></li>
<li class="toctree-l4"><a class="reference internal" href="../tools/acrn-crashlog/acrnprobe/README.html#architecture">Architecture</a></li>
<li class="toctree-l4"><a class="reference internal" href="../tools/acrn-crashlog/acrnprobe/README.html#source-files">Source files</a></li>
<li class="toctree-l4"><a class="reference internal" href="../tools/acrn-crashlog/acrnprobe/README.html#configuration-files">Configuration files</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../tools/acrn-crashlog/acrnprobe/conf.html">acrnprobe Configuration</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../tools/acrn-crashlog/acrnprobe/conf.html#description">Description</a></li>
<li class="toctree-l4"><a class="reference internal" href="../tools/acrn-crashlog/acrnprobe/conf.html#layout">Layout</a></li>
<li class="toctree-l4"><a class="reference internal" href="../tools/acrn-crashlog/acrnprobe/conf.html#properties-of-group-members">Properties of group members</a></li>
<li class="toctree-l4"><a class="reference internal" href="../tools/acrn-crashlog/acrnprobe/conf.html#crash-tree-in-acrnprobe">Crash tree in acrnprobe</a></li>
<li class="toctree-l4"><a class="reference internal" href="../tools/acrn-crashlog/acrnprobe/conf.html#sections">Sections</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../tools/acrn-crashlog/usercrash/README.html">usercrash</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../tools/acrn-crashlog/usercrash/README.html#description">Description</a></li>
<li class="toctree-l4"><a class="reference internal" href="../tools/acrn-crashlog/usercrash/README.html#design">Design</a></li>
<li class="toctree-l4"><a class="reference internal" href="../tools/acrn-crashlog/usercrash/README.html#usage">Usage</a></li>
<li class="toctree-l4"><a class="reference internal" href="../tools/acrn-crashlog/usercrash/README.html#souce-code">Souce Code</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../tools/acrn-manager/README.html">acrnctl and acrnd</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../tools/acrn-manager/README.html#description">Description</a></li>
<li class="toctree-l4"><a class="reference internal" href="../tools/acrn-manager/README.html#usage">Usage</a></li>
<li class="toctree-l4"><a class="reference internal" href="../tools/acrn-manager/README.html#acrnd">acrnd</a></li>
<li class="toctree-l4"><a class="reference internal" href="../tools/acrn-manager/README.html#build-and-install">Build and Install</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../tools/acrnlog/README.html">acrnlog</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../tools/acrnlog/README.html#description">Description</a></li>
<li class="toctree-l4"><a class="reference internal" href="../tools/acrnlog/README.html#usage">Usage</a></li>
<li class="toctree-l4"><a class="reference internal" href="../tools/acrnlog/README.html#build-and-install">Build and Install</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../tools/acrntrace/README.html">acrntrace</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../tools/acrntrace/README.html#description">Description</a></li>
<li class="toctree-l4"><a class="reference internal" href="../tools/acrntrace/README.html#usage">Usage</a></li>
<li class="toctree-l4"><a class="reference internal" href="../tools/acrntrace/README.html#build-and-install">Build and Install</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Developer Guides</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="primer.html">Developer Primer</a><ul>
<li class="toctree-l3"><a class="reference internal" href="primer.html#source-tree-structure">Source Tree Structure</a><ul>
<li class="toctree-l4"><a class="reference internal" href="primer.html#acrn-hypervisor-source-tree">ACRN hypervisor source tree</a></li>
<li class="toctree-l4"><a class="reference internal" href="primer.html#acrn-device-model-source-tree">ACRN Device Model source tree</a></li>
<li class="toctree-l4"><a class="reference internal" href="primer.html#acrn-tools-source-tree">ACRN Tools source tree</a></li>
<li class="toctree-l4"><a class="reference internal" href="primer.html#acrn-documentation-source-tree">ACRN documentation source tree</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="primer.html#cpu-virtualization">CPU virtualization</a><ul>
<li class="toctree-l4"><a class="reference internal" href="primer.html#host-gdt">Host GDT</a></li>
<li class="toctree-l4"><a class="reference internal" href="primer.html#host-idt">Host IDT</a></li>
<li class="toctree-l4"><a class="reference internal" href="primer.html#guest-smp-booting">Guest SMP Booting</a></li>
<li class="toctree-l4"><a class="reference internal" href="primer.html#vmx-configuration">VMX configuration</a></li>
<li class="toctree-l4"><a class="reference internal" href="primer.html#cpuid-and-guest-tsc-calibration">CPUID and Guest TSC calibration</a></li>
<li class="toctree-l4"><a class="reference internal" href="primer.html#rdtsc-rdtscp">RDTSC/RDTSCP</a></li>
<li class="toctree-l4"><a class="reference internal" href="primer.html#cr-register-virtualization">CR Register virtualization</a></li>
<li class="toctree-l4"><a class="reference internal" href="primer.html#msr-bitmap">MSR BITMAP</a></li>
<li class="toctree-l4"><a class="reference internal" href="primer.html#i-o-bitmap">I/O BITMAP</a></li>
<li class="toctree-l4"><a class="reference internal" href="primer.html#exceptions">Exceptions</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="primer.html#memory-virtualization">Memory virtualization</a><ul>
<li class="toctree-l4"><a class="reference internal" href="primer.html#physical-memory-layout">Physical Memory Layout</a></li>
<li class="toctree-l4"><a class="reference internal" href="primer.html#pv-mmu-memory-mapping-in-the-hypervisor">PV (MMU) Memory Mapping in the Hypervisor</a></li>
<li class="toctree-l4"><a class="reference internal" href="primer.html#pv-mmu-memory-mapping-in-vms">PV (MMU) Memory Mapping in VMs</a></li>
<li class="toctree-l4"><a class="reference internal" href="primer.html#host-guest-ept-memory-mapping">Host-Guest (EPT) Memory Mapping</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="primer.html#graphic-mediation">Graphic mediation</a></li>
<li class="toctree-l3"><a class="reference internal" href="primer.html#i-o-emulation">I/O emulation</a><ul>
<li class="toctree-l4"><a class="reference internal" href="primer.html#device-assignment-management">Device Assignment Management</a></li>
<li class="toctree-l4"><a class="reference internal" href="primer.html#pio-mmio-trap-flow">PIO/MMIO trap Flow</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="primer.html#virtual-interrupt">Virtual interrupt</a><ul>
<li class="toctree-l4"><a class="reference internal" href="primer.html#virtual-lapic">Virtual LAPIC</a></li>
<li class="toctree-l4"><a class="reference internal" href="primer.html#virtual-ioapic">Virtual IOAPIC</a></li>
<li class="toctree-l4"><a class="reference internal" href="primer.html#virtual-pic">Virtual PIC</a></li>
<li class="toctree-l4"><a class="reference internal" href="primer.html#virtual-interrupt-injection">Virtual Interrupt Injection</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="primer.html#vt-x-and-vt-d">VT-x and VT-d</a></li>
<li class="toctree-l3"><a class="reference internal" href="primer.html#hypercall">Hypercall</a></li>
<li class="toctree-l3"><a class="reference internal" href="primer.html#device-emulation">Device emulation</a></li>
<li class="toctree-l3"><a class="reference internal" href="primer.html#virtio-devices">Virtio Devices</a><ul>
<li class="toctree-l4"><a class="reference internal" href="primer.html#virtio-rnd">Virtio-rnd</a></li>
<li class="toctree-l4"><a class="reference internal" href="primer.html#virtio-blk">Virtio-blk</a></li>
<li class="toctree-l4"><a class="reference internal" href="primer.html#virtio-net">Virtio-net</a></li>
<li class="toctree-l4"><a class="reference internal" href="primer.html#virtio-console">Virtio-console</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../api/index.html">API Documentation</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../api/hypercall_api.html">Hypercall APIs</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/devicemodel_api.html">Device Model APIs</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/GVT-g_api.html">ACRN GVT-g APIs</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/GVT-g_api.html#core-driver-infrastructure">Core Driver Infrastructure</a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/GVT-g_api.html#vhm-apis-called-from-acrngt">VHM APIs called from AcrnGT</a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/GVT-g_api.html#acrngt-mediated-pass-through-mpt-interface">AcrnGT mediated pass-through (MPT) interface</a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/GVT-g_api.html#gvt-g-intel-gvt-ops-interface">GVT-g intel_gvt_ops interface</a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/GVT-g_api.html#acrngt-sysfs-interface">AcrnGT sysfs interface</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../reference/kconfig/index.html">Configuration Symbol Reference</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../reference/kconfig/index.html#introduction">Introduction</a></li>
<li class="toctree-l3"><a class="reference internal" href="../reference/kconfig/index.html#supported-options">Supported Options</a></li>
</ul>
</li>
<li class="toctree-l2 current"><a class="reference internal" href="index.html#high-level-design-guides">High-Level Design Guides</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="ACPI-virt-hld.html">ACPI Virtualization high-level design</a><ul>
<li class="toctree-l4"><a class="reference internal" href="ACPI-virt-hld.html#acpi-introduction">ACPI introduction</a></li>
<li class="toctree-l4"><a class="reference internal" href="ACPI-virt-hld.html#acpi-virtualization">ACPI virtualization</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="APL_GVT-g-hld.html">GVT-g high-level design</a><ul>
<li class="toctree-l4"><a class="reference internal" href="APL_GVT-g-hld.html#introduction">Introduction</a></li>
<li class="toctree-l4"><a class="reference internal" href="APL_GVT-g-hld.html#background">Background</a></li>
<li class="toctree-l4"><a class="reference internal" href="APL_GVT-g-hld.html#mediated-pass-through">Mediated Pass-Through</a></li>
<li class="toctree-l4"><a class="reference internal" href="APL_GVT-g-hld.html#high-level-architecture">High Level Architecture</a></li>
<li class="toctree-l4"><a class="reference internal" href="APL_GVT-g-hld.html#key-techniques">Key Techniques</a></li>
<li class="toctree-l4"><a class="reference internal" href="APL_GVT-g-hld.html#acrngt">AcrnGT</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="GVT-g-porting.html">GVT-g Enabling and Porting Guide</a><ul>
<li class="toctree-l4"><a class="reference internal" href="GVT-g-porting.html#introduction">Introduction</a></li>
<li class="toctree-l4"><a class="reference internal" href="GVT-g-porting.html#purpose-of-this-document">Purpose of this document</a></li>
<li class="toctree-l4"><a class="reference internal" href="GVT-g-porting.html#overall-components">Overall Components</a></li>
<li class="toctree-l4"><a class="reference internal" href="GVT-g-porting.html#core-scenario-interaction-sequences">Core scenario interaction sequences</a></li>
<li class="toctree-l4"><a class="reference internal" href="GVT-g-porting.html#api-details">API details</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="interrupt-hld.html">Interrupt Management high-level design</a><ul>
<li class="toctree-l4"><a class="reference internal" href="interrupt-hld.html#overview">Overview</a></li>
<li class="toctree-l4"><a class="reference internal" href="interrupt-hld.html#hypervisor-physical-interrupt-management">Hypervisor Physical Interrupt Management</a></li>
<li class="toctree-l4"><a class="reference internal" href="interrupt-hld.html#guest-virtual-interrupt-management">Guest Virtual Interrupt Management</a></li>
</ul>
</li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">Memory Management high-level design</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#overview">Overview</a></li>
<li class="toctree-l4"><a class="reference internal" href="#hypervisor-memory-management">Hypervisor Memory Management</a></li>
<li class="toctree-l4"><a class="reference internal" href="#service-os-memory-management">Service OS Memory Management</a></li>
<li class="toctree-l4"><a class="reference internal" href="#user-os-memory-management">User OS Memory Management</a></li>
<li class="toctree-l4"><a class="reference internal" href="#memory-interaction">Memory Interaction</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="network-virt-hld.html">Network Virtualization</a><ul>
<li class="toctree-l4"><a class="reference internal" href="network-virt-hld.html#introduction">Introduction</a></li>
<li class="toctree-l4"><a class="reference internal" href="network-virt-hld.html#supported-features-notes">Supported Features Notes</a></li>
<li class="toctree-l4"><a class="reference internal" href="network-virt-hld.html#acrn-virtio-network-calling-stack">ACRN Virtio-Network Calling Stack</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="security-hld.html">Security high-level design</a><ul>
<li class="toctree-l4"><a class="reference internal" href="security-hld.html#introduction">Introduction</a></li>
<li class="toctree-l4"><a class="reference internal" href="security-hld.html#background">Background</a></li>
<li class="toctree-l4"><a class="reference internal" href="security-hld.html#acrn-high-level-security-architecture">ACRN High-Level Security Architecture</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="uart-virtualization.html">UART Virtualization</a><ul>
<li class="toctree-l4"><a class="reference internal" href="uart-virtualization.html#architecture">Architecture</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="virtio-hld.html">Virtio high-level design</a><ul>
<li class="toctree-l4"><a class="reference internal" href="virtio-hld.html#virtio-device">Virtio Device</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="virtio-console.html">Virtio-Console High-Level design</a><ul>
<li class="toctree-l4"><a class="reference internal" href="virtio-console.html#console-backend-use-cases">Console Backend Use Cases</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="watchdog-hld.html">Watchdog Virtualization in Device Model</a><ul>
<li class="toctree-l4"><a class="reference internal" href="watchdog-hld.html#overview">Overview</a></li>
<li class="toctree-l4"><a class="reference internal" href="watchdog-hld.html#uos-watchdog-work-flow">UOS watchdog work flow</a></li>
<li class="toctree-l4"><a class="reference internal" href="watchdog-hld.html#implementation-in-acrn-and-how-to-use-it">Implementation in ACRN and how to use it</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="index.html#contributing-to-the-project">Contributing to the project</a><ul>
<li class="toctree-l3"><a class="reference internal" href="contribute_guidelines.html">Contribution Guidelines</a><ul>
<li class="toctree-l4"><a class="reference internal" href="contribute_guidelines.html#licensing">Licensing</a></li>
<li class="toctree-l4"><a class="reference internal" href="contribute_guidelines.html#developer-certification-of-origin-dco">Developer Certification of Origin (DCO)</a></li>
<li class="toctree-l4"><a class="reference internal" href="contribute_guidelines.html#prerequisites">Prerequisites</a></li>
<li class="toctree-l4"><a class="reference internal" href="contribute_guidelines.html#repository-layout">Repository layout</a></li>
<li class="toctree-l4"><a class="reference internal" href="contribute_guidelines.html#submitting-issues">Submitting Issues</a></li>
<li class="toctree-l4"><a class="reference internal" href="contribute_guidelines.html#contribution-tools-and-git-setup">Contribution Tools and Git Setup</a></li>
<li class="toctree-l4"><a class="reference internal" href="contribute_guidelines.html#coding-style">Coding Style</a></li>
<li class="toctree-l4"><a class="reference internal" href="contribute_guidelines.html#contribution-workflow">Contribution Workflow</a></li>
<li class="toctree-l4"><a class="reference internal" href="contribute_guidelines.html#commit-guidelines">Commit Guidelines</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="doc_guidelines.html">Documentation Guidelines</a><ul>
<li class="toctree-l4"><a class="reference internal" href="doc_guidelines.html#headings">Headings</a></li>
<li class="toctree-l4"><a class="reference internal" href="doc_guidelines.html#content-highlighting">Content Highlighting</a></li>
<li class="toctree-l4"><a class="reference internal" href="doc_guidelines.html#lists">Lists</a></li>
<li class="toctree-l4"><a class="reference internal" href="doc_guidelines.html#multi-column-lists">Multi-column lists</a></li>
<li class="toctree-l4"><a class="reference internal" href="doc_guidelines.html#file-names-and-commands">File names and Commands</a></li>
<li class="toctree-l4"><a class="reference internal" href="doc_guidelines.html#internal-cross-reference-linking">Internal Cross-Reference Linking</a></li>
<li class="toctree-l4"><a class="reference internal" href="doc_guidelines.html#non-ascii-characters">Non-ASCII Characters</a></li>
<li class="toctree-l4"><a class="reference internal" href="doc_guidelines.html#code-and-command-examples">Code and Command Examples</a></li>
<li class="toctree-l4"><a class="reference internal" href="doc_guidelines.html#tabs-spaces-and-indenting">Tabs, spaces, and indenting</a></li>
<li class="toctree-l4"><a class="reference internal" href="doc_guidelines.html#drawings">Drawings</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="graphviz.html">Drawings using graphviz</a><ul>
<li class="toctree-l4"><a class="reference internal" href="graphviz.html#simple-directed-graph">Simple directed graph</a></li>
<li class="toctree-l4"><a class="reference internal" href="graphviz.html#adding-edge-labels">Adding edge labels</a></li>
<li class="toctree-l4"><a class="reference internal" href="graphviz.html#tables">Tables</a></li>
<li class="toctree-l4"><a class="reference internal" href="graphviz.html#finite-state-machine">Finite-State Machine</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../tutorials/index.html">Tutorials</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../tutorials/docbuild.html">ACRN documentation generation</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../tutorials/docbuild.html#documentation-overview">Documentation overview</a></li>
<li class="toctree-l3"><a class="reference internal" href="../tutorials/docbuild.html#set-up-the-documentation-working-folders">Set up the documentation working folders</a></li>
<li class="toctree-l3"><a class="reference internal" href="../tutorials/docbuild.html#installing-the-documentation-tools">Installing the documentation tools</a></li>
<li class="toctree-l3"><a class="reference internal" href="../tutorials/docbuild.html#documentation-presentation-theme">Documentation presentation theme</a></li>
<li class="toctree-l3"><a class="reference internal" href="../tutorials/docbuild.html#running-the-documentation-processors">Running the documentation processors</a></li>
<li class="toctree-l3"><a class="reference internal" href="../tutorials/docbuild.html#publishing-content">Publishing content</a></li>
<li class="toctree-l3"><a class="reference internal" href="../tutorials/docbuild.html#filtering-expected-warnings">Filtering expected warnings</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../tutorials/static-ip.html">Using a static IP address</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../tutorials/static-ip.html#acrn-network-setup">ACRN Network Setup</a></li>
<li class="toctree-l3"><a class="reference internal" href="../tutorials/static-ip.html#setting-up-the-static-ip-address">Setting up the static IP address</a></li>
<li class="toctree-l3"><a class="reference internal" href="../tutorials/static-ip.html#activate-the-new-configuration">Activate the new configuration</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../tutorials/using_ubuntu_as_sos.html">Using Ubuntu as the Service OS</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../tutorials/using_ubuntu_as_sos.html#install-ubuntu-natively">Install Ubuntu (natively)</a></li>
<li class="toctree-l3"><a class="reference internal" href="../tutorials/using_ubuntu_as_sos.html#install-acrn">Install ACRN</a></li>
<li class="toctree-l3"><a class="reference internal" href="../tutorials/using_ubuntu_as_sos.html#install-the-service-os-kernel">Install the Service OS kernel</a></li>
<li class="toctree-l3"><a class="reference internal" href="../tutorials/using_ubuntu_as_sos.html#prepare-the-user-os-uos">Prepare the User OS (UOS)</a></li>
<li class="toctree-l3"><a class="reference internal" href="../tutorials/using_ubuntu_as_sos.html#start-the-user-os-uos">Start the User OS (UOS)</a></li>
<li class="toctree-l3"><a class="reference internal" href="../tutorials/using_ubuntu_as_sos.html#enabling-network-sharing">Enabling network sharing</a></li>
<li class="toctree-l3"><a class="reference internal" href="../tutorials/using_ubuntu_as_sos.html#enabling-usb-keyboard-and-mouse">Enabling USB keyboard and mouse</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../release_notes.html">Release Notes</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../release_notes_0.2.html">ACRN v0.2 (Sep 2018) DRAFT</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../release_notes_0.2.html#version-0-2-new-features">Version 0.2 new features</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../release_notes_0.2.html#vt-x-vt-d">VT-x, VT-d</a></li>
<li class="toctree-l4"><a class="reference internal" href="../release_notes_0.2.html#pic-ioapic-msi-msi-x-pci-lapic">PIC/IOAPIC/MSI/MSI-X/PCI/LAPIC</a></li>
<li class="toctree-l4"><a class="reference internal" href="../release_notes_0.2.html#ethernet">Ethernet</a></li>
<li class="toctree-l4"><a class="reference internal" href="../release_notes_0.2.html#storage-emmc">Storage (eMMC)</a></li>
<li class="toctree-l4"><a class="reference internal" href="../release_notes_0.2.html#usb-xdci">USB (xDCI)</a></li>
<li class="toctree-l4"><a class="reference internal" href="../release_notes_0.2.html#usb-mediator-xhci-and-drd">USB Mediator (xHCI and DRD)</a></li>
<li class="toctree-l4"><a class="reference internal" href="../release_notes_0.2.html#csme">CSME</a></li>
<li class="toctree-l4"><a class="reference internal" href="../release_notes_0.2.html#wifi">WiFi</a></li>
<li class="toctree-l4"><a class="reference internal" href="../release_notes_0.2.html#ipu-mipi-cs2-hdmi-in">IPU (MIPI-CS2, HDMI-in)</a></li>
<li class="toctree-l4"><a class="reference internal" href="../release_notes_0.2.html#bluetooth">Bluetooth</a></li>
<li class="toctree-l4"><a class="reference internal" href="../release_notes_0.2.html#gpu-preemption">GPU  – Preemption</a></li>
<li class="toctree-l4"><a class="reference internal" href="../release_notes_0.2.html#gpu-display-surface-sharing-via-hyper-dma">GPU – display surface sharing via Hyper DMA</a></li>
<li class="toctree-l4"><a class="reference internal" href="../release_notes_0.2.html#s3">S3</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../release_notes_0.2.html#fixed-issues">Fixed Issues</a></li>
<li class="toctree-l3"><a class="reference internal" href="../release_notes_0.2.html#known-issues">Known Issues</a></li>
<li class="toctree-l3"><a class="reference internal" href="../release_notes_0.2.html#change-log">Change Log</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../release_notes_0.1.html">ACRN v0.1 (July 2018)</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../release_notes_0.1.html#version-0-1-new-features">Version 0.1 new features</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../release_notes_0.1.html#hardware-support">Hardware Support</a></li>
<li class="toctree-l4"><a class="reference internal" href="../release_notes_0.1.html#gvt-g-for-acrn">GVT-g for ACRN</a></li>
<li class="toctree-l4"><a class="reference internal" href="../release_notes_0.1.html#virtio-standard-is-supported">Virtio standard is supported</a></li>
<li class="toctree-l4"><a class="reference internal" href="../release_notes_0.1.html#device-pass-through-support">Device pass-through support</a></li>
<li class="toctree-l4"><a class="reference internal" href="../release_notes_0.1.html#hypervisor-configuration">Hypervisor configuration</a></li>
<li class="toctree-l4"><a class="reference internal" href="../release_notes_0.1.html#new-acrn-tools">New ACRN tools</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../release_notes_0.1.html#known-issues">Known Issues</a></li>
<li class="toctree-l3"><a class="reference internal" href="../release_notes_0.1.html#change-log">Change Log</a></li>
</ul>
</li>
</ul>
</li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Project ACRN™</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
          <li><a href="index.html">Developer Guides</a> &raquo;</li>
        
      <li>Memory Management high-level design</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="memory-management-high-level-design">
<span id="memmgt-hld"></span><h1>Memory Management high-level design<a class="headerlink" href="#memory-management-high-level-design" title="Permalink to this headline">¶</a></h1>
<p>This document describes memory management for the ACRN hypervisor.</p>
<div class="section" id="overview">
<h2>Overview<a class="headerlink" href="#overview" title="Permalink to this headline">¶</a></h2>
<p>In the ACRN hypervisor system, there are few different memory spaces to
consider.  From the hypervisor’s point of view there are:</p>
<ul class="simple">
<li>Host Physical Address (HPA): the native physical address space, and</li>
<li>Host Virtual Address (HVA): the native virtual address space based on
a MMU. A page table is used to do the translation between HPA and HVA
spaces.</li>
</ul>
<p>And from the Guest OS running on a hypervisor there are:</p>
<ul class="simple">
<li>Guest Physical Address (GPA): the guest physical address space from a
virtual machine.  GPA to HPA transition is usually based on a
MMU-like hardware module (EPT in X86), and associated with a page
table</li>
<li>Guest Virtual Address (GVA): the guest virtual address space from a
virtual machine based on a vMMU</li>
</ul>
<div class="figure align-center" id="mem-overview">
<a class="reference internal image-reference" href="../_images/mem-image2.png"><img alt="../_images/mem-image2.png" src="../_images/mem-image2.png" style="width: 900px;" /></a>
<p class="caption"><span class="caption-number">Figure 54 </span><span class="caption-text">ACRN Memory Mapping Overview</span></p>
</div>
<p><a class="reference internal" href="#mem-overview"><span class="std std-numref">Figure 54</span></a> provides an overview of the ACRN system memory
mapping, showing:</p>
<ul class="simple">
<li>GVA to GPA mapping based on vMMU on a VCPU in a VM</li>
<li>GPA to HPA mapping based on EPT for a VM in the hypervisor</li>
<li>HVA to HPA mapping based on MMU in the hypervisor</li>
</ul>
<p>This document illustrates the memory management infrastructure for the
ACRN hypervisor and how it handles the different memory space views
inside the hypervisor and from a VM:</p>
<ul class="simple">
<li>How ACRN hypervisor manages host memory (HPA/HVA)</li>
<li>How ACRN hypervisor manages SOS guest memory (HPA/GPA)</li>
<li>How ACRN hypervisor &amp; SOS DM manage UOS guest memory (HPA/GPA)</li>
</ul>
</div>
<div class="section" id="hypervisor-memory-management">
<h2>Hypervisor Memory Management<a class="headerlink" href="#hypervisor-memory-management" title="Permalink to this headline">¶</a></h2>
<p>The ACRN hypervisor is the primary owner to manage system
memory. Typically the boot firmware (e.g., EFI) passes the platform physical
memory layout - E820 table to the hypervisor. The ACRN hypervisor does its memory
management based on this table.</p>
<div class="section" id="physical-memory-layout-e820">
<h3>Physical Memory Layout - E820<a class="headerlink" href="#physical-memory-layout-e820" title="Permalink to this headline">¶</a></h3>
<p>The boot firmware (e.g., EFI) passes the E820 table through a multiboot protocol.
This table contains the original memory layout for the platform.</p>
<div class="figure align-center" id="mem-layout">
<a class="reference internal image-reference" href="../_images/mem-image1.png"><img alt="../_images/mem-image1.png" src="../_images/mem-image1.png" style="width: 900px;" /></a>
<p class="caption"><span class="caption-number">Figure 55 </span><span class="caption-text">Physical Memory Layout Example</span></p>
</div>
<p><a class="reference internal" href="#mem-layout"><span class="std std-numref">Figure 55</span></a> is an example of the physical memory layout based on a simple
platform E820 table. The following sections demonstrate different memory
space management by referencing it.</p>
</div>
<div class="section" id="physical-to-virtual-mapping">
<h3>Physical to Virtual Mapping<a class="headerlink" href="#physical-to-virtual-mapping" title="Permalink to this headline">¶</a></h3>
<p>ACRN hypervisor is running under paging mode, so after receiving
the platform E820 table, ACRN hypervisor creates its MMU page table
based on it. This is done by the function init_paging() for all
physical CPUs.</p>
<p>The memory mapping policy here is:</p>
<ul class="simple">
<li>Identical mapping for each physical CPU (ACRN hypervisor’s memory
could be relocatable in a future implementation)</li>
<li>Map all memory regions with UNCACHED type</li>
<li>Remap RAM regions to WRITE-BACK type</li>
</ul>
<div class="figure align-center" id="vm-layout">
<a class="reference internal image-reference" href="../_images/mem-image4.png"><img alt="../_images/mem-image4.png" src="../_images/mem-image4.png" style="width: 900px;" /></a>
<p class="caption"><span class="caption-number">Figure 56 </span><span class="caption-text">Hypervisor Virtual Memory Layout</span></p>
</div>
<p><a class="reference internal" href="#vm-layout"><span class="std std-numref">Figure 56</span></a> shows:</p>
<ul class="simple">
<li>Hypervisor can access all of system memory</li>
<li>Hypervisor has an UNCACHED MMIO/PCI hole reserved for devices, such
as for LAPIC/IOAPIC access</li>
<li>Hypervisor has its own memory with WRITE-BACK cache type for its
code and data (&lt; 1M part is for secondary CPU reset code)</li>
</ul>
</div>
</div>
<div class="section" id="service-os-memory-management">
<h2>Service OS Memory Management<a class="headerlink" href="#service-os-memory-management" title="Permalink to this headline">¶</a></h2>
<p>After the ACRN hypervisor starts, it creates the Service OS as its first
VM. The Service OS runs all the native device drivers, manage the
hardware devices, and provides I/O mediation to guest VMs. The Service
OS is in charge of the memory allocation for Guest VMs as well.</p>
<p>ACRN hypervisor passes the whole system memory access (except its own
part) to the Service OS. The Service OS must be able to access all of
the system memory except the hypervisor part.</p>
<div class="section" id="guest-physical-memory-layout-e820">
<h3>Guest Physical Memory Layout - E820<a class="headerlink" href="#guest-physical-memory-layout-e820" title="Permalink to this headline">¶</a></h3>
<p>The ACRN hypervisor passes the original E820 table to the Service OS
after filtering out its own part. So from Service OS’s view, it sees
almost all the system memory as shown here:</p>
<div class="figure align-center" id="sos-mem-layout">
<a class="reference internal image-reference" href="../_images/mem-image3.png"><img alt="../_images/mem-image3.png" src="../_images/mem-image3.png" style="width: 900px;" /></a>
<p class="caption"><span class="caption-number">Figure 57 </span><span class="caption-text">SOS Physical Memory Layout</span></p>
</div>
</div>
<div class="section" id="host-to-guest-mapping">
<h3>Host to Guest Mapping<a class="headerlink" href="#host-to-guest-mapping" title="Permalink to this headline">¶</a></h3>
<p>ACRN hypervisor creates Service OS’s host (HPA) to guest (GPA) mapping
(EPT mapping) through the function
<code class="docutils literal notranslate"><span class="pre">prepare_vm0_memmap_and_e820()</span></code> when it creates the SOS VM. It follows
these rules:</p>
<ul class="simple">
<li>Identical mapping</li>
<li>Map all memory range with UNCACHED type</li>
<li>Remap RAM entries in E820 (revised) with WRITE-BACK type</li>
<li>Unmap ACRN hypervisor memory range</li>
<li>Unmap ACRN hypervisor emulated vLAPIC/vIOAPIC MMIO range</li>
</ul>
<p>The host to guest mapping is static for the Service OS; it will not
change after the Service OS begins running. Each native device driver
can access its MMIO through this static mapping. EPT violation is only
serving for vLAPIC/vIOAPIC’s emulation in the hypervisor for Service OS
VM.</p>
</div>
</div>
<div class="section" id="user-os-memory-management">
<h2>User OS Memory Management<a class="headerlink" href="#user-os-memory-management" title="Permalink to this headline">¶</a></h2>
<p>User OS VM is created by the DM (Device Model) application running in
the Service OS. DM is responsible for the memory allocation for a User
or Guest OS VM.</p>
<div class="section" id="id1">
<h3>Guest Physical Memory Layout - E820<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h3>
<p>DM will create the E820 table for a User OS VM based on these simple
rules:</p>
<ul class="simple">
<li>If requested VM memory size &lt; low memory limitation (defined in DM,
as 2GB), then low memory range = [0, requested VM memory size]</li>
<li>If requested VM memory size &gt; low memory limitation (defined in DM,
as 2GB), then low memory range = [0, 2GB], high memory range = [4GB,
4GB + requested VM memory size - 2GB]</li>
</ul>
<div class="figure align-center" id="uos-mem-layout">
<a class="reference internal image-reference" href="../_images/mem-image6.png"><img alt="../_images/mem-image6.png" src="../_images/mem-image6.png" style="width: 900px;" /></a>
<p class="caption"><span class="caption-number">Figure 58 </span><span class="caption-text">UOS Physical Memory Layout</span></p>
</div>
<p>DM is doing UOS memory allocation based on hugeTLB mechanism by
default. The real memory mapping
may be scattered in SOS physical memory space, as shown below:</p>
<div class="figure align-center" id="uos-mem-layout-hugetlb">
<a class="reference internal image-reference" href="../_images/mem-image5.png"><img alt="../_images/mem-image5.png" src="../_images/mem-image5.png" style="width: 900px;" /></a>
<p class="caption"><span class="caption-number">Figure 59 </span><span class="caption-text">UOS Physical Memory Layout Based on Hugetlb</span></p>
</div>
</div>
<div class="section" id="id2">
<h3>Host to Guest Mapping<a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h3>
<p>A User OS VM’s memory is allocated by the Service OS DM application, and
may come from different huge pages in the Service OS as shown in
<a class="reference internal" href="#uos-mem-layout-hugetlb"><span class="std std-ref">UOS Physical Memory Layout Based on Hugetlb</span></a>.</p>
<p>As Service OS has the full information of these huge pages size,
SOS-GPA and UOS-GPA, it works with the hypervisor to complete UOS’s host
to guest mapping using this pseudo code:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">x</span> <span class="n">in</span> <span class="n">allocated</span> <span class="n">huge</span> <span class="n">pages</span> <span class="k">do</span>
   <span class="n">x</span><span class="p">.</span><span class="n">hpa</span> <span class="o">=</span> <span class="n">gpa2hpa_for_sos</span><span class="p">(</span><span class="n">x</span><span class="p">.</span><span class="n">sos_gpa</span><span class="p">)</span>
   <span class="n">host2guest_map_for_uos</span><span class="p">(</span><span class="n">x</span><span class="p">.</span><span class="n">hpa</span><span class="p">,</span> <span class="n">x</span><span class="p">.</span><span class="n">uos_gpa</span><span class="p">,</span> <span class="n">x</span><span class="p">.</span><span class="n">size</span><span class="p">)</span>
<span class="n">end</span>
</pre></div>
</div>
</div>
<div class="section" id="trusty">
<h3>Trusty<a class="headerlink" href="#trusty" title="Permalink to this headline">¶</a></h3>
<p>For an Android User OS, there is a secure world called “trusty world
support”, whose memory needs are taken care by the ACRN hypervisor for
security consideration. From the memory management’s view, the trusty
memory space should not be accessible by SOS or UOS normal world.</p>
<div class="figure align-center" id="uos-mem-layout-trusty">
<a class="reference internal image-reference" href="../_images/mem-image7.png"><img alt="../_images/mem-image7.png" src="../_images/mem-image7.png" style="width: 900px;" /></a>
<p class="caption"><span class="caption-number">Figure 60 </span><span class="caption-text">UOS Physical Memory Layout with Trusty</span></p>
</div>
</div>
</div>
<div class="section" id="memory-interaction">
<h2>Memory Interaction<a class="headerlink" href="#memory-interaction" title="Permalink to this headline">¶</a></h2>
<p>Previous sections described different memory spaces management in the
ACRN hypervisor, Service OS, and User OS. Among these memory spaces,
there are different kinds of interaction, for example, a VM may do a
hypercall to the hypervisor that includes a data transfer, or an
instruction emulation in the hypervisor may need to access the Guest
instruction pointer register to fetch instruction data.</p>
<div class="section" id="access-gpa-from-hypervisor">
<h3>Access GPA from Hypervisor<a class="headerlink" href="#access-gpa-from-hypervisor" title="Permalink to this headline">¶</a></h3>
<p>When a hypervisor needs access to the GPA for data transfers, the caller
from the Guest must make sure this memory range’s GPA is address
continuous. But for HPA in the hypervisor, it could be address
dis-continuous (especially for UOS under hugetlb allocation mechanism).
For example, a 4MB GPA range may map to 2 different 2MB huge pages. The
ACRN hypervisor needs to take care of this kind of data transfer by
doing EPT page walking based on its HPA.</p>
</div>
<div class="section" id="access-gva-from-hypervisor">
<h3>Access GVA from Hypervisor<a class="headerlink" href="#access-gva-from-hypervisor" title="Permalink to this headline">¶</a></h3>
<p>Likely, when hypervisor need to access GVA for data transfer, both GPA
and HPA could be address dis-continuous. The ACRN hypervisor must pay
attention to this kind of data transfer, and handle it by doing page
walking based on both its GPA and HPA.</p>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2018, Project ACRN.
      Last updated on Sep 20, 2018.

    </p>
  </div> 

</footer>

        </div>
      </div>

    </section>

  </div>
  
  <div class="rst-versions" data-toggle="rst-versions" role="note" aria-label="versions">
    <span class="rst-current-version" data-toggle="rst-current-version">
      <span class="fa fa-book"> Project ACRN</span>
      v: latest
      <span class="fa fa-caret-down"></span>
    </span>
    <div class="rst-other-versions">
      <dl>
        <dt>Versions</dt>
        
          <dd><a href="/latest/">latest</a></dd>
        
          <dd><a href="/0.1/">0.1</a></dd>
        
      </dl>
      <dl>
        <dt>On projectacrn.org</dt>
          <dd>
            <a href="https://www.projectacrn.org/">Project Home</a>
          </dd>
          <dd>
            <a href="https://github.com/projectacrn/acrn-hypervisor/wiki">Wiki</a>
          </dd>
      </dl>
    </div>
  </div>

  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../',
            VERSION:'v 0.2-unstable',
            LANGUAGE:'None',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="../_static/jquery.js"></script>
      <script type="text/javascript" src="../_static/underscore.js"></script>
      <script type="text/javascript" src="../_static/doctools.js"></script>
      <script type="text/javascript" src="../_static/acrn-custom.js"></script>

  

  <script type="text/javascript" src="../_static/js/theme.js"></script>

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>