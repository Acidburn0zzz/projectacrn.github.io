

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Developer Primer &mdash; Project ACRN™ v 0.6-unstable documentation</title>
  

  
  
    <link rel="shortcut icon" href="../_static/ACRN-favicon-32x32.png"/>
  
  
  

  

  
  
    

  

  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../_static/acrn-custom.css" type="text/css" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="GVT-g Enabling and Porting Guide" href="GVT-g-porting.html" />
    <link rel="prev" title="Security high-level design" href="hld/hld-security.html" /> 

  
  <script src="../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../index.html" class="icon icon-home"> Project ACRN™
          

          
            
            <img src="../_static/ACRN_Logo_200w.png" class="logo" alt="Logo"/>
          
          </a>

          
            
            
              <div class="version">
                latest
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../introduction/index.html">Introduction to Project ACRN</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../introduction/index.html#automotive-use-case-example">Automotive Use Case Example</a></li>
<li class="toctree-l2"><a class="reference internal" href="../introduction/index.html#licensing">Licensing</a></li>
<li class="toctree-l2"><a class="reference internal" href="../introduction/index.html#acrn-device-model-service-os-and-user-os">ACRN Device Model, Service OS, and User OS</a></li>
<li class="toctree-l2"><a class="reference internal" href="../introduction/index.html#boot-sequence">Boot Sequence</a></li>
<li class="toctree-l2"><a class="reference internal" href="../introduction/index.html#acrn-hypervisor-architecture">ACRN Hypervisor Architecture</a></li>
<li class="toctree-l2"><a class="reference internal" href="../introduction/index.html#acrn-device-model-architecture">ACRN Device Model Architecture</a></li>
<li class="toctree-l2"><a class="reference internal" href="../introduction/index.html#device-pass-through">Device pass through</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../introduction/index.html#hardware-support-for-device-passthrough">Hardware support for device passthrough</a></li>
<li class="toctree-l3"><a class="reference internal" href="../introduction/index.html#hypervisor-support-for-device-passthrough">Hypervisor support for device passthrough</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../introduction/index.html#acrn-i-o-mediator">ACRN I/O mediator</a></li>
<li class="toctree-l2"><a class="reference internal" href="../introduction/index.html#virtio-framework-architecture">Virtio framework architecture</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../getting-started/index.html">Getting Started Guides</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../getting-started/apl-nuc.html">Getting started guide for Intel NUC</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../getting-started/apl-nuc.html#hardware-setup">Hardware setup</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../getting-started/apl-nuc.html#firmware-update-on-the-nuc">Firmware update on the NUC</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../getting-started/apl-nuc.html#software-setup">Software setup</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../getting-started/apl-nuc.html#set-up-a-clear-linux-operating-system">Set up a Clear Linux Operating System</a></li>
<li class="toctree-l4"><a class="reference internal" href="../getting-started/apl-nuc.html#add-the-acrn-hypervisor-to-the-efi-partition">Add the ACRN hypervisor to the EFI Partition</a></li>
<li class="toctree-l4"><a class="reference internal" href="../getting-started/apl-nuc.html#acrn-network-bridge">ACRN Network Bridge</a></li>
<li class="toctree-l4"><a class="reference internal" href="../getting-started/apl-nuc.html#set-up-reference-uos">Set up Reference UOS</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../getting-started/up2.html">Getting started guide for UP2 board</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../getting-started/up2.html#hardware-setup">Hardware setup</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../getting-started/up2.html#connecting-to-the-serial-port">Connecting to the serial port</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../getting-started/up2.html#software-setup">Software setup</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../getting-started/up2.html#up2-serial-port-setting">UP2 serial port setting</a></li>
<li class="toctree-l4"><a class="reference internal" href="../getting-started/up2.html#up2-block-device">UP2 block device</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../getting-started/up2.html#running-the-hypervisor">Running the hypervisor</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../getting-started/building-from-source.html">Build ACRN from Source</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../getting-started/building-from-source.html#install-build-tools-and-dependencies">Install build tools and dependencies</a></li>
<li class="toctree-l3"><a class="reference internal" href="../getting-started/building-from-source.html#build-the-hypervisor-device-model-and-tools">Build the hypervisor, device model and tools</a></li>
<li class="toctree-l3"><a class="reference internal" href="../getting-started/building-from-source.html#configuring-the-hypervisor">Configuring the hypervisor</a></li>
<li class="toctree-l3"><a class="reference internal" href="../getting-started/building-from-source.html#modify-the-hypervisor-configurations">Modify the hypervisor configurations</a></li>
<li class="toctree-l3"><a class="reference internal" href="../getting-started/building-from-source.html#create-a-new-default-configuration">Create a new default configuration</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../hardware.html">Supported Hardware</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../hardware.html#intel-apollo-lake-nuc">Intel Apollo Lake NUC</a></li>
<li class="toctree-l2"><a class="reference internal" href="../hardware.html#intel-kaby-lake-nuc">Intel Kaby Lake NUC</a></li>
<li class="toctree-l2"><a class="reference internal" href="../hardware.html#up-squared-board">UP Squared board</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../user-guides/index.html">User Guides</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../user-guides/acrn-dm-parameters.html">Device Model Parameters</a></li>
<li class="toctree-l2"><a class="reference internal" href="../user-guides/acrn-shell.html">ACRN Shell Commands</a></li>
<li class="toctree-l2"><a class="reference internal" href="../user-guides/tools.html">Tools</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../tools/README.html">ACRN tools</a></li>
<li class="toctree-l3"><a class="reference internal" href="../tools/acrn-crashlog/README.html">ACRN-Crashlog</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../tools/acrn-crashlog/README.html#introduction">Introduction</a></li>
<li class="toctree-l4"><a class="reference internal" href="../tools/acrn-crashlog/README.html#building">Building</a></li>
<li class="toctree-l4"><a class="reference internal" href="../tools/acrn-crashlog/README.html#installing">Installing</a></li>
<li class="toctree-l4"><a class="reference internal" href="../tools/acrn-crashlog/README.html#enabling-disabling">Enabling/Disabling</a></li>
<li class="toctree-l4"><a class="reference internal" href="../tools/acrn-crashlog/README.html#usage">Usage</a></li>
<li class="toctree-l4"><a class="reference internal" href="../tools/acrn-crashlog/README.html#source-code">Source Code</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../tools/acrn-crashlog/acrnprobe/README.html">acrnprobe</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../tools/acrn-crashlog/acrnprobe/README.html#description">Description</a></li>
<li class="toctree-l4"><a class="reference internal" href="../tools/acrn-crashlog/acrnprobe/README.html#usage">Usage</a></li>
<li class="toctree-l4"><a class="reference internal" href="../tools/acrn-crashlog/acrnprobe/README.html#architecture">Architecture</a></li>
<li class="toctree-l4"><a class="reference internal" href="../tools/acrn-crashlog/acrnprobe/README.html#source-files">Source files</a></li>
<li class="toctree-l4"><a class="reference internal" href="../tools/acrn-crashlog/acrnprobe/README.html#configuration-files">Configuration files</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../tools/acrn-crashlog/acrnprobe/conf.html">acrnprobe Configuration</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../tools/acrn-crashlog/acrnprobe/conf.html#description">Description</a></li>
<li class="toctree-l4"><a class="reference internal" href="../tools/acrn-crashlog/acrnprobe/conf.html#layout">Layout</a></li>
<li class="toctree-l4"><a class="reference internal" href="../tools/acrn-crashlog/acrnprobe/conf.html#properties-of-group-members">Properties of group members</a></li>
<li class="toctree-l4"><a class="reference internal" href="../tools/acrn-crashlog/acrnprobe/conf.html#crash-tree-in-acrnprobe">Crash tree in acrnprobe</a></li>
<li class="toctree-l4"><a class="reference internal" href="../tools/acrn-crashlog/acrnprobe/conf.html#sections">Sections</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../tools/acrn-crashlog/usercrash/README.html">usercrash</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../tools/acrn-crashlog/usercrash/README.html#description">Description</a></li>
<li class="toctree-l4"><a class="reference internal" href="../tools/acrn-crashlog/usercrash/README.html#design">Design</a></li>
<li class="toctree-l4"><a class="reference internal" href="../tools/acrn-crashlog/usercrash/README.html#usage">Usage</a></li>
<li class="toctree-l4"><a class="reference internal" href="../tools/acrn-crashlog/usercrash/README.html#souce-code">Souce Code</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../tools/acrn-manager/README.html">acrnctl and acrnd</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../tools/acrn-manager/README.html#description">Description</a></li>
<li class="toctree-l4"><a class="reference internal" href="../tools/acrn-manager/README.html#usage">Usage</a></li>
<li class="toctree-l4"><a class="reference internal" href="../tools/acrn-manager/README.html#acrnd">acrnd</a></li>
<li class="toctree-l4"><a class="reference internal" href="../tools/acrn-manager/README.html#build-and-install">Build and Install</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../tools/acrnlog/README.html">acrnlog</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../tools/acrnlog/README.html#description">Description</a></li>
<li class="toctree-l4"><a class="reference internal" href="../tools/acrnlog/README.html#usage">Usage</a></li>
<li class="toctree-l4"><a class="reference internal" href="../tools/acrnlog/README.html#build-and-install">Build and Install</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../tools/acrntrace/README.html">acrntrace</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../tools/acrntrace/README.html#description">Description</a></li>
<li class="toctree-l4"><a class="reference internal" href="../tools/acrntrace/README.html#usage">Usage</a></li>
<li class="toctree-l4"><a class="reference internal" href="../tools/acrntrace/README.html#build-and-install">Build and Install</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Developer Guides</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="hld/index.html">High-Level Design Guides</a><ul>
<li class="toctree-l3"><a class="reference internal" href="hld/hld-overview.html">Overview</a><ul>
<li class="toctree-l4"><a class="reference internal" href="hld/hld-overview.html#acrn-supported-use-cases">ACRN Supported Use Cases</a></li>
<li class="toctree-l4"><a class="reference internal" href="hld/hld-overview.html#hardware-requirements">Hardware Requirements</a></li>
<li class="toctree-l4"><a class="reference internal" href="hld/hld-overview.html#acrn-architecture">ACRN Architecture</a></li>
<li class="toctree-l4"><a class="reference internal" href="hld/hld-overview.html#hypervisor">Hypervisor</a></li>
<li class="toctree-l4"><a class="reference internal" href="hld/hld-overview.html#sos">SOS</a></li>
<li class="toctree-l4"><a class="reference internal" href="hld/hld-overview.html#uos">UOS</a></li>
<li class="toctree-l4"><a class="reference internal" href="hld/hld-overview.html#freedom-from-interference">Freedom From Interference</a></li>
<li class="toctree-l4"><a class="reference internal" href="hld/hld-overview.html#boot-flow">Boot Flow</a></li>
<li class="toctree-l4"><a class="reference internal" href="hld/hld-overview.html#power-management">Power Management</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="hld/hld-hypervisor.html">Hypervisor</a><ul>
<li class="toctree-l4"><a class="reference internal" href="hld/hv-startup.html">Hypervisor Startup</a></li>
<li class="toctree-l4"><a class="reference internal" href="hld/hv-cpu-virt.html">CPU Virtualization</a></li>
<li class="toctree-l4"><a class="reference internal" href="hld/hv-memmgt.html">Memory management</a></li>
<li class="toctree-l4"><a class="reference internal" href="hld/hv-io-emulation.html">I/O Emulation</a></li>
<li class="toctree-l4"><a class="reference internal" href="hld/hv-interrupt.html">Physical Interrupt</a></li>
<li class="toctree-l4"><a class="reference internal" href="hld/hv-timer.html">Timer</a></li>
<li class="toctree-l4"><a class="reference internal" href="hld/hv-virt-interrupt.html">Virtual Interrupt</a></li>
<li class="toctree-l4"><a class="reference internal" href="hld/hv-vt-d.html">VT-d</a></li>
<li class="toctree-l4"><a class="reference internal" href="hld/hv-dev-passthrough.html">Device Passthrough</a></li>
<li class="toctree-l4"><a class="reference internal" href="hld/hv-partitionmode.html">Partition mode</a></li>
<li class="toctree-l4"><a class="reference internal" href="hld/hv-pm.html">Power Management</a></li>
<li class="toctree-l4"><a class="reference internal" href="hld/hv-console.html">Console, Shell, and vUART</a></li>
<li class="toctree-l4"><a class="reference internal" href="hld/hv-hypercall.html">Hypercall / VHM upcall</a></li>
<li class="toctree-l4"><a class="reference internal" href="hld/hv-config.html">Compile-time configuration</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="hld/hld-devicemodel.html">Device Model</a><ul>
<li class="toctree-l4"><a class="reference internal" href="hld/hld-devicemodel.html#configuration">Configuration</a></li>
<li class="toctree-l4"><a class="reference internal" href="hld/hld-devicemodel.html#dm-initialization">DM Initialization</a></li>
<li class="toctree-l4"><a class="reference internal" href="hld/hld-devicemodel.html#vhm">VHM</a></li>
<li class="toctree-l4"><a class="reference internal" href="hld/hld-devicemodel.html#i-o-emulation-in-sos">I/O Emulation in SOS</a></li>
<li class="toctree-l4"><a class="reference internal" href="hld/hld-devicemodel.html#device-emulation">Device Emulation</a></li>
<li class="toctree-l4"><a class="reference internal" href="hld/hld-devicemodel.html#isa-and-pci-emulation">ISA and PCI Emulation</a></li>
<li class="toctree-l4"><a class="reference internal" href="hld/hld-devicemodel.html#acpi-virtualization">ACPI Virtualization</a></li>
<li class="toctree-l4"><a class="reference internal" href="hld/hld-devicemodel.html#pm-in-device-model">PM in Device Model</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="hld/hld-emulated-devices.html">Emulated Devices</a><ul>
<li class="toctree-l4"><a class="reference internal" href="hld/usb-virt-hld.html">USB Virtualization</a></li>
<li class="toctree-l4"><a class="reference internal" href="hld/uart-virt-hld.html">UART virtualization</a></li>
<li class="toctree-l4"><a class="reference internal" href="hld/watchdog-hld.html">Watchdoc virtualization</a></li>
<li class="toctree-l4"><a class="reference internal" href="hld/random-virt-hld.html">Random device virtualization</a></li>
<li class="toctree-l4"><a class="reference internal" href="hld/hld-APL_GVT-g.html">GVT-g GPU Virtualization</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="hld/hld-virtio-devices.html">Virtio Devices</a><ul>
<li class="toctree-l4"><a class="reference internal" href="hld/hld-virtio-devices.html#virtio-introduction">Virtio introduction</a></li>
<li class="toctree-l4"><a class="reference internal" href="hld/hld-virtio-devices.html#key-concepts">Key Concepts</a></li>
<li class="toctree-l4"><a class="reference internal" href="hld/hld-virtio-devices.html#virtio-frameworks">Virtio Frameworks</a></li>
<li class="toctree-l4"><a class="reference internal" href="hld/hld-virtio-devices.html#virtio-apis">Virtio APIs</a></li>
<li class="toctree-l4"><a class="reference internal" href="hld/hld-virtio-devices.html#supported-virtio-devices">Supported Virtio Devices</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="hld/hld-vm-management.html">VM Management</a><ul>
<li class="toctree-l4"><a class="reference internal" href="hld/hld-vm-management.html#vm-state">VM state</a></li>
<li class="toctree-l4"><a class="reference internal" href="hld/hld-vm-management.html#scenarios-of-vm-state-change">Scenarios of VM state change</a></li>
<li class="toctree-l4"><a class="reference internal" href="hld/hld-vm-management.html#vm-state-management">VM State management</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="hld/hld-power-management.html">Power Management</a><ul>
<li class="toctree-l4"><a class="reference internal" href="hld/hld-power-management.html#p-state-c-state-management">P-state/C-state management</a></li>
<li class="toctree-l4"><a class="reference internal" href="hld/hld-power-management.html#s3-s5">S3/S5</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="hld/hld-trace-log.html">Tracing and Logging</a><ul>
<li class="toctree-l4"><a class="reference internal" href="hld/hld-trace-log.html#shared-buffer">Shared Buffer</a></li>
<li class="toctree-l4"><a class="reference internal" href="hld/hld-trace-log.html#acrn-trace">ACRN Trace</a></li>
<li class="toctree-l4"><a class="reference internal" href="hld/hld-trace-log.html#acrn-log">ACRN Log</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="hld/hld-vsbl.html">Virtual Bootloader</a></li>
<li class="toctree-l3"><a class="reference internal" href="hld/hld-security.html">Security</a><ul>
<li class="toctree-l4"><a class="reference internal" href="hld/hld-security.html#introduction">Introduction</a></li>
<li class="toctree-l4"><a class="reference internal" href="hld/hld-security.html#background">Background</a></li>
<li class="toctree-l4"><a class="reference internal" href="hld/hld-security.html#acrn-high-level-security-architecture">ACRN High-Level Security Architecture</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Developer Primer</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#source-tree-structure">Source Tree Structure</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#acrn-hypervisor-source-tree">ACRN hypervisor source tree</a></li>
<li class="toctree-l4"><a class="reference internal" href="#acrn-device-model-source-tree">ACRN Device Model source tree</a></li>
<li class="toctree-l4"><a class="reference internal" href="#acrn-tools-source-tree">ACRN Tools source tree</a></li>
<li class="toctree-l4"><a class="reference internal" href="#acrn-documentation-source-tree">ACRN documentation source tree</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#cpu-virtualization">CPU virtualization</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#host-gdt">Host GDT</a></li>
<li class="toctree-l4"><a class="reference internal" href="#host-idt">Host IDT</a></li>
<li class="toctree-l4"><a class="reference internal" href="#guest-smp-booting">Guest SMP Booting</a></li>
<li class="toctree-l4"><a class="reference internal" href="#vmx-configuration">VMX configuration</a></li>
<li class="toctree-l4"><a class="reference internal" href="#cpuid-and-guest-tsc-calibration">CPUID and Guest TSC calibration</a></li>
<li class="toctree-l4"><a class="reference internal" href="#rdtsc-rdtscp">RDTSC/RDTSCP</a></li>
<li class="toctree-l4"><a class="reference internal" href="#cr-register-virtualization">CR Register virtualization</a></li>
<li class="toctree-l4"><a class="reference internal" href="#msr-bitmap">MSR BITMAP</a></li>
<li class="toctree-l4"><a class="reference internal" href="#i-o-bitmap">I/O BITMAP</a></li>
<li class="toctree-l4"><a class="reference internal" href="#exceptions">Exceptions</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#memory-virtualization">Memory virtualization</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#physical-memory-layout">Physical Memory Layout</a></li>
<li class="toctree-l4"><a class="reference internal" href="#pv-mmu-memory-mapping-in-the-hypervisor">PV (MMU) Memory Mapping in the Hypervisor</a></li>
<li class="toctree-l4"><a class="reference internal" href="#pv-mmu-memory-mapping-in-vms">PV (MMU) Memory Mapping in VMs</a></li>
<li class="toctree-l4"><a class="reference internal" href="#host-guest-ept-memory-mapping">Host-Guest (EPT) Memory Mapping</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#graphic-mediation">Graphic mediation</a></li>
<li class="toctree-l3"><a class="reference internal" href="#i-o-emulation">I/O emulation</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#device-assignment-management">Device Assignment Management</a></li>
<li class="toctree-l4"><a class="reference internal" href="#pio-mmio-trap-flow">PIO/MMIO trap Flow</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#virtual-interrupt">Virtual interrupt</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#virtual-lapic">Virtual LAPIC</a></li>
<li class="toctree-l4"><a class="reference internal" href="#virtual-ioapic">Virtual IOAPIC</a></li>
<li class="toctree-l4"><a class="reference internal" href="#virtual-pic">Virtual PIC</a></li>
<li class="toctree-l4"><a class="reference internal" href="#virtual-interrupt-injection">Virtual Interrupt Injection</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#vt-x-and-vt-d">VT-x and VT-d</a></li>
<li class="toctree-l3"><a class="reference internal" href="#hypercall">Hypercall</a></li>
<li class="toctree-l3"><a class="reference internal" href="#device-emulation">Device emulation</a></li>
<li class="toctree-l3"><a class="reference internal" href="#virtio-devices">Virtio Devices</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#virtio-rnd">Virtio-rnd</a></li>
<li class="toctree-l4"><a class="reference internal" href="#virtio-blk">Virtio-blk</a></li>
<li class="toctree-l4"><a class="reference internal" href="#virtio-net">Virtio-net</a></li>
<li class="toctree-l4"><a class="reference internal" href="#virtio-console">Virtio-console</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="GVT-g-porting.html">GVT-g Enabling and Porting Guide</a><ul>
<li class="toctree-l3"><a class="reference internal" href="GVT-g-porting.html#introduction">Introduction</a></li>
<li class="toctree-l3"><a class="reference internal" href="GVT-g-porting.html#purpose-of-this-document">Purpose of this document</a></li>
<li class="toctree-l3"><a class="reference internal" href="GVT-g-porting.html#overall-components">Overall Components</a></li>
<li class="toctree-l3"><a class="reference internal" href="GVT-g-porting.html#core-scenario-interaction-sequences">Core scenario interaction sequences</a><ul>
<li class="toctree-l4"><a class="reference internal" href="GVT-g-porting.html#vgpu-creation-scenario">vGPU creation scenario</a></li>
<li class="toctree-l4"><a class="reference internal" href="GVT-g-porting.html#vgpu-destroy-scenario">vGPU destroy scenario</a></li>
<li class="toctree-l4"><a class="reference internal" href="GVT-g-porting.html#vgpu-pci-configure-space-write-scenario">vGPU pci configure space write scenario</a></li>
<li class="toctree-l4"><a class="reference internal" href="GVT-g-porting.html#pci-configure-space-read-scenario">pci configure space read scenario</a></li>
<li class="toctree-l4"><a class="reference internal" href="GVT-g-porting.html#ggtt-read-write-scenario">GGTT read/write scenario</a></li>
<li class="toctree-l4"><a class="reference internal" href="GVT-g-porting.html#mmio-read-write-scenario">MMIO read/write scenario</a></li>
<li class="toctree-l4"><a class="reference internal" href="GVT-g-porting.html#ppgtt-write-protection-page-set-unset-scenario">PPGTT write protection page set/unset scenario</a></li>
<li class="toctree-l4"><a class="reference internal" href="GVT-g-porting.html#ppgtt-write-protection-page-write">PPGTT write protection page write</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="GVT-g-porting.html#api-details">API details</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="GVT-g-kernel-options.html">GVT-g (AcrnGT) Kernel Options</a><ul>
<li class="toctree-l3"><a class="reference internal" href="GVT-g-kernel-options.html#i915-enable-gvt">i915.enable_gvt</a></li>
<li class="toctree-l3"><a class="reference internal" href="GVT-g-kernel-options.html#i915-enable-pvmmio">i915.enable_pvmmio</a></li>
<li class="toctree-l3"><a class="reference internal" href="GVT-g-kernel-options.html#i915-gvt-workload-priority">i915.gvt_workload_priority</a></li>
<li class="toctree-l3"><a class="reference internal" href="GVT-g-kernel-options.html#i915-enable-initial-modeset">i915.enable_initial_modeset</a></li>
<li class="toctree-l3"><a class="reference internal" href="GVT-g-kernel-options.html#i915-avail-planes-per-pipe-and-i915-domain-plane-owners">i915.avail_planes_per_pipe and i915.domain_plane_owners</a><ul>
<li class="toctree-l4"><a class="reference internal" href="GVT-g-kernel-options.html#i915-domain-plane-owners">i915.domain_plane_owners</a></li>
<li class="toctree-l4"><a class="reference internal" href="GVT-g-kernel-options.html#i915-avail-planes-per-pipe">i915.avail_planes_per_pipe</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="GVT-g-kernel-options.html#i915-domain-scaler-owner">i915.domain_scaler_owner</a></li>
<li class="toctree-l3"><a class="reference internal" href="GVT-g-kernel-options.html#i915-enable-hangcheck">i915.enable_hangcheck</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="trusty.html">Trusty TEE</a><ul>
<li class="toctree-l3"><a class="reference internal" href="trusty.html#introduction">Introduction</a></li>
<li class="toctree-l3"><a class="reference internal" href="trusty.html#trusty-architecture">Trusty Architecture</a></li>
<li class="toctree-l3"><a class="reference internal" href="trusty.html#trusty-specific-hypercalls">Trusty specific Hypercalls</a></li>
<li class="toctree-l3"><a class="reference internal" href="trusty.html#trusty-boot-flow">Trusty Boot flow</a></li>
<li class="toctree-l3"><a class="reference internal" href="trusty.html#ept-hierarchy">EPT Hierarchy</a><ul>
<li class="toctree-l4"><a class="reference internal" href="trusty.html#design">Design</a></li>
<li class="toctree-l4"><a class="reference internal" href="trusty.html#benefit">Benefit</a></li>
<li class="toctree-l4"><a class="reference internal" href="trusty.html#api">API</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="l1tf.html">L1 Terminal Fault Mitigation</a><ul>
<li class="toctree-l3"><a class="reference internal" href="l1tf.html#overview">Overview</a></li>
<li class="toctree-l3"><a class="reference internal" href="l1tf.html#l1tf-problem-in-acrn">L1TF Problem in ACRN</a><ul>
<li class="toctree-l4"><a class="reference internal" href="l1tf.html#guest-hypervisor-attack">Guest -&gt; hypervisor Attack</a></li>
<li class="toctree-l4"><a class="reference internal" href="l1tf.html#guest-guest-attack">Guest -&gt; guest Attack</a></li>
<li class="toctree-l4"><a class="reference internal" href="l1tf.html#normal-world-secure-world-attack">Normal_world -&gt; Secure_world Attack</a></li>
<li class="toctree-l4"><a class="reference internal" href="l1tf.html#affected-processors">Affected Processors</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="l1tf.html#l1tf-mitigation-in-acrn">L1TF Mitigation in ACRN</a><ul>
<li class="toctree-l4"><a class="reference internal" href="l1tf.html#l1d-flush-on-vmentry">L1D flush on VMENTRY</a></li>
<li class="toctree-l4"><a class="reference internal" href="l1tf.html#ept-sanitization">EPT Sanitization</a></li>
<li class="toctree-l4"><a class="reference internal" href="l1tf.html#put-secret-data-into-uncached-memory">Put Secret Data into Uncached Memory</a></li>
<li class="toctree-l4"><a class="reference internal" href="l1tf.html#l1d-flush-on-world-switch">L1D flush on World Switch</a></li>
<li class="toctree-l4"><a class="reference internal" href="l1tf.html#core-based-scheduling">Core-based scheduling</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="l1tf.html#mitigation-recommendations">Mitigation Recommendations</a></li>
<li class="toctree-l3"><a class="reference internal" href="l1tf.html#mitigation-status">Mitigation Status</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="modularity.html">ACRN Hypervisor: Modular Design</a><ul>
<li class="toctree-l3"><a class="reference internal" href="modularity.html#overview">Overview</a></li>
<li class="toctree-l3"><a class="reference internal" href="modularity.html#principles">Principles</a><ul>
<li class="toctree-l4"><a class="reference internal" href="modularity.html#minimizing-cyclic-dependencies">Minimizing Cyclic Dependencies</a></li>
<li class="toctree-l4"><a class="reference internal" href="modularity.html#measuring-complexity">Measuring Complexity</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="modularity.html#architecture">Architecture</a></li>
<li class="toctree-l3"><a class="reference internal" href="modularity.html#references">References</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../api/index.html">API Documentation</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../api/hypercall_api.html">Hypercall APIs</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/devicemodel_api.html">Device Model APIs</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/GVT-g_api.html">ACRN GVT-g APIs</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/GVT-g_api.html#core-driver-infrastructure">Core Driver Infrastructure</a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/GVT-g_api.html#vhm-apis-called-from-acrngt">VHM APIs called from AcrnGT</a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/GVT-g_api.html#acrngt-mediated-pass-through-mpt-interface">AcrnGT mediated pass-through (MPT) interface</a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/GVT-g_api.html#gvt-g-intel-gvt-ops-interface">GVT-g intel_gvt_ops interface</a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/GVT-g_api.html#acrngt-sysfs-interface">AcrnGT sysfs interface</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../reference/kconfig/index.html">Configuration Symbol Reference</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../reference/kconfig/index.html#introduction">Introduction</a></li>
<li class="toctree-l3"><a class="reference internal" href="../reference/kconfig/index.html#supported-options">Supported Options</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="index.html#contributing-to-the-project">Contributing to the project</a><ul>
<li class="toctree-l3"><a class="reference internal" href="contribute_guidelines.html">Contribution Guidelines</a><ul>
<li class="toctree-l4"><a class="reference internal" href="contribute_guidelines.html#licensing">Licensing</a></li>
<li class="toctree-l4"><a class="reference internal" href="contribute_guidelines.html#developer-certification-of-origin-dco">Developer Certification of Origin (DCO)</a></li>
<li class="toctree-l4"><a class="reference internal" href="contribute_guidelines.html#prerequisites">Prerequisites</a></li>
<li class="toctree-l4"><a class="reference internal" href="contribute_guidelines.html#repository-layout">Repository layout</a></li>
<li class="toctree-l4"><a class="reference internal" href="contribute_guidelines.html#submitting-issues">Submitting Issues</a></li>
<li class="toctree-l4"><a class="reference internal" href="contribute_guidelines.html#contribution-tools-and-git-setup">Contribution Tools and Git Setup</a></li>
<li class="toctree-l4"><a class="reference internal" href="contribute_guidelines.html#coding-style">Coding Style</a></li>
<li class="toctree-l4"><a class="reference internal" href="contribute_guidelines.html#contribution-workflow">Contribution Workflow</a></li>
<li class="toctree-l4"><a class="reference internal" href="contribute_guidelines.html#commit-guidelines">Commit Guidelines</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="coding_guidelines.html">Coding Guidelines</a><ul>
<li class="toctree-l4"><a class="reference internal" href="coding_guidelines.html#preprocessor">Preprocessor</a></li>
<li class="toctree-l4"><a class="reference internal" href="coding_guidelines.html#compilation-units">Compilation Units</a></li>
<li class="toctree-l4"><a class="reference internal" href="coding_guidelines.html#declarations-and-initialization">Declarations and Initialization</a></li>
<li class="toctree-l4"><a class="reference internal" href="coding_guidelines.html#functions">Functions</a></li>
<li class="toctree-l4"><a class="reference internal" href="coding_guidelines.html#statements">Statements</a></li>
<li class="toctree-l4"><a class="reference internal" href="coding_guidelines.html#expressions">Expressions</a></li>
<li class="toctree-l4"><a class="reference internal" href="coding_guidelines.html#types">Types</a></li>
<li class="toctree-l4"><a class="reference internal" href="coding_guidelines.html#identifiers">Identifiers</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="doc_guidelines.html">Documentation Guidelines</a><ul>
<li class="toctree-l4"><a class="reference internal" href="doc_guidelines.html#headings">Headings</a></li>
<li class="toctree-l4"><a class="reference internal" href="doc_guidelines.html#content-highlighting">Content Highlighting</a></li>
<li class="toctree-l4"><a class="reference internal" href="doc_guidelines.html#lists">Lists</a></li>
<li class="toctree-l4"><a class="reference internal" href="doc_guidelines.html#multi-column-lists">Multi-column lists</a></li>
<li class="toctree-l4"><a class="reference internal" href="doc_guidelines.html#file-names-and-commands">File names and Commands</a></li>
<li class="toctree-l4"><a class="reference internal" href="doc_guidelines.html#internal-cross-reference-linking">Internal Cross-Reference Linking</a></li>
<li class="toctree-l4"><a class="reference internal" href="doc_guidelines.html#non-ascii-characters">Non-ASCII Characters</a></li>
<li class="toctree-l4"><a class="reference internal" href="doc_guidelines.html#code-and-command-examples">Code and Command Examples</a></li>
<li class="toctree-l4"><a class="reference internal" href="doc_guidelines.html#tabs-spaces-and-indenting">Tabs, spaces, and indenting</a></li>
<li class="toctree-l4"><a class="reference internal" href="doc_guidelines.html#drawings">Drawings</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="graphviz.html">Drawings using graphviz</a><ul>
<li class="toctree-l4"><a class="reference internal" href="graphviz.html#simple-directed-graph">Simple directed graph</a></li>
<li class="toctree-l4"><a class="reference internal" href="graphviz.html#adding-edge-labels">Adding edge labels</a></li>
<li class="toctree-l4"><a class="reference internal" href="graphviz.html#tables">Tables</a></li>
<li class="toctree-l4"><a class="reference internal" href="graphviz.html#finite-state-machine">Finite-State Machine</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../tutorials/index.html">Tutorials</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../tutorials/agl-vms.html">Running AGL as VMs</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../tutorials/agl-vms.html#hardware-setup">Hardware setup</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../tutorials/agl-vms.html#connecting-hardware">Connecting hardware</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../tutorials/agl-vms.html#software-setup">Software Setup</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../tutorials/agl-vms.html#service-os">Service OS</a></li>
<li class="toctree-l4"><a class="reference internal" href="../tutorials/agl-vms.html#building-acrn-kernel-for-agl-uos">Building ACRN kernel for AGL (UOS)</a></li>
<li class="toctree-l4"><a class="reference internal" href="../tutorials/agl-vms.html#setting-up-agls">Setting up AGLs</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../tutorials/building_uos_from_clearlinux.html">Building UOS from Clear Linux OS</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../tutorials/building_uos_from_clearlinux.html#build-uos-image-in-clear-linux-os">Build UOS image in Clear Linux OS</a></li>
<li class="toctree-l3"><a class="reference internal" href="../tutorials/building_uos_from_clearlinux.html#start-the-user-os-uos">Start the User OS (UOS)</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../tutorials/docbuild.html">ACRN documentation generation</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../tutorials/docbuild.html#documentation-overview">Documentation overview</a></li>
<li class="toctree-l3"><a class="reference internal" href="../tutorials/docbuild.html#set-up-the-documentation-working-folders">Set up the documentation working folders</a></li>
<li class="toctree-l3"><a class="reference internal" href="../tutorials/docbuild.html#installing-the-documentation-tools">Installing the documentation tools</a></li>
<li class="toctree-l3"><a class="reference internal" href="../tutorials/docbuild.html#documentation-presentation-theme">Documentation presentation theme</a></li>
<li class="toctree-l3"><a class="reference internal" href="../tutorials/docbuild.html#running-the-documentation-processors">Running the documentation processors</a></li>
<li class="toctree-l3"><a class="reference internal" href="../tutorials/docbuild.html#publishing-content">Publishing content</a></li>
<li class="toctree-l3"><a class="reference internal" href="../tutorials/docbuild.html#document-versioning">Document Versioning</a></li>
<li class="toctree-l3"><a class="reference internal" href="../tutorials/docbuild.html#filtering-expected-warnings">Filtering expected warnings</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../tutorials/rt_linux.html">Using PREEMPT_RT-Linux for real-time UOS</a></li>
<li class="toctree-l2"><a class="reference internal" href="../tutorials/skl-nuc.html">GPU Passthrough on Skylake NUC</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../tutorials/skl-nuc.html#hardware-platform">Hardware platform</a></li>
<li class="toctree-l3"><a class="reference internal" href="../tutorials/skl-nuc.html#software-configuration">Software Configuration</a></li>
<li class="toctree-l3"><a class="reference internal" href="../tutorials/skl-nuc.html#software-setup">Software Setup</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../tutorials/static-ip.html">Using a static IP address</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../tutorials/static-ip.html#acrn-network-setup">ACRN Network Setup</a></li>
<li class="toctree-l3"><a class="reference internal" href="../tutorials/static-ip.html#setting-up-the-static-ip-address">Setting up the static IP address</a></li>
<li class="toctree-l3"><a class="reference internal" href="../tutorials/static-ip.html#activate-the-new-configuration">Activate the new configuration</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../tutorials/trustyACRN.html">Trusty and Security Services in ACRN</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../tutorials/trustyACRN.html#trusty-architecture">Trusty Architecture</a></li>
<li class="toctree-l3"><a class="reference internal" href="../tutorials/trustyACRN.html#trusty-services">Trusty Services</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../tutorials/trustyACRN.html#keystore">Keystore</a></li>
<li class="toctree-l4"><a class="reference internal" href="../tutorials/trustyACRN.html#secure-storage-ss">Secure Storage (SS)</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../tutorials/trustyACRN.html#trusty-in-acrn">Trusty in ACRN</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../tutorials/trustyACRN.html#one-vm-two-worlds">One-VM, Two-Worlds</a></li>
<li class="toctree-l4"><a class="reference internal" href="../tutorials/trustyACRN.html#secure-storage-virtualization">Secure Storage Virtualization</a></li>
<li class="toctree-l4"><a class="reference internal" href="../tutorials/trustyACRN.html#references">References:</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../tutorials/using_agl_as_uos.html">Using AGL as the User OS</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../tutorials/using_agl_as_uos.html#introduction-to-agl">Introduction to AGL</a></li>
<li class="toctree-l3"><a class="reference internal" href="../tutorials/using_agl_as_uos.html#steps-for-using-agl-as-the-uos">Steps for using AGL as the UOS</a></li>
<li class="toctree-l3"><a class="reference internal" href="../tutorials/using_agl_as_uos.html#enable-the-agl-display">Enable the AGL display</a></li>
<li class="toctree-l3"><a class="reference internal" href="../tutorials/using_agl_as_uos.html#follow-up">Follow up</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../tutorials/using_partition_mode_on_up2.html">Using partition mode on UP2</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../tutorials/using_partition_mode_on_up2.html#prerequisites">Prerequisites</a></li>
<li class="toctree-l3"><a class="reference internal" href="../tutorials/using_partition_mode_on_up2.html#build-kernel-and-modules-for-partition-mode-uos">Build kernel and modules for partition mode UOS</a></li>
<li class="toctree-l3"><a class="reference internal" href="../tutorials/using_partition_mode_on_up2.html#enable-partition-mode-in-acrn-hypervisor">Enable partition mode in ACRN hypervisor</a></li>
<li class="toctree-l3"><a class="reference internal" href="../tutorials/using_partition_mode_on_up2.html#switch-between-privileged-vms">Switch between privileged VMs</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../tutorials/using_sbl_on_up2.html">Using SBL on UP2 Board</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../tutorials/using_sbl_on_up2.html#prerequisites">Prerequisites</a></li>
<li class="toctree-l3"><a class="reference internal" href="../tutorials/using_sbl_on_up2.html#build-sbl">Build SBL</a></li>
<li class="toctree-l3"><a class="reference internal" href="../tutorials/using_sbl_on_up2.html#flash-sbl-on-the-up2">Flash SBL on the UP2</a></li>
<li class="toctree-l3"><a class="reference internal" href="../tutorials/using_sbl_on_up2.html#build-acrn-for-up2">Build ACRN for UP2</a></li>
<li class="toctree-l3"><a class="reference internal" href="../tutorials/using_sbl_on_up2.html#download-and-install-flash-tool">Download and install flash tool</a></li>
<li class="toctree-l3"><a class="reference internal" href="../tutorials/using_sbl_on_up2.html#sos-and-laag-installation">SOS and LaaG Installation</a></li>
<li class="toctree-l3"><a class="reference internal" href="../tutorials/using_sbl_on_up2.html#boot-to-sos">Boot to SOS</a></li>
<li class="toctree-l3"><a class="reference internal" href="../tutorials/using_sbl_on_up2.html#launch-uos">Launch UOS</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../tutorials/using_ubuntu_as_sos.html">Using Ubuntu as the Service OS</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../tutorials/using_ubuntu_as_sos.html#install-ubuntu-natively">Install Ubuntu (natively)</a></li>
<li class="toctree-l3"><a class="reference internal" href="../tutorials/using_ubuntu_as_sos.html#install-acrn">Install ACRN</a></li>
<li class="toctree-l3"><a class="reference internal" href="../tutorials/using_ubuntu_as_sos.html#install-the-service-os-kernel">Install the Service OS kernel</a></li>
<li class="toctree-l3"><a class="reference internal" href="../tutorials/using_ubuntu_as_sos.html#prepare-the-user-os-uos">Prepare the User OS (UOS)</a></li>
<li class="toctree-l3"><a class="reference internal" href="../tutorials/using_ubuntu_as_sos.html#start-the-user-os-uos">Start the User OS (UOS)</a></li>
<li class="toctree-l3"><a class="reference internal" href="../tutorials/using_ubuntu_as_sos.html#enabling-network-sharing">Enabling network sharing</a></li>
<li class="toctree-l3"><a class="reference internal" href="../tutorials/using_ubuntu_as_sos.html#enabling-usb-keyboard-and-mouse">Enabling USB keyboard and mouse</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../release_notes.html">Release Notes</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../release_notes_0.6.html">ACRN v0.6 (Feb 2019)</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../release_notes_0.6.html#version-0-6-new-features">Version 0.6 new features</a></li>
<li class="toctree-l3"><a class="reference internal" href="../release_notes_0.6.html#fixed-issues">Fixed Issues</a></li>
<li class="toctree-l3"><a class="reference internal" href="../release_notes_0.6.html#known-issues">Known Issues</a></li>
<li class="toctree-l3"><a class="reference internal" href="../release_notes_0.6.html#change-log">Change Log</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../release_notes_0.5.html">ACRN v0.5 (Jan 2019)</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../release_notes_0.5.html#version-0-5-new-features">Version 0.5 new features</a></li>
<li class="toctree-l3"><a class="reference internal" href="../release_notes_0.5.html#fixed-issues">Fixed Issues</a></li>
<li class="toctree-l3"><a class="reference internal" href="../release_notes_0.5.html#known-issues">Known Issues</a></li>
<li class="toctree-l3"><a class="reference internal" href="../release_notes_0.5.html#change-log">Change Log</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../release_notes_0.4.html">ACRN v0.4 (Dec 2018)</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../release_notes_0.4.html#version-0-4-new-features">Version 0.4 new features</a></li>
<li class="toctree-l3"><a class="reference internal" href="../release_notes_0.4.html#fixed-issues">Fixed Issues</a></li>
<li class="toctree-l3"><a class="reference internal" href="../release_notes_0.4.html#known-issues">Known Issues</a></li>
<li class="toctree-l3"><a class="reference internal" href="../release_notes_0.4.html#change-log">Change Log</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../release_notes_0.3.html">ACRN v0.3 (Nov 2018)</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../release_notes_0.3.html#version-0-3-new-features">Version 0.3 new features</a></li>
<li class="toctree-l3"><a class="reference internal" href="../release_notes_0.3.html#fixed-issues">Fixed Issues</a></li>
<li class="toctree-l3"><a class="reference internal" href="../release_notes_0.3.html#known-issues">Known Issues</a></li>
<li class="toctree-l3"><a class="reference internal" href="../release_notes_0.3.html#change-log">Change Log</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../release_notes_0.2.html">ACRN v0.2 (Sep 2018)</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../release_notes_0.2.html#version-0-2-new-features">Version 0.2 new features</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../release_notes_0.2.html#vt-x-vt-d">VT-x, VT-d</a></li>
<li class="toctree-l4"><a class="reference internal" href="../release_notes_0.2.html#pic-ioapic-msi-msi-x-pci-lapic">PIC/IOAPIC/MSI/MSI-X/PCI/LAPIC</a></li>
<li class="toctree-l4"><a class="reference internal" href="../release_notes_0.2.html#ethernet">Ethernet</a></li>
<li class="toctree-l4"><a class="reference internal" href="../release_notes_0.2.html#storage-emmc">Storage (eMMC)</a></li>
<li class="toctree-l4"><a class="reference internal" href="../release_notes_0.2.html#usb-xdci">USB (xDCI)</a></li>
<li class="toctree-l4"><a class="reference internal" href="../release_notes_0.2.html#usb-mediator-xhci-and-drd">USB Mediator (xHCI and DRD)</a></li>
<li class="toctree-l4"><a class="reference internal" href="../release_notes_0.2.html#csme">CSME</a></li>
<li class="toctree-l4"><a class="reference internal" href="../release_notes_0.2.html#wifi">WiFi</a></li>
<li class="toctree-l4"><a class="reference internal" href="../release_notes_0.2.html#ipu-mipi-cs2-hdmi-in">IPU (MIPI-CS2, HDMI-in)</a></li>
<li class="toctree-l4"><a class="reference internal" href="../release_notes_0.2.html#bluetooth">Bluetooth</a></li>
<li class="toctree-l4"><a class="reference internal" href="../release_notes_0.2.html#gpu-preemption">GPU  – Preemption</a></li>
<li class="toctree-l4"><a class="reference internal" href="../release_notes_0.2.html#gpu-display-surface-sharing-via-hyper-dma">GPU – display surface sharing via Hyper DMA</a></li>
<li class="toctree-l4"><a class="reference internal" href="../release_notes_0.2.html#s3">S3</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../release_notes_0.2.html#fixed-issues">Fixed Issues</a></li>
<li class="toctree-l3"><a class="reference internal" href="../release_notes_0.2.html#known-issues">Known Issues</a></li>
<li class="toctree-l3"><a class="reference internal" href="../release_notes_0.2.html#change-log">Change Log</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../release_notes_0.1.html">ACRN v0.1 (July 2018)</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../release_notes_0.1.html#version-0-1-new-features">Version 0.1 new features</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../release_notes_0.1.html#hardware-support">Hardware Support</a></li>
<li class="toctree-l4"><a class="reference internal" href="../release_notes_0.1.html#gvt-g-for-acrn">GVT-g for ACRN</a></li>
<li class="toctree-l4"><a class="reference internal" href="../release_notes_0.1.html#virtio-standard-is-supported">Virtio standard is supported</a></li>
<li class="toctree-l4"><a class="reference internal" href="../release_notes_0.1.html#device-pass-through-support">Device pass-through support</a></li>
<li class="toctree-l4"><a class="reference internal" href="../release_notes_0.1.html#hypervisor-configuration">Hypervisor configuration</a></li>
<li class="toctree-l4"><a class="reference internal" href="../release_notes_0.1.html#new-acrn-tools">New ACRN tools</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../release_notes_0.1.html#known-issues">Known Issues</a></li>
<li class="toctree-l3"><a class="reference internal" href="../release_notes_0.1.html#change-log">Change Log</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../faq.html">FAQ</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../faq.html#what-hardware-does-acrn-support">What hardware does ACRN support?</a></li>
<li class="toctree-l2"><a class="reference internal" href="../faq.html#clear-linux-os-fails-to-boot-on-my-nuc">Clear Linux* OS fails to boot on my NUC</a></li>
<li class="toctree-l2"><a class="reference internal" href="../faq.html#how-do-i-configure-acrn-s-memory-use">How do I configure ACRN’s memory use?</a></li>
</ul>
</li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Project ACRN™</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
          <li><a href="index.html">Developer Guides</a> &raquo;</li>
        
      <li>Developer Primer</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="developer-primer">
<span id="primer"></span><h1>Developer Primer<a class="headerlink" href="#developer-primer" title="Permalink to this headline">¶</a></h1>
<p>This Developer Primer introduces the fundamental components of ACRN and
the virtualization technology used by this open source reference stack.
Code level documentation and additional details can be found by
consulting the <a class="reference internal" href="../api/index.html#acrn-apis"><span class="std std-ref">API Documentation</span></a> documentation and the <a class="reference external" href="https://github.com/projectacrn">source code in
GitHub</a>.</p>
<p>The ACRN Hypervisor acts as a host with full control of the processor(s)
and the hardware (physical memory, interrupt management and I/O). It
provides the User OS with an abstraction of a virtual platform, allowing
the guest to behave as if were executing directly on a logical
processor.</p>
<div class="section" id="source-tree-structure">
<span id="id1"></span><h2>Source Tree Structure<a class="headerlink" href="#source-tree-structure" title="Permalink to this headline">¶</a></h2>
<p>Understanding the ACRN hypervisor and the ACRN device model source tree
structure is helpful for locating the code associated with a particular
hypervisor and device emulation feature.</p>
<p>The ACRN source code (and documentation) are maintained in the
<a class="reference external" href="https://github.com/projectacrn/acrn-hypervisor">https://github.com/projectacrn/acrn-hypervisor</a> repo, with the
hypervisor, device model, tools, and documentation in their own
folders:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>acrn-hypervisor
├─ hypervisor
├─ devicemodel
├─ tools
└─ doc
</pre></div>
</div>
<p>Here’s a brief description of each of these source tree folders:</p>
<div class="section" id="acrn-hypervisor-source-tree">
<h3>ACRN hypervisor source tree<a class="headerlink" href="#acrn-hypervisor-source-tree" title="Permalink to this headline">¶</a></h3>
<dl class="docutils">
<dt><strong>arch/x86/</strong></dt>
<dd>hypervisor architecture, which includes arch x86 related source files
to run the hypervisor, such as CPU, memory, interrupt, and VMX.</dd>
<dt><strong>boot/</strong></dt>
<dd>boot stuff mainly including ACPI related</dd>
<dt><strong>bsp/</strong></dt>
<dd>board support package, used to support NUC with UEFI</dd>
<dt><strong>common/</strong></dt>
<dd>common source files for hypervisor, which including VM hypercall
definition, VM main loop, and VM software loader</dd>
<dt><strong>debug/</strong></dt>
<dd>all debug related source files, which will not be compiled for
release version, mainly including console, uart, logmsg and shell</dd>
<dt><strong>include/</strong></dt>
<dd>include files for all public APIs (doxygen comments in these source
files are used to generate the <a class="reference internal" href="../api/index.html#acrn-apis"><span class="std std-ref">API Documentation</span></a> documentation)</dd>
<dt><strong>lib/</strong></dt>
<dd>runtime service libraries</dd>
</dl>
</div>
<div class="section" id="acrn-device-model-source-tree">
<h3>ACRN Device Model source tree<a class="headerlink" href="#acrn-device-model-source-tree" title="Permalink to this headline">¶</a></h3>
<dl class="docutils">
<dt><strong>arch/x86/</strong></dt>
<dd>architecture-specific source files needed for the devicemodel</dd>
<dt><strong>core/</strong></dt>
<dd>ACRN Device model core logic (main loop, SOS interface, etc.)</dd>
<dt><strong>hw/</strong></dt>
<dd><p class="first">Hardware emulation code, with the following subdirectories:</p>
<dl class="last docutils">
<dt><strong>pci/</strong></dt>
<dd>PCI devices, including VBS-Us (Virtio backend drivers in user-space).</dd>
<dt><strong>platform/</strong></dt>
<dd>platform devices such as uart, and keyboard.</dd>
</dl>
</dd>
<dt><strong>include/</strong></dt>
<dd>include files for all public APIs (doxygen comments in these source
files are used to generate the <a class="reference internal" href="../api/index.html#acrn-apis"><span class="std std-ref">API Documentation</span></a> documentation)</dd>
<dt><strong>samples/</strong></dt>
<dd>scripts (included in the Clear Linux OS build) for setting up the network
and launching the User OS on the platform.</dd>
</dl>
</div>
<div class="section" id="acrn-tools-source-tree">
<h3>ACRN Tools source tree<a class="headerlink" href="#acrn-tools-source-tree" title="Permalink to this headline">¶</a></h3>
<p>The tools folder holds source code for ACRN-provided tools such as:</p>
<dl class="docutils">
<dt>acrnlog</dt>
<dd>a userland tool to capture the log output from the currently running
hypervisor, and from the last previous run if the hypervisor crashed.</dd>
<dt>acrnctl</dt>
<dd>a utility to create, delete, list, launch, and stop a User OS (UOS).</dd>
<dt>acrntrace</dt>
<dd>a Service OS (SOS) utility to capture trace data and scripts to
analyze the collected data.</dd>
</dl>
</div>
<div class="section" id="acrn-documentation-source-tree">
<h3>ACRN documentation source tree<a class="headerlink" href="#acrn-documentation-source-tree" title="Permalink to this headline">¶</a></h3>
<p>Project ACRN documentation is written using the reStructuredText markup
language (.rst file extension) with Sphinx extensions, and processed
using Sphinx to create a formatted stand-alone website, (the one you’re
reading now.) Developers can view this content either in its raw form as
.rst markup files in the acrn-documentation repo, or you can generate
the HTML content and view it with a web browser directly on your
workstation, useful if you’re contributing documentation to the project.</p>
<dl class="docutils">
<dt><strong>api/</strong></dt>
<dd>ReST files for API document generation</dd>
<dt><strong>custom-doxygen/</strong></dt>
<dd>Customization files for doxygen-generated html output (while
generated, we currently don’t include the doxygen html output but do use
the XML output to feed into the Sphinx-generation process)</dd>
<dt><strong>getting_started/</strong></dt>
<dd>ReST files and images for the Getting Started Guide</dd>
<dt><strong>howtos/</strong></dt>
<dd>ReST files and images for Technical and Process how-to articles</dd>
<dt><strong>images/</strong></dt>
<dd>Image files not specific to a document (logos, and such)</dd>
<dt><strong>introduction/</strong></dt>
<dd>ReST files and images for the Introduction to Project ACRN</dd>
<dt><strong>primer/</strong></dt>
<dd>ReST files and images for the Developer Primer</dd>
<dt><strong>scripts/</strong></dt>
<dd>Files used to assist building the documentation set</dd>
<dt><strong>static/</strong></dt>
<dd>Sphinx folder for extras added to the generated output (such as custom
CSS additions)</dd>
<dt><strong>_templates/</strong></dt>
<dd>Sphinx configuration updates for the standard read-the-docs templates
used to format the generated HTML output</dd>
</dl>
</div>
</div>
<div class="section" id="cpu-virtualization">
<h2>CPU virtualization<a class="headerlink" href="#cpu-virtualization" title="Permalink to this headline">¶</a></h2>
<p>The ACRN hypervisor uses static partitioning of the physical CPU cores,
providing each User OS a virtualized environment containing at least one
statically assigned physical CPU core. The CPUID features for a
partitioned physical core is the same as the native CPU features. CPU
power management (Cx/Px) is managed by the User OS.</p>
<p>The supported Intel® NUC platform (see <a class="reference internal" href="../hardware.html#hardware"><span class="std std-ref">Supported Hardware</span></a>) has a CPU
with four cores. The Service OS is assigned one core and the other three
cores are assigned to the User OS. <code class="docutils literal notranslate"><span class="pre">XSAVE</span></code> and <code class="docutils literal notranslate"><span class="pre">XRSTOR</span></code> instructions
(used to perform a full save/restore of the extended state in the
processor to/from memory) are currently not supported in the User OS.
(The kernel boot parameters must specify <code class="docutils literal notranslate"><span class="pre">noxsave</span></code>). Processor core
sharing among User OSes is planned for a future release.</p>
<p>The following sections introduce CPU virtualization related
concepts and technologies.</p>
<div class="section" id="host-gdt">
<h3>Host GDT<a class="headerlink" href="#host-gdt" title="Permalink to this headline">¶</a></h3>
<p>The ACRN hypervisor initializes the host Global Descriptor Table (GDT),
used to define the characteristics of the various memory areas during
program execution. Code Segment <code class="docutils literal notranslate"><span class="pre">CS:0x8</span></code> and Data Segment <code class="docutils literal notranslate"><span class="pre">DS:0x10</span></code>
are configured as Hypervisor selectors, with their settings in host the
GDT as shown in <a class="reference internal" href="#id2"><span class="std std-numref">Figure 153</span></a>:</p>
<div class="figure align-center" id="id2">
<img alt="../_images/primer-host-gdt.png" src="../_images/primer-host-gdt.png" />
<p class="caption"><span class="caption-number">Figure 153 </span><span class="caption-text">Host GDT</span></p>
</div>
</div>
<div class="section" id="host-idt">
<h3>Host IDT<a class="headerlink" href="#host-idt" title="Permalink to this headline">¶</a></h3>
<p>The ACRN hypervisor installs interrupt gates for both Exceptions and
Vectors. That means exceptions and interrupts will automatically disable
interrupts. The <code class="docutils literal notranslate"><span class="pre">HOST_GDT_RING0_CODE_SEL</span></code> is used in the Host IDT
table.</p>
</div>
<div class="section" id="guest-smp-booting">
<h3>Guest SMP Booting<a class="headerlink" href="#guest-smp-booting" title="Permalink to this headline">¶</a></h3>
<p>The Bootstrap Processor (BSP) vCPU for the User OS boots into x64 long
mode directly, while the Application Processors (AP) vCPU boots into
real mode. The virtualized Local Advanced Programmable Interrupt
Controller (vLAPIC) for the User OS in the hypervisor emulates the
INIT/STARTUP signals.</p>
<p>The AP vCPU belonging to the User OS begins in an infinite loop, waiting
for an INIT signal.  Once the User OS issues a Startup IPI (SIPI) signal
to another vCPU, the vLAPIC traps the request, resets the target vCPU,
and then enters the <code class="docutils literal notranslate"><span class="pre">INIT-&gt;STARTUP#1-&gt;STARTUP#2</span></code> cycle to boot the
vCPUs for the User OS.</p>
</div>
<div class="section" id="vmx-configuration">
<h3>VMX configuration<a class="headerlink" href="#vmx-configuration" title="Permalink to this headline">¶</a></h3>
<p>ACRN hypervisor has the Virtual Machine configuration (VMX) shown in
<a class="reference internal" href="#vmx-msr"><span class="std std-numref">Table 4</span></a> below. (These configuration settings may change in the future, according to
virtualization policies.)</p>
<table border="1" class="colwidths-auto docutils align-center" id="vmx-msr">
<caption><span class="caption-number">Table 4 </span><span class="caption-text">VMX Configuration</span><a class="headerlink" href="#vmx-msr" title="Permalink to this table">¶</a></caption>
<thead valign="bottom">
<tr class="row-odd"><th class="head"><strong>VMX MSR</strong></th>
<th class="head"><strong>Bits</strong></th>
<th class="head"><strong>Description</strong></th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td rowspan="3"><strong>MSR_IA32_VMX_PINBASED_CTLS</strong></td>
<td>Bit0 set</td>
<td>Enable External IRQ VM Exit</td>
</tr>
<tr class="row-odd"><td>Bit6 set</td>
<td>Enable HV pre-40ms Preemption timer</td>
</tr>
<tr class="row-even"><td>Bit7 clr</td>
<td>Post interrupt did not support</td>
</tr>
<tr class="row-odd"><td rowspan="3"><strong>MSR_IA32_VMX_PROCBASED_CTLS</strong></td>
<td>Bit25 set</td>
<td>Enable I/O bitmap</td>
</tr>
<tr class="row-even"><td>Bit28 set</td>
<td>Enable MSR bitmap</td>
</tr>
<tr class="row-odd"><td>Bit19,20 set</td>
<td>Enable CR8 store/load</td>
</tr>
<tr class="row-even"><td rowspan="2"><strong>MSR_IA32_VMX_PROCBASED_CTLS2</strong></td>
<td>Bit1 set</td>
<td>Enable EPT</td>
</tr>
<tr class="row-odd"><td>Bit7 set</td>
<td>Allow guest real mode</td>
</tr>
<tr class="row-even"><td rowspan="4"><strong>MSR_IA32_VMX_EXIT_CTLS</strong></td>
<td>Bit15</td>
<td>VMX Exit auto ack vector</td>
</tr>
<tr class="row-odd"><td>Bit18,19</td>
<td>MSR IA32_PAT save/load</td>
</tr>
<tr class="row-even"><td>Bit20,21</td>
<td>MSR IA32_EFER save/load</td>
</tr>
<tr class="row-odd"><td>Bit9</td>
<td>64-bit mode after VM Exit</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="cpuid-and-guest-tsc-calibration">
<h3>CPUID and Guest TSC calibration<a class="headerlink" href="#cpuid-and-guest-tsc-calibration" title="Permalink to this headline">¶</a></h3>
<p>User OS access to CPUID will be trapped by ACRN hypervisor, however
the ACRN hypervisor will pass through most of the native CPUID
information to the guest, except the virtualized CPUID 0x1 (to
provide fake x86_model).</p>
<p>The Time Stamp Counter (TSC) is a 64-bit register present on all x86
processors that counts the number of cycles since reset. ACRN hypervisor
also virtualizes <code class="docutils literal notranslate"><span class="pre">MSR_PLATFORM_INFO</span></code> and <code class="docutils literal notranslate"><span class="pre">MSR_ATOM_FSB_FREQ</span></code>.</p>
</div>
<div class="section" id="rdtsc-rdtscp">
<h3>RDTSC/RDTSCP<a class="headerlink" href="#rdtsc-rdtscp" title="Permalink to this headline">¶</a></h3>
<p>User OS vCPU reads of <code class="docutils literal notranslate"><span class="pre">RDTSC</span></code>, <code class="docutils literal notranslate"><span class="pre">RDTSCP</span></code>, or <code class="docutils literal notranslate"><span class="pre">MSR_IA32_TSC_AUX</span></code>
will not make the VM Exit to the hypervisor. Thus the vCPUID provided by
<code class="docutils literal notranslate"><span class="pre">MSR_IA32_TSC_AUX</span></code> can be changed via the User OS.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">RDTSCP</span></code> instruction is widely used by the ACRN hypervisor to
identify the current CPU (and read the current value of the processor’s
time-stamp counter). Because there is no VM Exit for
<code class="docutils literal notranslate"><span class="pre">MSR_IA32_TSC_AUX</span></code> msr register, the hypervisor will save and restore
the <code class="docutils literal notranslate"><span class="pre">MSR_IA32_TSC_AUX</span></code> value on every VM Exit and Enter. Before the
hypervisor restores the host CPU ID, we must not use a <code class="docutils literal notranslate"><span class="pre">RDTSCP</span></code>
instruction because it would return the vCPU ID instead of host CPU ID.</p>
</div>
<div class="section" id="cr-register-virtualization">
<h3>CR Register virtualization<a class="headerlink" href="#cr-register-virtualization" title="Permalink to this headline">¶</a></h3>
<p>Guest CR8 access will make the VM Exit, and is emulated in the
hypervisor for vLAPIC to update its PPR register. Guest access to CR3
will not make the VM Exit.</p>
</div>
<div class="section" id="msr-bitmap">
<h3>MSR BITMAP<a class="headerlink" href="#msr-bitmap" title="Permalink to this headline">¶</a></h3>
<p>In the ACRN hypervisor, only these module-specific registers (MSR) are
supported:</p>
<dl class="docutils">
<dt><strong>MSR_IA32_TSC_DEADLINE</strong></dt>
<dd>emulates Guest TSC timer program</dd>
<dt><strong>MSR_PLATFORM_INFO</strong></dt>
<dd>emulates a fake X86 module</dd>
<dt><strong>MSR_ATOM_FSB_FREQ</strong></dt>
<dd>provides the CPU frequency directly via this MSR to avoid TSC calibration</dd>
</dl>
</div>
<div class="section" id="i-o-bitmap">
<h3>I/O BITMAP<a class="headerlink" href="#i-o-bitmap" title="Permalink to this headline">¶</a></h3>
<p>All User OS I/O port accesses are trapped into the ACRN hypervisor by
default. Most of the Service OS I/O port accesses are not trapped into
the ACRN hypervisor, allowing the Service OS direct access to the
hardware port.</p>
<p>The Service OS I/O trap policy is:</p>
<dl class="docutils">
<dt><strong>0x3F8/0x3FC</strong></dt>
<dd>for emulated vUART inside hypervisor for SOS only, will be trapped</dd>
<dt><strong>0x20/0xA0/0x460</strong></dt>
<dd>for vPIC emulation in hypervisor, will be trapped</dd>
<dt><strong>0xCF8/0xCFC</strong></dt>
<dd>for hypervisor PCI device interception, will be trapped</dd>
</dl>
</div>
<div class="section" id="exceptions">
<h3>Exceptions<a class="headerlink" href="#exceptions" title="Permalink to this headline">¶</a></h3>
<p>The User OS handles its exceptions inside the VM, including page fault,
GP, etc. A #MC and #DB exception causes a VM Exit to the ACRN hypervisor
console.</p>
</div>
</div>
<div class="section" id="memory-virtualization">
<h2>Memory virtualization<a class="headerlink" href="#memory-virtualization" title="Permalink to this headline">¶</a></h2>
<p>ACRN hypervisor provides memory virtualization by using a static
partition of system memory. Each virtual machine owns its own contiguous
partition of memory, with the Service OS staying in lower memory and the
User OS instances in high memory. (High memory is memory which is not
permanently mapped in the kernel address space, while Low Memory is
always mapped, so you can access it in the kernel simply by
dereferencing a pointer.) In future implementations, this will evolve to
utilize EPT/VT-d.</p>
<p>ACRN hypervisor memory is not visible to any User OS. In the ACRN
hypervisor, there are a few memory accesses that need to work
efficiently:</p>
<ul class="simple">
<li>ACRN hypervisor to access host memory</li>
<li>vCPU per VM to access guest memory</li>
<li>vCPU per VM to access host memory</li>
<li>vCPU per VM to access MMIO memory</li>
</ul>
<p>The rest of this section introduces how these kinds of memory accesses
are managed.  It gives an overview of physical memory layout,
Paravirtualization (MMU) memory mapping in the hypervisor and VMs, and
Host-Guest Extended Page Table (EPT) memory mapping for each VM.</p>
<div class="section" id="physical-memory-layout">
<h3>Physical Memory Layout<a class="headerlink" href="#physical-memory-layout" title="Permalink to this headline">¶</a></h3>
<p>The Physical Memory Layout Example for Service OS &amp; User OS is shown in
<a class="reference internal" href="#primer-mem-layout"><span class="std std-numref">Figure 154</span></a> below:</p>
<div class="figure align-center" id="primer-mem-layout">
<img alt="../_images/primer-mem-layout.png" src="../_images/primer-mem-layout.png" />
<p class="caption"><span class="caption-number">Figure 154 </span><span class="caption-text">Memory Layout</span></p>
</div>
<p><a class="reference internal" href="#primer-mem-layout"><span class="std std-numref">Figure 154</span></a> shows an example of physical memory layout
of the Service and User OS. The Service OS accepts the whole e820 table
(all usable memory address ranges not reserved for use by the BIOS)
after filtering out the Hypervisor memory too. From the SOS’s point of
view, it takes control of all available physical memory, including User
OS memory, not used by the hypervisor (or BIOS). Each User OSes memory
is allocated from (High) SOS memory and the User OS only owns this
section of memory control.</p>
<p>Some of the physical memory of a 32-bit machine, needs to be sacrificed
by making it hidden so memory-mapped I/O (MMIO) devices have room to
communicate. This creates an MMIO hole for VMs to access some range of
MMIO addresses directly for communicating to devices; or they may need
the hypervisor to trap some range of MMIO to do device emulation. This
access control is done through EPT mapping.</p>
</div>
<div class="section" id="pv-mmu-memory-mapping-in-the-hypervisor">
<h3>PV (MMU) Memory Mapping in the Hypervisor<a class="headerlink" href="#pv-mmu-memory-mapping-in-the-hypervisor" title="Permalink to this headline">¶</a></h3>
<div class="figure align-center" id="primer-pv-mapping">
<img alt="../_images/primer-pv-mapping.png" src="../_images/primer-pv-mapping.png" />
<p class="caption"><span class="caption-number">Figure 155 </span><span class="caption-text">ACRN Hypervisor PV Mapping Example</span></p>
</div>
<p>The ACRN hypervisor is trusted and can access and control all system
memory, as shown in <a class="reference internal" href="#primer-pv-mapping"><span class="std std-numref">Figure 155</span></a>. Because the hypervisor
is running in protected mode, an MMU page table must be prepared for its
PV translation. To simplify things, the PV translation page table is set
as a 1:1 mapping.  Some MMIO range mappings could be removed if they are
not needed. This PV page table is created when the hypervisor memory is
first initialized.</p>
</div>
<div class="section" id="pv-mmu-memory-mapping-in-vms">
<h3>PV (MMU) Memory Mapping in VMs<a class="headerlink" href="#pv-mmu-memory-mapping-in-vms" title="Permalink to this headline">¶</a></h3>
<p>As mentioned earlier, the Primary vCPU starts to run in protected mode
when its VM is started. But before it begins, a temporary PV (MMU) page
table must be prepared..</p>
<p>This page table is a 1:1 mapping for 4 Gb, and only lives for a short
time when the vCPU first runs. After the vCPU starts to run its kernel
image (for example Linux*), the kernel will create its own PV page
tables, after which, the temporary page table will be obsoleted.</p>
</div>
<div class="section" id="host-guest-ept-memory-mapping">
<h3>Host-Guest (EPT) Memory Mapping<a class="headerlink" href="#host-guest-ept-memory-mapping" title="Permalink to this headline">¶</a></h3>
<p>The VMs (both SOS and UOS) need to create an Extended Page Table (EPT) to
access the host physical memory based on its guest physical memory. The
guest VMs also need to set an MMIO trap to trigger EPT violations for
device emulation (such as IOAPIC, and LAPIC).  This memory layout is
shown in <a class="reference internal" href="#primer-sos-ept-mapping"><span class="std std-numref">Figure 156</span></a>:</p>
<div class="figure align-center" id="primer-sos-ept-mapping">
<img alt="../_images/primer-sos-ept-mapping.png" src="../_images/primer-sos-ept-mapping.png" />
<p class="caption"><span class="caption-number">Figure 156 </span><span class="caption-text">SOS EPT Mapping Example</span></p>
</div>
<p>The SOS takes control of all the host physical memory space: its EPT
mapping covers almost all of the host memory except that reserved for
the hypervisor (HV) and a few MMIO trap ranges for IOAPIC &amp; LAPIC
emulation. The guest to host mapping for SOS is 1:1.</p>
<div class="figure align-center" id="primer-uos-ept-mapping">
<img alt="../_images/primer-uos-ept-mapping.png" src="../_images/primer-uos-ept-mapping.png" />
<p class="caption"><span class="caption-number">Figure 157 </span><span class="caption-text">UOS EPT Mapping Example</span></p>
</div>
<p>However, for the UOS, its memory EPT mapping is linear but with an
offset (as shown in <a class="reference internal" href="#primer-uos-ept-mapping"><span class="std std-numref">Figure 157</span></a>).  The MMIO hole is
not mapped to trap all MMIO accesses from the UOS (and do emulating in
the device model). To support pass through devices in the future, some
MMIO range mapping may be added.</p>
</div>
</div>
<div class="section" id="graphic-mediation">
<span id="id3"></span><h2>Graphic mediation<a class="headerlink" href="#graphic-mediation" title="Permalink to this headline">¶</a></h2>
<p>Intel® Graphics Virtualization Technology –g (Intel® GVT-g)
provides GPU sharing capability to multiple VMs by using a mediated
pass-through technique. This allows a VM to access performance critical
I/O resources (usually partitioned) directly, without intervention from
the hypervisor in most cases.</p>
<p>Privileged operations from this VM are trap-and-emulated to provide
secure isolation among VMs. The Hypervisor must ensure that no
vulnerability is exposed when assigning performance-critical resource to
each VM. When a performance-critical resource cannot be partitioned, a
scheduler must be implemented (either in software or hardware) to allow
time-based sharing among multiple VMs. In this case, the device must
allow the hypervisor to save and restore the hardware state associated
with the shared resource, either through direct I/O register read/write
(when there is no software invisible state) or through a device-specific
context save/restore mechanism (where there is a software invisible
state).</p>
<p>In the initial release of Project ACRN, graphic mediation is not
enabled, and is planned for a future release.</p>
</div>
<div class="section" id="i-o-emulation">
<h2>I/O emulation<a class="headerlink" href="#i-o-emulation" title="Permalink to this headline">¶</a></h2>
<p>The I/O path is explained in the <a class="reference internal" href="../introduction/index.html#acrn-io-mediator"><span class="std std-ref">ACRN I/O mediator</span></a> section of the
<a class="reference internal" href="../introduction/index.html#introduction"><span class="std std-ref">Introduction to Project ACRN</span></a>.  The following sections, provide additional device
assignment management and PIO/MMIO trap flow introduction.</p>
<div class="section" id="device-assignment-management">
<h3>Device Assignment Management<a class="headerlink" href="#device-assignment-management" title="Permalink to this headline">¶</a></h3>
<p>ACRN hypervisor provides major device assignment management. Since the
hypervisor owns all native vectors and IRQs, there must be a mapping
table to handle the Guest IRQ/Vector to Host IRQ/Vector. Currently we
assign all devices to SOS_VM except the UART.</p>
<p>If a PCI device (with MSI/MSI-x) is assigned to Guest, the User OS will
program the PCI config space and set the guest vector to this device. A
Hypercall <code class="docutils literal notranslate"><span class="pre">HC_VM_PCI_MSIX_REMAP</span></code> is provided. Once the guest programs
the guest vector, the Service OS may call this hypercall to notify the ACRN
hypervisor. The hypervisor allocates a host vector, creates a guest-host
mapping relation, and replaces the guest vector with a real native
vector for the device:</p>
<dl class="docutils">
<dt><strong>PCI MSI/MSI-X</strong></dt>
<dd>PCI Message Signaled Interrupts (MSI/MSX-x) from
devices can be triggered from a hypercall when a guest program
vectors. All PCI devices are programed with real vectors
allocated by the Hypervisor.</dd>
<dt><strong>PCI/INTx</strong></dt>
<dd>Device assignment is triggered when the guest programs
the virtual Advanced I/O Programmable Interrupt Controller
(vIOAPC) Redirection Table Entries (RTE).</dd>
<dt><strong>Legacy</strong></dt>
<dd>Legacy devices are assigned to SOS_VM.</dd>
</dl>
<p>User OS device assignment is similar to the above, except the User OS
doesn’t call hypercall. Instead, the Guest program PCI configuration
space will be trapped into the Device Module, and Device Module may
issue hypercall to notify hypervisor the guest vector is changing.</p>
<p>Currently, there are two types of I/O Emulation supported: MMIO and
PORTIO trap handling. MMIO emulation is triggered by an EPT violation
VMExit only. If there is an EPT misconfiguration and VMExit occurs, the
hypervisor will halt the system. (Because the hypervisor set up all EPT
page table mapping at the beginning of the Guest boot, there should not
be an EPT misconfiguration.)</p>
<p>There are multiple places where I/O emulation can happen - in ACRN
hypervisor, Service OS Kernel VHM module, or in the Service OS Userland
ACRN Device Module.</p>
</div>
<div class="section" id="pio-mmio-trap-flow">
<h3>PIO/MMIO trap Flow<a class="headerlink" href="#pio-mmio-trap-flow" title="Permalink to this headline">¶</a></h3>
<p>Here is a description of the PIO/MMIO trap flow:</p>
<ol class="arabic simple">
<li>Instruction decoder: get the Guest Physical Address (GPA) from VM
Exit, go through gla2gpa() page walker if necessary.</li>
<li>Emulate the instruction. Here the hypervisor will have an address
range check to see if the hypervisor is interested in this IO
port or MMIO GPA access.</li>
<li>Hypervisor emulates vLAPIC, vIOAPIC, vPIC, and vUART only (for
Service OS only). Any other emulation request are forwarded to
the SOS for handling. The vCPU raising the I/O request will
halt until this I/O request is processed successfully. An IPI will
send to vCPU0 of SOS to notify there is an I/O request waiting for
service.</li>
<li>Service OS VHM module takes the I/O request and dispatches the request
to multiple clients. These clients could be SOS kernel space
VBS-K, MPT, or User-land Device model. VHM I/O request server
selects a default fallback client responsible to handle any I/O
request not handled by other clients. (The Device Manager is the
default fallback client.) Each client needs to register its I/O
range or specific PCI bus/device/function (BDF) numbers. If an I/O
request falls into the client range, the I/O request server will
send the request to that client.</li>
<li>Multiple clients - fallback client (Device Model in user-land),
VBS-K client, MPT client.
Once the I/O request emulation completes, the client updates the
request status and notifies the hypervisor by a hypercall.
Hypervisor picks up that request, do any necessary cleanup,
and resume the Guest vCPU.</li>
</ol>
<p>Most I/O emulation tasks are done by the SOS CPU, and requests come from
UOS vCPUs.</p>
</div>
</div>
<div class="section" id="virtual-interrupt">
<h2>Virtual interrupt<a class="headerlink" href="#virtual-interrupt" title="Permalink to this headline">¶</a></h2>
<p>All interrupts received by the User OS comes from a virtual interrupt
injected by a virtual vLAPIC, vIOAPIC, or vPIC. All device emulation is
done inside the SOS Userspace device model. However for performance
consideration, vLAPIC, vIOAPIC, and vPIC devices are emulated inside the
ACRN hypervisor directly. From the guest point of view, vPIC uses
Virtual Wire Mode via vIOAPIC.</p>
<p>The symmetric I/O Mode is shown in <a class="reference internal" href="#primer-symmetric-io"><span class="std std-numref">Figure 158</span></a>:</p>
<div class="figure align-center" id="primer-symmetric-io">
<img alt="../_images/primer-symmetric-io.png" src="../_images/primer-symmetric-io.png" />
<p class="caption"><span class="caption-number">Figure 158 </span><span class="caption-text">Symmetric I/O Mode</span></p>
</div>
<dl class="docutils">
<dt><strong>Kernel boot param with vPIC</strong></dt>
<dd>add “maxcpu=0” to User OS to use PIC</dd>
<dt><strong>Kernel boot param with vIOAPIC</strong></dt>
<dd>add “maxcpu=1” (as long as not “0”) User OS will use IOAPIC. Keep
IOAPIC pin2 as source of PIC.</dd>
</dl>
<div class="section" id="virtual-lapic">
<h3>Virtual LAPIC<a class="headerlink" href="#virtual-lapic" title="Permalink to this headline">¶</a></h3>
<p>The LAPIC (Local Advanced Programmable interrupt Controller) is
virtualized for SOS or UOS. The vLAPIC is currently emulated by a Guest
MMIO trap to GPA address range: 0xFEE00000 - 0xFEE100000 (1MB). ACRN
hypervisor will support APIC-v and Post interrupts in a future release.</p>
<p>vLAPIC provides the same feature as a native LAPIC:</p>
<ul class="simple">
<li>Mask/Unmask vectors</li>
<li>Inject virtual vectors (Level or Edge trigger mode) to vCPU</li>
<li>Notify vIOAPIC of EOI processing</li>
<li>Provide TSC Timer service</li>
<li>vLAPIC support CR8 to update TPR</li>
<li>INIT/STARTUP handling</li>
</ul>
</div>
<div class="section" id="virtual-ioapic">
<h3>Virtual IOAPIC<a class="headerlink" href="#virtual-ioapic" title="Permalink to this headline">¶</a></h3>
<p>A vIOAPIC is emulated by the hypervisor when the Guest accesses MMIO GPA
Range: 0xFEC00000 - 0xFEC01000. The vIOAPIC for the SOS will match the
same pin numbers as the native HW IOAPIC. The vIOAPIC for UOS only
provides 24 Pins. When a vIOAPIC PIN is asserted, the vIOAPIC calls
vLAPIC APIs to inject the vector to the Guest.</p>
</div>
<div class="section" id="virtual-pic">
<h3>Virtual PIC<a class="headerlink" href="#virtual-pic" title="Permalink to this headline">¶</a></h3>
<p>A vPIC is required for TSC calculation. Normally the UOS boots with a
vIOAPIC. A vPIC is a source of external interrupts to the Guest. On
every VMExit, the hypervisor checks if there are pending external PIC
interrupts.</p>
</div>
<div class="section" id="virtual-interrupt-injection">
<h3>Virtual Interrupt Injection<a class="headerlink" href="#virtual-interrupt-injection" title="Permalink to this headline">¶</a></h3>
<p>The source of virtual interrupts comes from either the Device Module or
from assigned devices:</p>
<dl class="docutils">
<dt><strong>SOS assigned devices</strong></dt>
<dd>As we assigned all devices to SOS directly whenever a devices’
physical interrupts come, we inject the corresponding virtual interrupts
to SOS via the vLAPIC/vIOAPIC.  In this case, the SOS doesn’t use the
vPIC and does not have emulated devices.</dd>
<dt><strong>UOS assigned devices</strong></dt>
<dd>Only PCI devices are assigned to UOS, and virtual interrupt injection
follows the same way as the SOS. A virtual interrupt injection operation
is triggered when a device’s physical interrupt is triggered.</dd>
<dt><strong>UOS emulated devices</strong></dt>
<dd>Device Module (user-land Device Model) is responsible for UOS emulated
devices’ interrupt lifecycle management. The Device Model knows when an
emulated device needs to assert a virtual IOPAIC/PIC Pin or needs to
send a virtual MSI vector to the Guest. This logic is entirely handled
by the Device Model.</dd>
</dl>
<p><a class="reference internal" href="#primer-hypervisor-interrupt"><span class="std std-numref">Figure 159</span></a> shows how the hypervisor handles
interrupt processing and pending interrupts (acrn_do_intr_process):</p>
<div class="figure align-center" id="primer-hypervisor-interrupt">
<img alt="../_images/primer-hypervisor-interrupt.png" src="../_images/primer-hypervisor-interrupt.png" />
<p class="caption"><span class="caption-number">Figure 159 </span><span class="caption-text">Hypervisor Interrupt handler</span></p>
</div>
<p>There are many cases where the Guest RFLAG.IF is cleared and interrupts
are disabled. The hypervisor will check if the Guest IRQ window is
available before injection. NMI is unmasked interrupt injection
regardless of existing guest IRQ window status. If the current IRQ
windows is not available, hypervisor enables
<code class="docutils literal notranslate"><span class="pre">MSR_IA32_VMX_PROCBASED_CTLS_IRQ_WIN</span></code> (PROCBASED_CTRL.bit[2]) and
VMEnter directly. The injection will be done on next VMExit once the
Guest issues STI (GuestRFLAG.IF=1).</p>
</div>
</div>
<div class="section" id="vt-x-and-vt-d">
<h2>VT-x and VT-d<a class="headerlink" href="#vt-x-and-vt-d" title="Permalink to this headline">¶</a></h2>
<p>Since 2006, Intel CPUs have supported hardware assist - VT-x
instructions, where the CPU itself traps specific guest instructions and
register accesses directly into the VMM without need for binary
translation (and modification) of the guest operating system. Guest
operating systems can be run natively without modification, although it
is common to still install virtualization-aware para-virtualized drivers
into the guests to improve functionality. One common example is access
to storage via emulated SCSI devices.</p>
<p>Intel CPUs and chipsets support various Virtualization Technology (VT)
features - such as VT-x and VT-d. Physical events on the platform
trigger CPU <strong>VM Exits</strong> (a trap into the VMM) to handle physical
events such as physical device interrupts,</p>
<p>In the ACRN hypervisor design, VT-d can be used to do DMA Remapping,
such as Address translation and Isolation.
<a class="reference internal" href="#primer-dma-address-mapping"><span class="std std-numref">Figure 160</span></a> is an example of address
translation:</p>
<div class="figure align-center" id="primer-dma-address-mapping">
<img alt="../_images/primer-dma-address-mapping.png" src="../_images/primer-dma-address-mapping.png" />
<p class="caption"><span class="caption-number">Figure 160 </span><span class="caption-text">DMA address mapping</span></p>
</div>
</div>
<div class="section" id="hypercall">
<h2>Hypercall<a class="headerlink" href="#hypercall" title="Permalink to this headline">¶</a></h2>
<p>ACRN hypervisor currently supports less than a dozen
<a class="reference internal" href="../api/hypercall_api.html#hypercall-apis"><span class="std std-ref">Hypercall APIs</span></a> and VHM upcall APIs to support the necessary VM
management, IO request distribution and guest memory mappings. The
hypervisor and Service OS (SOS) reserve vector 0xF4 for hypervisor
notification to the SOS. This upcall is necessary whenever device
emulation is required by the SOS.  The upcall vector 0xF4 is injected to
SOS vCPU0.</p>
<p>Refer to the <a class="reference internal" href="../api/index.html#acrn-apis"><span class="std std-ref">API Documentation</span></a> documentation for details.</p>
</div>
<div class="section" id="device-emulation">
<h2>Device emulation<a class="headerlink" href="#device-emulation" title="Permalink to this headline">¶</a></h2>
<p>The ACRN Device Model emulates different kinds of platform devices, such as
RTC, LPC, UART, PCI device, and Virtio block device. The most important
thing about device emulation is to handle the I/O request from different
devices. The I/O request could be PIO, MMIO, or PCI CFG SPACE access. For
example:</p>
<ul class="simple">
<li>a CMOS RTC device may access 0x70/0x71 PIO to get the CMOS time,</li>
<li>a GPU PCI device may access its MMIO or PIO BAR space to complete
its frame buffer rendering, or</li>
<li>the bootloader may access PCI devices’ CFG
SPACE for BAR reprogramming.</li>
</ul>
<p>ACRN Device Model injects interrupts/MSIs to its frontend devices when
necessary as well, for example, a RTC device needs to get its ALARM
interrupt or a PCI device with MSI capability needs to get its MSI. The
Data Model also provides a PIRQ routing mechanism for platform devices.</p>
</div>
<div class="section" id="virtio-devices">
<h2>Virtio Devices<a class="headerlink" href="#virtio-devices" title="Permalink to this headline">¶</a></h2>
<p>This section introduces the Virtio devices supported by ACRN.  Currently
all the Back-end Virtio drivers are implemented using the Virtio APIs
and the FE drivers are re-using Linux standard Front-end Virtio drivers.</p>
<div class="section" id="virtio-rnd">
<h3>Virtio-rnd<a class="headerlink" href="#virtio-rnd" title="Permalink to this headline">¶</a></h3>
<p>The Virtio-rnd entropy device supplies high-quality randomness for guest
use. The Virtio device ID of the Virtio-rnd device is 4, and supports
one virtqueue of 64 entries (configurable in the source code). No
feature bits are defined.</p>
<p>When the FE driver requires random bytes, the BE device places bytes of
random data onto the virtqueue.</p>
<p>To launch the Virtio-rnd device, you can use the following command:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>./acrn-dm -A -m 1168M <span class="se">\</span>
   -s <span class="m">0</span>:0,hostbridge <span class="se">\</span>
   -s <span class="m">1</span>,virtio-blk,./uos.img <span class="se">\</span>
   -s <span class="m">2</span>,virtio-rnd <span class="se">\</span>
   -k bzImage <span class="se">\</span>
   -B <span class="s2">&quot;root=/dev/vda rw rootwait noxsave maxcpus=0 nohpet \</span>
<span class="s2">       console=hvc0 no_timer_check ignore_loglevel \</span>
<span class="s2">       log_buf_len=16M consoleblank=0 tsc=reliable&quot;</span> vm1
</pre></div>
</div>
<p>To verify the result in user OS side, you can use the following command:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>od /dev/random
</pre></div>
</div>
</div>
<div class="section" id="virtio-blk">
<h3>Virtio-blk<a class="headerlink" href="#virtio-blk" title="Permalink to this headline">¶</a></h3>
<p>The Virtio-blk device is a simple virtual block device. The FE driver
will place read, write, and other requests onto the virtqueue, so that
the BE driver can process them accordingly.</p>
<p>The Virtio device ID of the Virtio-blk is 2, and it supports one
virtqueue with 64 entries, configurable in the source code. The feature
bits supported by the BE device are as follows:</p>
<dl class="docutils">
<dt><strong>VTBLK_F_SEG_MAX(bit 2)</strong></dt>
<dd>Maximum number of segments in a request is in seg_max.</dd>
<dt><strong>VTBLK_F_BLK_SIZE(bit 6)</strong></dt>
<dd>block size of disk is in blk_size.</dd>
<dt><strong>VTBLK_F_FLUSH(bit 9)</strong></dt>
<dd>cache flush command support.</dd>
<dt><strong>VTBLK_F_TOPOLOGY(bit 10)</strong></dt>
<dd>device exports information on optimal I/O alignment.</dd>
</dl>
<p>To use the Virtio-blk device, use the following command:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>./acrn-dm -A -m 1168M <span class="se">\</span>
   -s <span class="m">0</span>:0,hostbridge <span class="se">\</span>
   -s <span class="m">1</span>,virtio-blk,./uos.img** <span class="se">\</span>
   -k bzImage -B <span class="s2">&quot;root=/dev/vda rw rootwait noxsave maxcpus=0 \</span>
<span class="s2">      nohpet console=hvc0 no_timer_check ignore_loglevel \</span>
<span class="s2">      log_buf_len=16M consoleblank=0 tsc=reliable&quot;</span> vm1
</pre></div>
</div>
<p>To verify the result, you should expect the user OS to boot
successfully.</p>
</div>
<div class="section" id="virtio-net">
<h3>Virtio-net<a class="headerlink" href="#virtio-net" title="Permalink to this headline">¶</a></h3>
<p>The Virtio-net device is a virtual Ethernet device. The Virtio device ID
of the Virtio-net is 1. The Virtio-net device supports two virtqueues,
one for transmitting packets and the other for receiving packets. The
FE driver will place empty buffers onto one virtqueue for receiving
packets, and enqueue outgoing packets onto the other virtqueue for
transmission. Currently the size of each virtqueue is 1000, configurable
in the source code.</p>
<p>To access the external network from user OS, a L2 virtual switch should
be created in the service OS, and the BE driver is bonded to a tap/tun
device linking under the L2 virtual switch. See
<a class="reference internal" href="#primer-virtio-net"><span class="std std-numref">Figure 161</span></a>:</p>
<div class="figure align-center" id="primer-virtio-net">
<img alt="../_images/primer-virtio-net.png" src="../_images/primer-virtio-net.png" />
<p class="caption"><span class="caption-number">Figure 161 </span><span class="caption-text">Accessing external network from User OS</span></p>
</div>
<p>Currently the feature bits supported by the BE device are:</p>
<dl class="docutils">
<dt><strong>VIRTIO_NET_F_MAC(bit 5)</strong></dt>
<dd>device has given MAC address.</dd>
<dt><strong>VIRTIO_NET_F_MRG_RXBUF(bit 15)</strong></dt>
<dd>BE driver can merge receive buffers.</dd>
<dt><strong>VIRTIO_NET_F_STATUS(bit 16)</strong></dt>
<dd>configuration status field is available.</dd>
<dt><strong>VIRTIO_F_NOTIFY_ON_EMPTY(bit 24)</strong></dt>
<dd>device will issue an interrupt if it runs out of available
descriptors on a virtqueue.</dd>
</dl>
<p>To enable the Virtio-net device, use the following command:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>./acrn-dm -A -m 1168M <span class="se">\</span>
   -s <span class="m">0</span>:0,hostbridge <span class="se">\</span>
   -s <span class="m">1</span>,virtio-blk,./uos.img <span class="se">\</span>
   -s <span class="m">2</span>,virtio-net,tap0 <span class="se">\</span>
   -k bzImage -B <span class="s2">&quot;root=/dev/vda rw rootwait noxsave maxcpus=0 \</span>
<span class="s2">      nohpet console=hvc0 no_timer_check ignore_loglevel \</span>
<span class="s2">      log_buf_len=16M consoleblank=0 tsc=reliable&quot;</span> vm1
</pre></div>
</div>
<p>To verify the correctness of the device, the external
network should be accessible from the user OS.</p>
</div>
<div class="section" id="virtio-console">
<h3>Virtio-console<a class="headerlink" href="#virtio-console" title="Permalink to this headline">¶</a></h3>
<p>The Virtio-console device is a simple device for data input and output.
The Virtio device ID of the Virtio-console device is 3. A device could
have from one to 16 ports. Each port has a pair of input and output
virtqueues used to communicate information between the FE and BE
drivers. Currently the size of each virtqueue is 64, configurable in the
source code.</p>
<p>Similar to Virtio-net device, the two virtqueues specific to a port are
for transmitting virtqueue and receiving virtqueue. The FE driver will
place empty buffers onto the receiving virtqueue for incoming data, and
enqueue outgoing characters onto transmitting virtqueue.</p>
<p>Currently the feature bits supported by the BE device are:</p>
<dl class="docutils">
<dt><strong>VTCON_F_SIZE(bit 0)</strong></dt>
<dd>configuration columns and rows are valid.</dd>
<dt><strong>VTCON_F_MULTIPORT(bit 1)</strong></dt>
<dd>device supports multiple ports, and control virtqueues will be used.</dd>
<dt><strong>VTCON_F_EMERG_WRITE(bit 2)</strong></dt>
<dd>device supports emergency write.</dd>
</dl>
<p>Virtio-console supports redirecting guest output to various backend
devices, including stdio/pty/tty. Users could follow the syntax below to
specify which backend to use:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>virtio-console,[@]stdio\|tty\|pty:portname[=portpath][,[@]stdio\|tty\|pty:portname[=portpath]]
</pre></div>
</div>
<p>For example, to use stdio as a Virtio-console backend, use the following
command:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>./acrn-dm -A -m 1168M <span class="se">\</span>
   -s <span class="m">0</span>:0,hostbridge <span class="se">\</span>
   -s <span class="m">1</span>,virtio-blk,./uos.img <span class="se">\</span>
   -s <span class="m">3</span>,virtio-console,@stdio:stdio<span class="se">\_</span>port <span class="se">\</span>
   -k bzImage -B <span class="s2">&quot;root=/dev/vda rw rootwait noxsave maxcpus=0 \</span>
<span class="s2">      nohpet console=hvc0 no_timer_check ignore_loglevel \</span>
<span class="s2">      log_buf_len=16M consoleblank=0 tsc=reliable&quot;</span> vm1
</pre></div>
</div>
<p>Then user could login into user OS:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>Ubuntu <span class="m">17</span>.04 xubuntu hvc0
xubuntu login: root
Password:
</pre></div>
</div>
<p>To use pty as a virtio-console backend, use the following command:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>./acrn-dm -A -m 1168M <span class="se">\</span>
   -s <span class="m">0</span>:0,hostbridge <span class="se">\</span>
   -s <span class="m">1</span>,virtio-blk,./uos.img <span class="se">\</span>
   -s <span class="m">2</span>,virtio-net,tap0 <span class="se">\</span>
   -s <span class="m">3</span>,virtio-console,@pty:pty<span class="se">\_</span>port <span class="se">\</span>
   -k ./bzImage -B <span class="s2">&quot;root=/dev/vda rw rootwait noxsave maxcpus=0 \</span>
<span class="s2">      nohpet console=hvc0 no_timer_check ignore_loglevel \</span>
<span class="s2">      log_buf_len=16M consoleblank=0 tsc=reliable&quot;</span> vm1 <span class="p">&amp;</span>
</pre></div>
</div>
<p>When ACRN-DM boots User OS successfully, a similar log will be shown
as below:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>**************************************************************
virt-console backend redirected to /dev/pts/0
**************************************************************
</pre></div>
</div>
<p>You can then use the following command to login the User OS:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>minicom -D /dev/pts/0
</pre></div>
</div>
<p>or</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>screen /dev/pts/0
</pre></div>
</div>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2019, Project ACRN.
      Last updated on Feb 11, 2019.

    </p>
  </div> 

</footer>

        </div>
      </div>

    </section>

  </div>
  
  <div class="rst-versions" data-toggle="rst-versions" role="note" aria-label="versions">
    <span class="rst-current-version" data-toggle="rst-current-version">
      <span class="fa fa-book"> Project ACRN</span>
      v: latest
      <span class="fa fa-caret-down"></span>
    </span>
    <div class="rst-other-versions">
      <dl>
        <dt>Versions</dt>
        
          <dd><a href="/latest/">latest</a></dd>
        
          <dd><a href="/0.5/">0.5</a></dd>
        
          <dd><a href="/0.4/">0.4</a></dd>
        
          <dd><a href="/0.3/">0.3</a></dd>
        
          <dd><a href="/0.2/">0.2</a></dd>
        
          <dd><a href="/0.1/">0.1</a></dd>
        
      </dl>
      <dl>
        <dt>On projectacrn.org</dt>
          <dd>
            <a href="https://www.projectacrn.org/">Project Home</a>
          </dd>
          <dd>
            <a href="https://github.com/projectacrn/acrn-hypervisor/wiki">Wiki</a>
          </dd>
      </dl>
    </div>
  </div>

  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../',
            VERSION:'v 0.6-unstable',
            LANGUAGE:'None',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="../_static/jquery.js"></script>
      <script type="text/javascript" src="../_static/underscore.js"></script>
      <script type="text/javascript" src="../_static/doctools.js"></script>
      <script type="text/javascript" src="../_static/acrn-custom.js"></script>

  

  <script type="text/javascript" src="../_static/js/theme.js"></script>

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>