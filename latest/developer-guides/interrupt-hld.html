

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Interrupt Management high-level design &mdash; Project ACRN™ v 0.2-unstable documentation</title>
  

  
  
    <link rel="shortcut icon" href="../_static/ACRN-favicon-32x32.png"/>
  
  
  

  

  
  
    

  

  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../_static/acrn-custom.css" type="text/css" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="GVT-G high-level design" href="APL_GVT-g-hld.html" />
    <link rel="prev" title="ACPI Virtualization high-level design" href="ACPI-virt-hld.html" /> 

  
  <script src="../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../index.html" class="icon icon-home"> Project ACRN™
          

          
            
            <img src="../_static/ACRN_Logo_200w.png" class="logo" alt="Logo"/>
          
          </a>

          
            
            
              <div class="version">
                latest
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../introduction/index.html">Introduction to Project ACRN</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../introduction/index.html#automotive-use-case-example">Automotive Use Case Example</a></li>
<li class="toctree-l2"><a class="reference internal" href="../introduction/index.html#licensing">Licensing</a></li>
<li class="toctree-l2"><a class="reference internal" href="../introduction/index.html#acrn-device-model-service-os-and-user-os">ACRN Device Model, Service OS, and User OS</a></li>
<li class="toctree-l2"><a class="reference internal" href="../introduction/index.html#boot-sequence">Boot Sequence</a></li>
<li class="toctree-l2"><a class="reference internal" href="../introduction/index.html#acrn-hypervisor-architecture">ACRN Hypervisor Architecture</a></li>
<li class="toctree-l2"><a class="reference internal" href="../introduction/index.html#acrn-device-model-architecture">ACRN Device Model Architecture</a></li>
<li class="toctree-l2"><a class="reference internal" href="../introduction/index.html#device-pass-through">Device pass through</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../introduction/index.html#hardware-support-for-device-passthrough">Hardware support for device passthrough</a></li>
<li class="toctree-l3"><a class="reference internal" href="../introduction/index.html#hypervisor-support-for-device-passthrough">Hypervisor support for device passthrough</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../introduction/index.html#acrn-i-o-mediator">ACRN I/O mediator</a></li>
<li class="toctree-l2"><a class="reference internal" href="../introduction/index.html#virtio-framework-architecture">Virtio framework architecture</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../getting-started/index.html">Getting Started Guides</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../getting-started/apl-nuc.html">Getting started guide for Intel NUC</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../getting-started/apl-nuc.html#hardware-setup">Hardware setup</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../getting-started/apl-nuc.html#firmware-update-on-the-nuc">Firmware update on the NUC</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../getting-started/apl-nuc.html#software-setup">Software setup</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../getting-started/apl-nuc.html#set-up-a-clear-linux-operating-system">Set up a Clear Linux Operating System</a></li>
<li class="toctree-l4"><a class="reference internal" href="../getting-started/apl-nuc.html#add-the-acrn-hypervisor-to-the-efi-partition">Add the ACRN hypervisor to the EFI Partition</a></li>
<li class="toctree-l4"><a class="reference internal" href="../getting-started/apl-nuc.html#acrn-network-bridge">ACRN Network Bridge</a></li>
<li class="toctree-l4"><a class="reference internal" href="../getting-started/apl-nuc.html#set-up-reference-uos">Set up Reference UOS</a></li>
<li class="toctree-l4"><a class="reference internal" href="../getting-started/apl-nuc.html#device-manager-memory-allocation-mechanism">Device Manager memory allocation mechanism</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../getting-started/apl-nuc.html#build-acrn-from-source">Build ACRN from Source</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../getting-started/apl-nuc.html#install-build-tools-and-dependencies">Install build tools and dependencies</a></li>
<li class="toctree-l4"><a class="reference internal" href="../getting-started/apl-nuc.html#build-the-hypervisor-device-model-and-tools">Build the hypervisor, device model and tools</a></li>
<li class="toctree-l4"><a class="reference internal" href="../getting-started/apl-nuc.html#generate-the-hypervisor-configurations">Generate the hypervisor configurations</a></li>
<li class="toctree-l4"><a class="reference internal" href="../getting-started/apl-nuc.html#modify-the-hypervisor-configurations">Modify the hypervisor configurations</a></li>
<li class="toctree-l4"><a class="reference internal" href="../getting-started/apl-nuc.html#create-a-new-default-configuration">Create a new default configuration</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../getting-started/up2.html">Getting started guide for UP2 board</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../getting-started/up2.html#hardware-setup">Hardware setup</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../getting-started/up2.html#connecting-to-the-serial-port">Connecting to the serial port</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../getting-started/up2.html#software-setup">Software setup</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../getting-started/up2.html#up2-serial-port-setting">UP2 serial port setting</a></li>
<li class="toctree-l4"><a class="reference internal" href="../getting-started/up2.html#up2-block-device">UP2 block device</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../getting-started/up2.html#running-the-hypervisor">Running the hypervisor</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../hardware.html">Supported Hardware</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../hardware.html#intel-apollo-lake-nuc">Intel Apollo Lake NUC</a></li>
<li class="toctree-l2"><a class="reference internal" href="../hardware.html#up-squared-board">UP Squared board</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../user-guides/index.html">User Guides</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../user-guides/acrn-shell.html">ACRN Shell Commands</a></li>
<li class="toctree-l2"><a class="reference internal" href="../user-guides/tools.html">Tools</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../tools/acrn-crashlog/README.html">ACRN-Crashlog</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../tools/acrn-crashlog/README.html#introduction">Introduction</a></li>
<li class="toctree-l4"><a class="reference internal" href="../tools/acrn-crashlog/README.html#building">Building</a></li>
<li class="toctree-l4"><a class="reference internal" href="../tools/acrn-crashlog/README.html#installing">Installing</a></li>
<li class="toctree-l4"><a class="reference internal" href="../tools/acrn-crashlog/README.html#usage">Usage</a></li>
<li class="toctree-l4"><a class="reference internal" href="../tools/acrn-crashlog/README.html#source-code">Source Code</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../tools/acrn-crashlog/acrnprobe/README.html">acrnprobe</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../tools/acrn-crashlog/acrnprobe/README.html#description">Description</a></li>
<li class="toctree-l4"><a class="reference internal" href="../tools/acrn-crashlog/acrnprobe/README.html#usage">Usage</a></li>
<li class="toctree-l4"><a class="reference internal" href="../tools/acrn-crashlog/acrnprobe/README.html#architecture">Architecture</a></li>
<li class="toctree-l4"><a class="reference internal" href="../tools/acrn-crashlog/acrnprobe/README.html#source-files">Source files</a></li>
<li class="toctree-l4"><a class="reference internal" href="../tools/acrn-crashlog/acrnprobe/README.html#configuration-files">Configuration files</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../tools/acrn-crashlog/acrnprobe/conf.html">acrnprobe Configuration</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../tools/acrn-crashlog/acrnprobe/conf.html#description">Description</a></li>
<li class="toctree-l4"><a class="reference internal" href="../tools/acrn-crashlog/acrnprobe/conf.html#layout">Layout</a></li>
<li class="toctree-l4"><a class="reference internal" href="../tools/acrn-crashlog/acrnprobe/conf.html#properties-of-group-members">Properties of group members</a></li>
<li class="toctree-l4"><a class="reference internal" href="../tools/acrn-crashlog/acrnprobe/conf.html#crash-tree-in-acrnprobe">Crash tree in acrnprobe</a></li>
<li class="toctree-l4"><a class="reference internal" href="../tools/acrn-crashlog/acrnprobe/conf.html#sections">Sections</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../tools/acrn-crashlog/usercrash/README.html">usercrash</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../tools/acrn-crashlog/usercrash/README.html#description">Description</a></li>
<li class="toctree-l4"><a class="reference internal" href="../tools/acrn-crashlog/usercrash/README.html#design">Design</a></li>
<li class="toctree-l4"><a class="reference internal" href="../tools/acrn-crashlog/usercrash/README.html#usage">Usage</a></li>
<li class="toctree-l4"><a class="reference internal" href="../tools/acrn-crashlog/usercrash/README.html#souce-code">Souce Code</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../tools/acrn-manager/README.html">acrnctl and acrnd</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../tools/acrn-manager/README.html#description">Description</a></li>
<li class="toctree-l4"><a class="reference internal" href="../tools/acrn-manager/README.html#usage">Usage</a></li>
<li class="toctree-l4"><a class="reference internal" href="../tools/acrn-manager/README.html#acrnd">acrnd</a></li>
<li class="toctree-l4"><a class="reference internal" href="../tools/acrn-manager/README.html#build-and-install">Build and Install</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../tools/acrnlog/README.html">acrnlog</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../tools/acrnlog/README.html#description">Description</a></li>
<li class="toctree-l4"><a class="reference internal" href="../tools/acrnlog/README.html#usage">Usage</a></li>
<li class="toctree-l4"><a class="reference internal" href="../tools/acrnlog/README.html#build-and-install">Build and Install</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../tools/acrntrace/README.html">acrntrace</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../tools/acrntrace/README.html#description">Description</a></li>
<li class="toctree-l4"><a class="reference internal" href="../tools/acrntrace/README.html#usage">Usage</a></li>
<li class="toctree-l4"><a class="reference internal" href="../tools/acrntrace/README.html#build-and-install">Build and Install</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Developer Guides</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="primer.html">Developer Primer</a><ul>
<li class="toctree-l3"><a class="reference internal" href="primer.html#source-tree-structure">Source Tree Structure</a><ul>
<li class="toctree-l4"><a class="reference internal" href="primer.html#acrn-hypervisor-source-tree">ACRN hypervisor source tree</a></li>
<li class="toctree-l4"><a class="reference internal" href="primer.html#acrn-device-model-source-tree">ACRN Device Model source tree</a></li>
<li class="toctree-l4"><a class="reference internal" href="primer.html#acrn-tools-source-tree">ACRN Tools source tree</a></li>
<li class="toctree-l4"><a class="reference internal" href="primer.html#acrn-documentation-source-tree">ACRN documentation source tree</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="primer.html#cpu-virtualization">CPU virtualization</a><ul>
<li class="toctree-l4"><a class="reference internal" href="primer.html#host-gdt">Host GDT</a></li>
<li class="toctree-l4"><a class="reference internal" href="primer.html#host-idt">Host IDT</a></li>
<li class="toctree-l4"><a class="reference internal" href="primer.html#guest-smp-booting">Guest SMP Booting</a></li>
<li class="toctree-l4"><a class="reference internal" href="primer.html#vmx-configuration">VMX configuration</a></li>
<li class="toctree-l4"><a class="reference internal" href="primer.html#cpuid-and-guest-tsc-calibration">CPUID and Guest TSC calibration</a></li>
<li class="toctree-l4"><a class="reference internal" href="primer.html#rdtsc-rdtscp">RDTSC/RDTSCP</a></li>
<li class="toctree-l4"><a class="reference internal" href="primer.html#cr-register-virtualization">CR Register virtualization</a></li>
<li class="toctree-l4"><a class="reference internal" href="primer.html#msr-bitmap">MSR BITMAP</a></li>
<li class="toctree-l4"><a class="reference internal" href="primer.html#i-o-bitmap">I/O BITMAP</a></li>
<li class="toctree-l4"><a class="reference internal" href="primer.html#exceptions">Exceptions</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="primer.html#memory-virtualization">Memory virtualization</a><ul>
<li class="toctree-l4"><a class="reference internal" href="primer.html#physical-memory-layout">Physical Memory Layout</a></li>
<li class="toctree-l4"><a class="reference internal" href="primer.html#pv-mmu-memory-mapping-in-the-hypervisor">PV (MMU) Memory Mapping in the Hypervisor</a></li>
<li class="toctree-l4"><a class="reference internal" href="primer.html#pv-mmu-memory-mapping-in-vms">PV (MMU) Memory Mapping in VMs</a></li>
<li class="toctree-l4"><a class="reference internal" href="primer.html#host-guest-ept-memory-mapping">Host-Guest (EPT) Memory Mapping</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="primer.html#graphic-mediation">Graphic mediation</a></li>
<li class="toctree-l3"><a class="reference internal" href="primer.html#i-o-emulation">I/O emulation</a><ul>
<li class="toctree-l4"><a class="reference internal" href="primer.html#device-assignment-management">Device Assignment Management</a></li>
<li class="toctree-l4"><a class="reference internal" href="primer.html#pio-mmio-trap-flow">PIO/MMIO trap Flow</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="primer.html#virtual-interrupt">Virtual interrupt</a><ul>
<li class="toctree-l4"><a class="reference internal" href="primer.html#virtual-lapic">Virtual LAPIC</a></li>
<li class="toctree-l4"><a class="reference internal" href="primer.html#virtual-ioapic">Virtual IOAPIC</a></li>
<li class="toctree-l4"><a class="reference internal" href="primer.html#virtual-pic">Virtual PIC</a></li>
<li class="toctree-l4"><a class="reference internal" href="primer.html#virtual-interrupt-injection">Virtual Interrupt Injection</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="primer.html#vt-x-and-vt-d">VT-x and VT-d</a></li>
<li class="toctree-l3"><a class="reference internal" href="primer.html#hypercall">Hypercall</a></li>
<li class="toctree-l3"><a class="reference internal" href="primer.html#device-emulation">Device emulation</a></li>
<li class="toctree-l3"><a class="reference internal" href="primer.html#virtio-devices">Virtio Devices</a><ul>
<li class="toctree-l4"><a class="reference internal" href="primer.html#virtio-rnd">Virtio-rnd</a></li>
<li class="toctree-l4"><a class="reference internal" href="primer.html#virtio-blk">Virtio-blk</a></li>
<li class="toctree-l4"><a class="reference internal" href="primer.html#virtio-net">Virtio-net</a></li>
<li class="toctree-l4"><a class="reference internal" href="primer.html#virtio-console">Virtio-console</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../api/index.html">API Documentation</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../api/hypercall_api.html">Hypercall APIs</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/devicemodel_api.html">Device Model APIs</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/GVT-g_api.html">ACRN GVT-g APIs</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/GVT-g_api.html#core-driver-infrastructure">Core Driver Infrastructure</a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/GVT-g_api.html#vhm-apis-called-from-acrn-gt">VHM APIs called from ACRN-GT</a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/GVT-g_api.html#acrn-gt-mediated-pass-through-mpt-interface">ACRN-GT mediated pass-through (MPT) interface</a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/GVT-g_api.html#gvt-g-intel-gvt-ops-interface">GVT-g intel_gvt_ops interface</a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/GVT-g_api.html#acrn-gt-sysfs-interface">ACRN-GT sysfs interface</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../reference/kconfig/index.html">Configuration Symbol Reference</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../reference/kconfig/index.html#introduction">Introduction</a></li>
<li class="toctree-l3"><a class="reference internal" href="../reference/kconfig/index.html#supported-options">Supported Options</a></li>
</ul>
</li>
<li class="toctree-l2 current"><a class="reference internal" href="index.html#high-level-design-guides">High-Level Design Guides</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="memmgt-hld.html">Memory Management high-level design</a><ul>
<li class="toctree-l4"><a class="reference internal" href="memmgt-hld.html#overview">Overview</a></li>
<li class="toctree-l4"><a class="reference internal" href="memmgt-hld.html#hypervisor-memory-management">Hypervisor Memory Management</a></li>
<li class="toctree-l4"><a class="reference internal" href="memmgt-hld.html#service-os-memory-management">Service OS Memory Management</a></li>
<li class="toctree-l4"><a class="reference internal" href="memmgt-hld.html#user-os-memory-management">User OS Memory Management</a></li>
<li class="toctree-l4"><a class="reference internal" href="memmgt-hld.html#memory-interaction">Memory Interaction</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="virtio-hld.html">Virtio high-level design</a><ul>
<li class="toctree-l4"><a class="reference internal" href="virtio-hld.html#virtio-device">Virtio Device</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="virtio-console.html">Virtio-Console High-Level design</a><ul>
<li class="toctree-l4"><a class="reference internal" href="virtio-console.html#console-backend-use-cases">Console Backend Use Cases</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="uart-virtualization.html">UART Virtualization</a><ul>
<li class="toctree-l4"><a class="reference internal" href="uart-virtualization.html#architecture">Architecture</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="ACPI-virt-hld.html">ACPI Virtualization high-level design</a><ul>
<li class="toctree-l4"><a class="reference internal" href="ACPI-virt-hld.html#acpi-introduction">ACPI introduction</a></li>
<li class="toctree-l4"><a class="reference internal" href="ACPI-virt-hld.html#acpi-virtualization">ACPI virtualization</a></li>
</ul>
</li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">Interrupt Management high-level design</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#overview">Overview</a></li>
<li class="toctree-l4"><a class="reference internal" href="#hypervisor-physical-interrupt-management">Hypervisor Physical Interrupt Management</a></li>
<li class="toctree-l4"><a class="reference internal" href="#guest-virtual-interrupt-management">Guest Virtual Interrupt Management</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="APL_GVT-g-hld.html">GVT-G high-level design</a><ul>
<li class="toctree-l4"><a class="reference internal" href="APL_GVT-g-hld.html#introduction">Introduction</a></li>
<li class="toctree-l4"><a class="reference internal" href="APL_GVT-g-hld.html#background">Background</a></li>
<li class="toctree-l4"><a class="reference internal" href="APL_GVT-g-hld.html#mediated-pass-through">Mediated Pass-Through</a></li>
<li class="toctree-l4"><a class="reference internal" href="APL_GVT-g-hld.html#high-level-architecture">High Level Architecture</a></li>
<li class="toctree-l4"><a class="reference internal" href="APL_GVT-g-hld.html#key-techniques">Key Techniques</a></li>
<li class="toctree-l4"><a class="reference internal" href="APL_GVT-g-hld.html#acrn-gt">ACRN-GT</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="GVT-G-porting.html">GVT-G Enabling and Porting Guide</a><ul>
<li class="toctree-l4"><a class="reference internal" href="GVT-G-porting.html#introduction">Introduction</a></li>
<li class="toctree-l4"><a class="reference internal" href="GVT-G-porting.html#purpose-of-this-document">Purpose of this document</a></li>
<li class="toctree-l4"><a class="reference internal" href="GVT-G-porting.html#overall-components">Overall Components</a></li>
<li class="toctree-l4"><a class="reference internal" href="GVT-G-porting.html#core-scenario-interaction-sequences">Core scenario interaction sequences</a></li>
<li class="toctree-l4"><a class="reference internal" href="GVT-G-porting.html#api-details">API details</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="index.html#contributing-to-the-project">Contributing to the project</a><ul>
<li class="toctree-l3"><a class="reference internal" href="contribute_guidelines.html">Contribution Guidelines</a><ul>
<li class="toctree-l4"><a class="reference internal" href="contribute_guidelines.html#licensing">Licensing</a></li>
<li class="toctree-l4"><a class="reference internal" href="contribute_guidelines.html#developer-certification-of-origin-dco">Developer Certification of Origin (DCO)</a></li>
<li class="toctree-l4"><a class="reference internal" href="contribute_guidelines.html#prerequisites">Prerequisites</a></li>
<li class="toctree-l4"><a class="reference internal" href="contribute_guidelines.html#repository-layout">Repository layout</a></li>
<li class="toctree-l4"><a class="reference internal" href="contribute_guidelines.html#submitting-issues">Submitting Issues</a></li>
<li class="toctree-l4"><a class="reference internal" href="contribute_guidelines.html#contribution-tools-and-git-setup">Contribution Tools and Git Setup</a></li>
<li class="toctree-l4"><a class="reference internal" href="contribute_guidelines.html#coding-style">Coding Style</a></li>
<li class="toctree-l4"><a class="reference internal" href="contribute_guidelines.html#contribution-workflow">Contribution Workflow</a></li>
<li class="toctree-l4"><a class="reference internal" href="contribute_guidelines.html#commit-guidelines">Commit Guidelines</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="doc_guidelines.html">Documentation Guidelines</a><ul>
<li class="toctree-l4"><a class="reference internal" href="doc_guidelines.html#headings">Headings</a></li>
<li class="toctree-l4"><a class="reference internal" href="doc_guidelines.html#content-highlighting">Content Highlighting</a></li>
<li class="toctree-l4"><a class="reference internal" href="doc_guidelines.html#lists">Lists</a></li>
<li class="toctree-l4"><a class="reference internal" href="doc_guidelines.html#multi-column-lists">Multi-column lists</a></li>
<li class="toctree-l4"><a class="reference internal" href="doc_guidelines.html#file-names-and-commands">File names and Commands</a></li>
<li class="toctree-l4"><a class="reference internal" href="doc_guidelines.html#internal-cross-reference-linking">Internal Cross-Reference Linking</a></li>
<li class="toctree-l4"><a class="reference internal" href="doc_guidelines.html#non-ascii-characters">Non-ASCII Characters</a></li>
<li class="toctree-l4"><a class="reference internal" href="doc_guidelines.html#code-and-command-examples">Code and Command Examples</a></li>
<li class="toctree-l4"><a class="reference internal" href="doc_guidelines.html#tabs-spaces-and-indenting">Tabs, spaces, and indenting</a></li>
<li class="toctree-l4"><a class="reference internal" href="doc_guidelines.html#drawings">Drawings</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="graphviz.html">Drawings using graphviz</a><ul>
<li class="toctree-l4"><a class="reference internal" href="graphviz.html#simple-directed-graph">Simple directed graph</a></li>
<li class="toctree-l4"><a class="reference internal" href="graphviz.html#adding-edge-labels">Adding edge labels</a></li>
<li class="toctree-l4"><a class="reference internal" href="graphviz.html#tables">Tables</a></li>
<li class="toctree-l4"><a class="reference internal" href="graphviz.html#finite-state-machine">Finite-State Machine</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../tutorials/index.html">Tutorials</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../tutorials/docbuild.html">ACRN documentation generation</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../tutorials/docbuild.html#documentation-overview">Documentation overview</a></li>
<li class="toctree-l3"><a class="reference internal" href="../tutorials/docbuild.html#set-up-the-documentation-working-folders">Set up the documentation working folders</a></li>
<li class="toctree-l3"><a class="reference internal" href="../tutorials/docbuild.html#installing-the-documentation-tools">Installing the documentation tools</a></li>
<li class="toctree-l3"><a class="reference internal" href="../tutorials/docbuild.html#documentation-presentation-theme">Documentation presentation theme</a></li>
<li class="toctree-l3"><a class="reference internal" href="../tutorials/docbuild.html#running-the-documentation-processors">Running the documentation processors</a></li>
<li class="toctree-l3"><a class="reference internal" href="../tutorials/docbuild.html#publishing-content">Publishing content</a></li>
<li class="toctree-l3"><a class="reference internal" href="../tutorials/docbuild.html#filtering-expected-warnings">Filtering expected warnings</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../tutorials/static-ip.html">Using a static IP address</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../tutorials/static-ip.html#acrn-network-setup">ACRN Network Setup</a></li>
<li class="toctree-l3"><a class="reference internal" href="../tutorials/static-ip.html#setting-up-the-static-ip-address">Setting up the static IP address</a></li>
<li class="toctree-l3"><a class="reference internal" href="../tutorials/static-ip.html#activate-the-new-configuration">Activate the new configuration</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../tutorials/using_ubuntu_as_sos.html">Using Ubuntu as the Service OS</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../tutorials/using_ubuntu_as_sos.html#install-ubuntu-natively">Install Ubuntu (natively)</a></li>
<li class="toctree-l3"><a class="reference internal" href="../tutorials/using_ubuntu_as_sos.html#install-acrn">Install ACRN</a></li>
<li class="toctree-l3"><a class="reference internal" href="../tutorials/using_ubuntu_as_sos.html#install-the-service-os-kernel">Install the Service OS kernel</a></li>
<li class="toctree-l3"><a class="reference internal" href="../tutorials/using_ubuntu_as_sos.html#prepare-the-user-os-uos">Prepare the User OS (UOS)</a></li>
<li class="toctree-l3"><a class="reference internal" href="../tutorials/using_ubuntu_as_sos.html#start-the-user-os-uos">Start the User OS (UOS)</a></li>
<li class="toctree-l3"><a class="reference internal" href="../tutorials/using_ubuntu_as_sos.html#enabling-network-sharing">Enabling network sharing</a></li>
<li class="toctree-l3"><a class="reference internal" href="../tutorials/using_ubuntu_as_sos.html#enabling-usb-keyboard-and-mouse">Enabling USB keyboard and mouse</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../release_notes.html">Release Notes</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../release_notes.html#version-0-1-release-july-2018">Version 0.1 release (July 2018)</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../release_notes.html#version-0-1-new-features">Version 0.1 new features</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../release_notes.html#hardware-support">Hardware Support</a></li>
<li class="toctree-l4"><a class="reference internal" href="../release_notes.html#gvt-g-for-acrn">GVT-g for ACRN</a></li>
<li class="toctree-l4"><a class="reference internal" href="../release_notes.html#virtio-standard-is-supported">Virtio standard is supported</a></li>
<li class="toctree-l4"><a class="reference internal" href="../release_notes.html#device-pass-through-support">Device pass-through support</a></li>
<li class="toctree-l4"><a class="reference internal" href="../release_notes.html#hypervisor-configuration">Hypervisor configuration</a></li>
<li class="toctree-l4"><a class="reference internal" href="../release_notes.html#new-acrn-tools">New ACRN tools</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../release_notes.html#known-issues">Known Issues</a></li>
<li class="toctree-l3"><a class="reference internal" href="../release_notes.html#change-log">Change Log</a></li>
</ul>
</li>
</ul>
</li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Project ACRN™</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
          <li><a href="index.html">Developer Guides</a> &raquo;</li>
        
      <li>Interrupt Management high-level design</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="interrupt-management-high-level-design">
<span id="interrupt-hld"></span><h1>Interrupt Management high-level design<a class="headerlink" href="#interrupt-management-high-level-design" title="Permalink to this headline">¶</a></h1>
<div class="section" id="overview">
<h2>Overview<a class="headerlink" href="#overview" title="Permalink to this headline">¶</a></h2>
<p>This document describes the interrupt management high-level design for
the ACRN hypervisor.</p>
<p>The ACRN hypervisor implements a simple but fully functional framework
to manage interrupts and exceptions, as show in
<a class="reference internal" href="#interrupt-modules-overview"><span class="std std-numref">Figure 43</span></a>. In its native layer, it configures
the physical PIC, IOAPIC, and LAPIC to support different interrupt
sources from local timer/IPI to external INTx/MSI. In its virtual guest
layer, it emulates virtual PIC, virtual IOAPIC and virtual LAPIC, and
provides full APIs allowing virtual interrupt injection from emulated or
pass-thru devices.</p>
<div class="figure align-center" id="interrupt-modules-overview">
<a class="reference internal image-reference" href="../_images/interrupt-image3.png"><img alt="../_images/interrupt-image3.png" src="../_images/interrupt-image3.png" style="width: 600px;" /></a>
<p class="caption"><span class="caption-number">Figure 43 </span><span class="caption-text">ACRN Interrupt Modules Overview</span></p>
</div>
<p>In the software modules view shown in <a class="reference internal" href="#interrupt-sw-modules"><span class="std std-numref">Figure 44</span></a>,
the ACRN hypervisor sets up the physical interrupt in its basic
interrupt modules (e.g., IOAPIC/LAPIC/IDT).  It dispatches the interrupt
in the hypervisor interrupt flow control layer to the corresponding
handlers, that could be pre-defined IPI notification, timer, or runtime
registered pass-thru devices.  The ACRN hypervisor then uses its VM
interfaces based on vPIC, vIOAPIC, and vMSI modules, to inject the
necessary virtual interrupt into the specific VM</p>
<div class="figure align-center" id="interrupt-sw-modules">
<a class="reference internal image-reference" href="../_images/interrupt-image2.png"><img alt="../_images/interrupt-image2.png" src="../_images/interrupt-image2.png" style="width: 600px;" /></a>
<p class="caption"><span class="caption-number">Figure 44 </span><span class="caption-text">ACRN Interrupt SW Modules Overview</span></p>
</div>
</div>
<div class="section" id="hypervisor-physical-interrupt-management">
<h2>Hypervisor Physical Interrupt Management<a class="headerlink" href="#hypervisor-physical-interrupt-management" title="Permalink to this headline">¶</a></h2>
<p>The ACRN hypervisor is responsible for all the physical interrupt
handling. All physical interrupts are first handled in VMX root-mode.
The “external-interrupt exiting” bit in the VM-Execution controls field
is set to support this. The ACRN hypervisor also initializes all the
interrupt related modules such as IDT, PIC, IOAPIC, and LAPIC.</p>
<p>Only a few physical interrupts (such as TSC-Deadline timer and IOMMU)
are fully serviced in the hypervisor. Most interrupts come from pass-thru
devices whose interrupt are remapped to a virtual INTx/MSI source and
injected to the SOS or UOS, according to the pass-thru device
configuration.</p>
<p>The ACRN hypervisor does handle exceptions and any exception coming from
the VMX root-mode will lead to the CPU halting. For guest exception, the
hypervisor only traps #MC (machine check), prints a warning message, and
injects the exception back into the guest OS.</p>
<div class="section" id="physical-interrupt-initialization">
<h3>Physical Interrupt Initialization<a class="headerlink" href="#physical-interrupt-initialization" title="Permalink to this headline">¶</a></h3>
<p>After the ACRN hypervisor get control from the bootloader, it
initializes all physical interrupt-related modules for all the CPUs. The
ACRN hypervisor creates a framework to manage the physical interrupt for
hypervisor-local devices, pass-thru devices, and IPI between CPUs.</p>
<div class="section" id="idt">
<h4>IDT<a class="headerlink" href="#idt" title="Permalink to this headline">¶</a></h4>
<p>The ACRN hypervisor builds its native Interrupt Descriptor Table (IDT) during
interrupt initialization. For exceptions, it links to function
<code class="docutils literal notranslate"><span class="pre">dispatch_exception</span></code>, and for external interrupts it links to function
<code class="docutils literal notranslate"><span class="pre">dispatch_interrupt</span></code>. Please refer to <code class="docutils literal notranslate"><span class="pre">arch/x86/idt.S</span></code> for more details.</p>
</div>
<div class="section" id="lapic">
<h4>LAPIC<a class="headerlink" href="#lapic" title="Permalink to this headline">¶</a></h4>
<p>The ACRN hypervisor resets LAPIC for each CPU, and provides basic APIs
used, for example, by the local timer (TSC Deadline)
program and IPI notification program.  These APIs include
write_laipic_reg32, send_lapic_eoi, send_startup_ipi, and
send_single_ipi.</p>
</div>
<div class="section" id="pic-ioapic">
<h4>PIC/IOAPIC<a class="headerlink" href="#pic-ioapic" title="Permalink to this headline">¶</a></h4>
<p>The ACRN hypervisor masks all interrupts from PIC, so all the
legacy interrupts from PIC (&lt;16) are linked to IOAPIC, as shown in
<a class="reference internal" href="#interrupt-pic-pin"><span class="std std-numref">Figure 45</span></a>.</p>
<p>ACRN will pre-allocate vectors and mask them for these legacy interrupts
in IOAPIC RTE. For others (&gt;= 16) ACRN will mask them with vector 0 in
RTE, and the vector will be dynamically allocated on demand.</p>
<div class="figure align-center" id="interrupt-pic-pin">
<a class="reference internal image-reference" href="../_images/interrupt-image5.png"><img alt="../_images/interrupt-image5.png" src="../_images/interrupt-image5.png" style="width: 600px;" /></a>
<p class="caption"><span class="caption-number">Figure 45 </span><span class="caption-text">PIC &amp; IOAPIC Pin Connection</span></p>
</div>
</div>
<div class="section" id="irq-desc">
<h4>Irq Desc<a class="headerlink" href="#irq-desc" title="Permalink to this headline">¶</a></h4>
<p>The ACRN hypervisor maintains a global <code class="docutils literal notranslate"><span class="pre">irq_desc[]</span></code> array shared among the
CPUs and uses a flat mode to manage the interrupts.  The same
vector is linked to the same IRQ number for all CPUs.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">irq_desc[]</span></code> array is indexed by the IRQ number. An
<code class="docutils literal notranslate"><span class="pre">irq_handler</span></code> field can be set to a common edge, level, or quick
handler called from <code class="docutils literal notranslate"><span class="pre">interrupt_dispatch</span></code>. The <code class="docutils literal notranslate"><span class="pre">irq_desc</span></code> structure
also contains the <code class="docutils literal notranslate"><span class="pre">dev_list</span></code> field to maintain this IRQ’s action
handler list.</p>
<p>The global array <code class="docutils literal notranslate"><span class="pre">vector_to_irq[]</span></code> is used to manage the vector
resource. This array is initialized with value <code class="docutils literal notranslate"><span class="pre">IRQ_INVALID</span></code> for all
vectors, and will be set to a valid IRQ number after the corresponding
vector is registered.</p>
<p>For example, if the local timer registers interrupt with IRQ number 271 and
vector 0xEF, then the arrays mentioned above will be set to:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">irq_desc</span><span class="p">[</span><span class="mi">271</span><span class="p">]</span><span class="o">.</span><span class="n">irq</span> <span class="o">=</span> <span class="mi">271</span><span class="p">;</span>
<span class="n">irq_desc</span><span class="p">[</span><span class="mi">271</span><span class="p">]</span><span class="o">.</span><span class="n">vector</span> <span class="o">=</span> <span class="mh">0xEF</span><span class="p">;</span>
<span class="n">vector_to_irq</span><span class="p">[</span><span class="mh">0xEF</span><span class="p">]</span> <span class="o">=</span> <span class="mi">271</span><span class="p">;</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="physical-interrupt-flow">
<h3>Physical Interrupt Flow<a class="headerlink" href="#physical-interrupt-flow" title="Permalink to this headline">¶</a></h3>
<p>When an physical interrupt occurs, and the CPU is running under VMX root
mode, the interrupt is triggered from the standard native irq flow:
interrupt gate to irq handler. However, if the CPU is running under VMX
non-root mode, an external interrupt will trigger a VM exit for reason
“external-interrupt”. See <a class="reference internal" href="#interrupt-handle-flow"><span class="std std-numref">Figure 46</span></a>.</p>
<div class="figure align-center" id="interrupt-handle-flow">
<a class="reference internal image-reference" href="../_images/interrupt-image4.png"><img alt="../_images/interrupt-image4.png" src="../_images/interrupt-image4.png" style="width: 800px;" /></a>
<p class="caption"><span class="caption-number">Figure 46 </span><span class="caption-text">ACRN Hypervisor Interrupt Handle Flow</span></p>
</div>
<p>After an interrupt happens (in either case noted above), the ACRN
hypervisor jumps to <code class="docutils literal notranslate"><span class="pre">dispatch_interrupt</span></code>. This function will check
which vector caused this interrupt, and the corresponding <code class="docutils literal notranslate"><span class="pre">irq_desc</span></code>
structure’s <code class="docutils literal notranslate"><span class="pre">irq_handler</span></code> will be called for the service.</p>
<p>There are several irq_handler’s defined in the ACRN hypervisor, as shown
in <a class="reference internal" href="#interrupt-handle-flow"><span class="std std-numref">Figure 46</span></a>, designed for different uses.  For
example, <code class="docutils literal notranslate"><span class="pre">quick_handler_nolock</span></code> is used when no critical data needs
protection in the action handlers; the VCPU notification IPI and local
timer are good example of this use case.</p>
<p>The more complicated <code class="docutils literal notranslate"><span class="pre">common_dev_handler_level</span></code> handler is intended
for pass-thru devices with level triggered interrupts. To avoid
continuously triggering the interrupt, it initially masks IOAPIC pin and
unmasks it only when the corresponding vIOAPIC pin gets an explicit EOI
ACK from the guest.</p>
<p>All the irq handler’s finally call their own action handler list, as
shown here:</p>
<p>The common APIs for registering, updating, and unregistering
interrupt handlers include irq_to_vector, dev_to_irq, dev_to_vector,
pri_register_handler, normal_register_handler,
unregister_handler_common, and update_irq_handler.</p>
</div>
<div class="section" id="physical-interrupt-source">
<span id="id1"></span><h3>Physical Interrupt Source<a class="headerlink" href="#physical-interrupt-source" title="Permalink to this headline">¶</a></h3>
<p>The ACRN hypervisor handles interrupts from many different sources, as
shown in <a class="reference internal" href="#interrupt-source"><span class="std std-numref">Table 6</span></a>:</p>
<table border="1" class="colwidths-given docutils" id="interrupt-source">
<caption><span class="caption-number">Table 6 </span><span class="caption-text">Physical Interrupt Source</span><a class="headerlink" href="#interrupt-source" title="Permalink to this table">¶</a></caption>
<colgroup>
<col width="18%" />
<col width="12%" />
<col width="71%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Interrupt Source</th>
<th class="head">Vector</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>TSC Deadline Timer</td>
<td>0xEF</td>
<td>The TSC deadline timer implements the timer framework in
the hypervisor based on the LAPIC TSC deadline. This interrupt’s
target is specific to the CPU to which the LAPIC belongs.</td>
</tr>
<tr class="row-odd"><td>CPU Startup IPI</td>
<td>N/A</td>
<td>The BSP needs to trigger an INIT-SIPI sequence to wake up the
APs. This interrupt’s target is specified by the BSP calling
`` start_cpus()``.</td>
</tr>
<tr class="row-even"><td>VCPU Notify IPI</td>
<td>0xF0</td>
<td>When the hypervisor needs to kick the VCPU out of VMX non-root
mode to do requests such as virtual interrupt injection, EPT
flush, etc. This interrupt’s target is specified by function
<code class="docutils literal notranslate"><span class="pre">send_single_ipi()</span></code>.</td>
</tr>
<tr class="row-odd"><td>IOMMU MSI</td>
<td>dynamic</td>
<td>IOMMU device supports an MSI interrupt. The vtd device driver in
the hypervisor will register an interrupt to handle dmar fault.
This interrupt’s target is specified by vtd device driver.</td>
</tr>
<tr class="row-even"><td>PTdev INTx</td>
<td>dynamic</td>
<td>All native devices are owned by the guest (SOS or UOS), taking
advantage of the pass-thru method. Each pass-thru device connected
with IOAPIC/PIC (PTdev INTx) will register an interrupt when
its attached interrupt controller pin first gets unmasked.
This interrupt’s target is defined by and RTE entry in the IOAPIC.</td>
</tr>
<tr class="row-odd"><td>PTdev MSI</td>
<td>dynamic</td>
<td>All native devices are owned by the guest (SOS or UOS), taking
advantage of pass-thru method. Each pass-thru device with
enabled MSI (PTdev MSI) will register an interrupt when the SOS
does an explicit hypercall. This interrupt’s target is defined
by an MSI address entry.</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="softirq">
<h3>Softirq<a class="headerlink" href="#softirq" title="Permalink to this headline">¶</a></h3>
<p>ACRN hypervisor implements a simple bottom-half softirq to execute the
interrupt handler, as showed in <a class="reference internal" href="#interrupt-handle-flow"><span class="std std-numref">Figure 46</span></a>.
The softirq is executed when an interrupt is enabled. Several APIs for softirq
are defined including enable_softirq, disable_softirq, raise_softirq,
and exec_softirq.</p>
</div>
<div class="section" id="physical-exception-handling">
<h3>Physical Exception Handling<a class="headerlink" href="#physical-exception-handling" title="Permalink to this headline">¶</a></h3>
<p>As mentioned earlier, the ACRN hypervisor does not handle any
physical exceptions. The VMX root mode code path should guarantee no
exceptions are triggered while the hypervisor is running.</p>
</div>
</div>
<div class="section" id="guest-virtual-interrupt-management">
<h2>Guest Virtual Interrupt Management<a class="headerlink" href="#guest-virtual-interrupt-management" title="Permalink to this headline">¶</a></h2>
<p>The previous sections describe physical interrupt management in the ACRN
hypervisor. After a physical interrupt happens, a registered action
handler is executed. Usually, the action handler represents a service
for virtual interrupt injection. For example, if an interrupt is
triggered from a pass-thru device, the appropriate virtual interrupt
should be injected into its guest VM.</p>
<p>The virtual interrupt injection could also come from an emulated device.
The I/O mediator in the Service OS (SOS) could trigger an interrupt
through a hypercall, and then do the virtual interrupt injection in the
hypervisor.</p>
<p>The following sections give an introduction to the ACRN guest virtual
interrupt management, including VCPU request for virtual interrupt kick
off, vPIC/vIOAPIC/vLAPIC for virtual interrupt injection interfaces,
physical-to-virtual interrupt mapping for a pass-thru device, and the
process of VMX interrupt/exception injection.</p>
<div class="section" id="vcpu-request">
<h3>VCPU Request<a class="headerlink" href="#vcpu-request" title="Permalink to this headline">¶</a></h3>
<p>As mentioned in <a class="reference internal" href="#physical-interrupt-source">physical_interrupt_source</a>, physical vector 0xF0 is
used to kick the VCPU out of its VMX non-root mode, and make a request
for virtual interrupt injection or other requests such as flush EPT.</p>
<p>The request-make API (vcpu_make_request) and eventid supports virtual interrupt
injection.</p>
<p>There are requests for exception injection (ACRN_REQUEST_EXCP), vLAPIC
event (ACRN_REQUEST_EVENT), external interrupt from vPIC
(ACRN_REQUEST_EXTINT) and non-maskable-interrupt (ACRN_REQUEST_NMI).</p>
<p>The <code class="docutils literal notranslate"><span class="pre">vcpu_make_request</span></code> is necessary for a virtual interrupt
injection.  If the target VCPU is running under VMX non-root mode, it
will send an IPI to kick it out and results in an external-interrupt
VM-Exit.  The flow of <a class="reference internal" href="#interrupt-handle-flow"><span class="std std-numref">Figure 46</span></a> could be executed
to complete the injection of a virtual interrupt.</p>
<p>There are some cases that do not need to send an IPI when making a
request because the CPU making the request is the target VCPU.  For
example, the #GP exception request always happens on the current CPU
when an invalid emulation happens. An external interrupt for a pass-thru
device always happens on the VCPUs the device belongs to, so after it
triggers an external-interrupt VM-Exit, the current CPU is also the
target VCPU.</p>
</div>
<div class="section" id="virtual-pic">
<h3>Virtual PIC<a class="headerlink" href="#virtual-pic" title="Permalink to this headline">¶</a></h3>
<p>The ACRN hypervisor emulates a vPIC for each VM based on IO ranges
0x20-0x21, 0xa0-0xa1, or 0x4d0-0x4d1.</p>
<p>If an interrupt source from vPIC needs to inject an interrupt,
the vpic_assert_irq, vpic_deassert_irq, or vpic_pulse_irq functions can
be called to make a request for ACRN_REQUEST_EXTINT or
ACRN_REQUEST_EVENT:</p>
<p>The vpic_pending_intr and vpic_intr_accepted APIs are used to query the
vector being injected and ACK the service, by moving the interrupt from
request service (IRR) to in service (ISR).</p>
</div>
<div class="section" id="virtual-ioapic">
<h3>Virtual IOAPIC<a class="headerlink" href="#virtual-ioapic" title="Permalink to this headline">¶</a></h3>
<p>ACRN hypervisor emulates a vIOAPIC for each VM based on MMIO
VIOAPIC_BASE.</p>
<p>If an interrupt source from vIOAPIC needs to inject an interrupt, the
vioapic_assert_irq, vioapic_dessert_irq, and vioapic_pulse_irq APIs are
used to make a request for ACRN_REQUEST_EVENT.</p>
<p>As the vIOAPIC is always associated with a vLAPIC, the virtual interrupt
injection from vIOAPIC will finally trigger a request for an vLAPIC
event.</p>
</div>
<div class="section" id="virtual-lapic">
<h3>Virtual LAPIC<a class="headerlink" href="#virtual-lapic" title="Permalink to this headline">¶</a></h3>
<p>The ACRN hypervisor emulates a vLAPIC for each VCPU based on MMIO
DEFAULT_APIC_BASE.</p>
<p>If an interrupt source from vLAPIC needs to inject an interrupt (e.g.,
from LVT such as an LAPIC timer, from vIOAPIC for a pass-thru device
interrupt, or from an emulated device for a MSI), vlapic_intr_level,
vlapic_intr_edge, vlapic_set_local_intr, vlapic_intr_msi,
vlapic_deliver_intr APIs need to be called, resulting in a request for
ACRN_REQUEST_EVENT.</p>
<p>The vlapic_pending_intr and vlapic_intr_accepted APIs are used to query
the vector that needs to be injected and ACK
the service that move the interrupt from request service (IRR) to in
service (ISR).</p>
<p>By default, the ACRN hypervisor enables vAPIC to improve the performance of
a vLAPIC emulation.</p>
</div>
<div class="section" id="virtual-exception">
<h3>Virtual Exception<a class="headerlink" href="#virtual-exception" title="Permalink to this headline">¶</a></h3>
<p>When doing emulation, an exception may be triggered in the hypervisor,
for example, if guest accesses an invalid vMSR register, or the
hypervisor needs to inject a #GP, or during instruction emulation, an
instruction fetch may access a non-exist page from rip_gva, and a #PF
must be injected.</p>
<p>ACRN hypervisor implements virtual exception injection using the
vcpu_queue_exception, vcpu_inject_gq, and vcpu_inject_pf APIs.</p>
<p>The ACRN hypervisor uses vcpu_inject_gp/vcpu_inject_pf functions to
queue exception requests, and follows <a class="reference external" href="SDMvol3">Intel Software
Developer Manual, Vol 3.</a> - 6.15, Table 6-5
listing conditions for generating a double fault.</p>
</div>
<div class="section" id="interrupt-mapping-for-a-pass-thru-device">
<h3>Interrupt Mapping for a Pass-thru Device<a class="headerlink" href="#interrupt-mapping-for-a-pass-thru-device" title="Permalink to this headline">¶</a></h3>
<p>A VM can control a PCI device directly through pass-thru device
assignment. The pass-thru entry is the major info object, and it is:</p>
<ul class="simple">
<li>A physical interrupt source, and could be a MSI/MSIX entry, PIC pins, or
IOAPIC pins</li>
<li>Pass-thru remapping information between physical and virtual interrupt
source, for MSI/MSIX it is identified by a PCI device’s BDF. For
PIC/IOAPIC it is identified by the pin number.</li>
</ul>
<div class="figure align-center" id="interrupt-pass-thru">
<a class="reference internal image-reference" href="../_images/interrupt-image7.png"><img alt="../_images/interrupt-image7.png" src="../_images/interrupt-image7.png" style="width: 600px;" /></a>
<p class="caption"><span class="caption-number">Figure 47 </span><span class="caption-text">Pass-thru Device Entry Assignment</span></p>
</div>
<p>As shown in <a class="reference internal" href="#interrupt-pass-thru"><span class="std std-numref">Figure 47</span></a> above, a UOS will assign its
pass-thru device entry by the DM, and it will fill its entry info from:</p>
<ul class="simple">
<li>vPIC/vIOAPIC interrupt mask/unmask</li>
<li>MSI IOReq from UOS then MSI hypercall from SOS</li>
</ul>
<p>The SOS adds its pass-thru device entry at runtime and fills info for:</p>
<ul class="simple">
<li>vPIC/vIOAPIC interrupt mask/unmask</li>
<li>MSI hypercall from SOS</li>
</ul>
<p>During the pass-thru device entry info filling, the hypervisor builds
native IOAPIC RTE/MSI entry based on vIOAPIC/vPIC/vMSI configuration,
and register the physical interrupt handler for it. Then with the pass-thru
device entry as the handler private data, the physical interrupt can
be linked to a virtual pin of a guest’s vPIC/vIOAPIC or virtual vector of
a guest’s vMSI. The handler then injects the corresponding virtual
interrupt into the guest, based on vPIC/vIOAPIC/vLAPIC APIs described
earlier.</p>
</div>
<div class="section" id="interrupt-exception-injection-process">
<h3>Interrupt/Exception Injection Process<a class="headerlink" href="#interrupt-exception-injection-process" title="Permalink to this headline">¶</a></h3>
<p>As shown in <a class="reference internal" href="#interrupt-handle-flow"><span class="std std-numref">Figure 46</span></a>, the ACRN hypervisor injects
virtual interrupt/exception to the guest before its VM-Entry.</p>
<p>This is done by updating the VMX_ENTRY_INT_INFO_FIELD of the VCPU’s
VMCS. As this field is unique, the interrupt/exception injection must
follow a priority rule to handle one-by-one.</p>
<p><a class="reference internal" href="#interrupt-injection"><span class="std std-numref">Figure 48</span></a> below shows the rules about how to inject
virtual interrupt/exception one-by-one. If a high priority
interrupt/exception was already injected, the next pending
interrupt/exception will enable an interrupt window where the next
injection will be done by the following VM-Exit, triggered by the
interrupt window.</p>
<div class="figure align-center" id="interrupt-injection">
<a class="reference internal image-reference" href="../_images/interrupt-image6.png"><img alt="../_images/interrupt-image6.png" src="../_images/interrupt-image6.png" style="width: 600px;" /></a>
<p class="caption"><span class="caption-number">Figure 48 </span><span class="caption-text">ACRN Hypervisor Interrupt/Exception Injection Process</span></p>
</div>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2018, Project ACRN.
      Last updated on Aug 31, 2018.

    </p>
  </div> 

</footer>

        </div>
      </div>

    </section>

  </div>
  
  <div class="rst-versions" data-toggle="rst-versions" role="note" aria-label="versions">
    <span class="rst-current-version" data-toggle="rst-current-version">
      <span class="fa fa-book"> Project ACRN</span>
      v: latest
      <span class="fa fa-caret-down"></span>
    </span>
    <div class="rst-other-versions">
      <dl>
        <dt>Versions</dt>
        
          <dd><a href="/latest/">latest</a></dd>
        
          <dd><a href="/0.1/">0.1</a></dd>
        
      </dl>
      <dl>
        <dt>On projectacrn.org</dt>
          <dd>
            <a href="https://www.projectacrn.org/">Project Home</a>
          </dd>
          <dd>
            <a href="https://github.com/projectacrn/acrn-hypervisor/wiki">Wiki</a>
          </dd>
      </dl>
    </div>
  </div>

  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../',
            VERSION:'v 0.2-unstable',
            LANGUAGE:'None',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="../_static/jquery.js"></script>
      <script type="text/javascript" src="../_static/underscore.js"></script>
      <script type="text/javascript" src="../_static/doctools.js"></script>
      <script type="text/javascript" src="../_static/acrn-custom.js"></script>

  

  <script type="text/javascript" src="../_static/js/theme.js"></script>

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>