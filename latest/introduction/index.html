

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Introduction to Project ACRN &mdash; Project ACRN™ v 0.2-unstable documentation</title>
  

  
  
    <link rel="shortcut icon" href="../_static/ACRN-favicon-32x32.png"/>
  
  
  

  

  
  
    

  

  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../_static/acrn-custom.css" type="text/css" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Getting Started Guides" href="../getting-started/index.html" />
    <link rel="prev" title="Project ACRN documentation" href="../index.html" /> 

  
  <script src="../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../index.html" class="icon icon-home"> Project ACRN™
          

          
            
            <img src="../_static/ACRN_Logo_200w.png" class="logo" alt="Logo"/>
          
          </a>

          
            
            
              <div class="version">
                latest
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1 current"><a class="current reference internal" href="#">Introduction to Project ACRN</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#automotive-use-case-example">Automotive Use Case Example</a></li>
<li class="toctree-l2"><a class="reference internal" href="#licensing">Licensing</a></li>
<li class="toctree-l2"><a class="reference internal" href="#acrn-device-model-service-os-and-user-os">ACRN Device Model, Service OS, and User OS</a></li>
<li class="toctree-l2"><a class="reference internal" href="#boot-sequence">Boot Sequence</a></li>
<li class="toctree-l2"><a class="reference internal" href="#acrn-hypervisor-architecture">ACRN Hypervisor Architecture</a></li>
<li class="toctree-l2"><a class="reference internal" href="#acrn-device-model-architecture">ACRN Device Model Architecture</a></li>
<li class="toctree-l2"><a class="reference internal" href="#device-pass-through">Device pass through</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#hardware-support-for-device-passthrough">Hardware support for device passthrough</a></li>
<li class="toctree-l3"><a class="reference internal" href="#hypervisor-support-for-device-passthrough">Hypervisor support for device passthrough</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#acrn-i-o-mediator">ACRN I/O mediator</a></li>
<li class="toctree-l2"><a class="reference internal" href="#virtio-framework-architecture">Virtio framework architecture</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../getting-started/index.html">Getting Started Guides</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../getting-started/apl-nuc.html">Getting started guide for Intel NUC</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../getting-started/apl-nuc.html#hardware-setup">Hardware setup</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../getting-started/apl-nuc.html#firmware-update-on-the-nuc">Firmware update on the NUC</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../getting-started/apl-nuc.html#software-setup">Software setup</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../getting-started/apl-nuc.html#set-up-a-clear-linux-operating-system">Set up a Clear Linux Operating System</a></li>
<li class="toctree-l4"><a class="reference internal" href="../getting-started/apl-nuc.html#add-the-acrn-hypervisor-to-the-efi-partition">Add the ACRN hypervisor to the EFI Partition</a></li>
<li class="toctree-l4"><a class="reference internal" href="../getting-started/apl-nuc.html#acrn-network-bridge">ACRN Network Bridge</a></li>
<li class="toctree-l4"><a class="reference internal" href="../getting-started/apl-nuc.html#set-up-reference-uos">Set up Reference UOS</a></li>
<li class="toctree-l4"><a class="reference internal" href="../getting-started/apl-nuc.html#device-manager-memory-allocation-mechanism">Device Manager memory allocation mechanism</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../getting-started/apl-nuc.html#build-acrn-from-source">Build ACRN from Source</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../getting-started/apl-nuc.html#install-build-tools-and-dependencies">Install build tools and dependencies</a></li>
<li class="toctree-l4"><a class="reference internal" href="../getting-started/apl-nuc.html#build-the-hypervisor-device-model-and-tools">Build the hypervisor, device model and tools</a></li>
<li class="toctree-l4"><a class="reference internal" href="../getting-started/apl-nuc.html#generate-the-hypervisor-configurations">Generate the hypervisor configurations</a></li>
<li class="toctree-l4"><a class="reference internal" href="../getting-started/apl-nuc.html#modify-the-hypervisor-configurations">Modify the hypervisor configurations</a></li>
<li class="toctree-l4"><a class="reference internal" href="../getting-started/apl-nuc.html#create-a-new-default-configuration">Create a new default configuration</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../getting-started/up2.html">Getting started guide for UP2 board</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../getting-started/up2.html#hardware-setup">Hardware setup</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../getting-started/up2.html#connecting-to-the-serial-port">Connecting to the serial port</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../getting-started/up2.html#software-setup">Software setup</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../getting-started/up2.html#up2-serial-port-setting">UP2 serial port setting</a></li>
<li class="toctree-l4"><a class="reference internal" href="../getting-started/up2.html#up2-block-device">UP2 block device</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../getting-started/up2.html#running-the-hypervisor">Running the hypervisor</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../hardware.html">Supported Hardware</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../hardware.html#intel-apollo-lake-nuc">Intel Apollo Lake NUC</a></li>
<li class="toctree-l2"><a class="reference internal" href="../hardware.html#up-squared-board">UP Squared board</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../user-guides/index.html">User Guides</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../user-guides/acrn-shell.html">ACRN Shell Commands</a></li>
<li class="toctree-l2"><a class="reference internal" href="../user-guides/tools.html">Tools</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../tools/acrn-crashlog/README.html">ACRN-Crashlog</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../tools/acrn-crashlog/README.html#introduction">Introduction</a></li>
<li class="toctree-l4"><a class="reference internal" href="../tools/acrn-crashlog/README.html#building">Building</a></li>
<li class="toctree-l4"><a class="reference internal" href="../tools/acrn-crashlog/README.html#installing">Installing</a></li>
<li class="toctree-l4"><a class="reference internal" href="../tools/acrn-crashlog/README.html#usage">Usage</a></li>
<li class="toctree-l4"><a class="reference internal" href="../tools/acrn-crashlog/README.html#source-code">Source Code</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../tools/acrn-crashlog/acrnprobe/README.html">acrnprobe</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../tools/acrn-crashlog/acrnprobe/README.html#description">Description</a></li>
<li class="toctree-l4"><a class="reference internal" href="../tools/acrn-crashlog/acrnprobe/README.html#usage">Usage</a></li>
<li class="toctree-l4"><a class="reference internal" href="../tools/acrn-crashlog/acrnprobe/README.html#architecture">Architecture</a></li>
<li class="toctree-l4"><a class="reference internal" href="../tools/acrn-crashlog/acrnprobe/README.html#source-files">Source files</a></li>
<li class="toctree-l4"><a class="reference internal" href="../tools/acrn-crashlog/acrnprobe/README.html#configuration-files">Configuration files</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../tools/acrn-crashlog/acrnprobe/conf.html">acrnprobe Configuration</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../tools/acrn-crashlog/acrnprobe/conf.html#description">Description</a></li>
<li class="toctree-l4"><a class="reference internal" href="../tools/acrn-crashlog/acrnprobe/conf.html#layout">Layout</a></li>
<li class="toctree-l4"><a class="reference internal" href="../tools/acrn-crashlog/acrnprobe/conf.html#properties-of-group-members">Properties of group members</a></li>
<li class="toctree-l4"><a class="reference internal" href="../tools/acrn-crashlog/acrnprobe/conf.html#crash-tree-in-acrnprobe">Crash tree in acrnprobe</a></li>
<li class="toctree-l4"><a class="reference internal" href="../tools/acrn-crashlog/acrnprobe/conf.html#sections">Sections</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../tools/acrn-crashlog/usercrash/README.html">usercrash</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../tools/acrn-crashlog/usercrash/README.html#description">Description</a></li>
<li class="toctree-l4"><a class="reference internal" href="../tools/acrn-crashlog/usercrash/README.html#design">Design</a></li>
<li class="toctree-l4"><a class="reference internal" href="../tools/acrn-crashlog/usercrash/README.html#usage">Usage</a></li>
<li class="toctree-l4"><a class="reference internal" href="../tools/acrn-crashlog/usercrash/README.html#souce-code">Souce Code</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../tools/acrn-manager/README.html">acrnctl and acrnd</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../tools/acrn-manager/README.html#description">Description</a></li>
<li class="toctree-l4"><a class="reference internal" href="../tools/acrn-manager/README.html#usage">Usage</a></li>
<li class="toctree-l4"><a class="reference internal" href="../tools/acrn-manager/README.html#acrnd">acrnd</a></li>
<li class="toctree-l4"><a class="reference internal" href="../tools/acrn-manager/README.html#build-and-install">Build and Install</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../tools/acrnlog/README.html">acrnlog</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../tools/acrnlog/README.html#description">Description</a></li>
<li class="toctree-l4"><a class="reference internal" href="../tools/acrnlog/README.html#usage">Usage</a></li>
<li class="toctree-l4"><a class="reference internal" href="../tools/acrnlog/README.html#build-and-install">Build and Install</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../tools/acrntrace/README.html">acrntrace</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../tools/acrntrace/README.html#description">Description</a></li>
<li class="toctree-l4"><a class="reference internal" href="../tools/acrntrace/README.html#usage">Usage</a></li>
<li class="toctree-l4"><a class="reference internal" href="../tools/acrntrace/README.html#build-and-install">Build and Install</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../developer-guides/index.html">Developer Guides</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../developer-guides/primer.html">Developer Primer</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../developer-guides/primer.html#source-tree-structure">Source Tree Structure</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../developer-guides/primer.html#acrn-hypervisor-source-tree">ACRN hypervisor source tree</a></li>
<li class="toctree-l4"><a class="reference internal" href="../developer-guides/primer.html#acrn-device-model-source-tree">ACRN Device Model source tree</a></li>
<li class="toctree-l4"><a class="reference internal" href="../developer-guides/primer.html#acrn-tools-source-tree">ACRN Tools source tree</a></li>
<li class="toctree-l4"><a class="reference internal" href="../developer-guides/primer.html#acrn-documentation-source-tree">ACRN documentation source tree</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../developer-guides/primer.html#cpu-virtualization">CPU virtualization</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../developer-guides/primer.html#host-gdt">Host GDT</a></li>
<li class="toctree-l4"><a class="reference internal" href="../developer-guides/primer.html#host-idt">Host IDT</a></li>
<li class="toctree-l4"><a class="reference internal" href="../developer-guides/primer.html#guest-smp-booting">Guest SMP Booting</a></li>
<li class="toctree-l4"><a class="reference internal" href="../developer-guides/primer.html#vmx-configuration">VMX configuration</a></li>
<li class="toctree-l4"><a class="reference internal" href="../developer-guides/primer.html#cpuid-and-guest-tsc-calibration">CPUID and Guest TSC calibration</a></li>
<li class="toctree-l4"><a class="reference internal" href="../developer-guides/primer.html#rdtsc-rdtscp">RDTSC/RDTSCP</a></li>
<li class="toctree-l4"><a class="reference internal" href="../developer-guides/primer.html#cr-register-virtualization">CR Register virtualization</a></li>
<li class="toctree-l4"><a class="reference internal" href="../developer-guides/primer.html#msr-bitmap">MSR BITMAP</a></li>
<li class="toctree-l4"><a class="reference internal" href="../developer-guides/primer.html#i-o-bitmap">I/O BITMAP</a></li>
<li class="toctree-l4"><a class="reference internal" href="../developer-guides/primer.html#exceptions">Exceptions</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../developer-guides/primer.html#memory-virtualization">Memory virtualization</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../developer-guides/primer.html#physical-memory-layout">Physical Memory Layout</a></li>
<li class="toctree-l4"><a class="reference internal" href="../developer-guides/primer.html#pv-mmu-memory-mapping-in-the-hypervisor">PV (MMU) Memory Mapping in the Hypervisor</a></li>
<li class="toctree-l4"><a class="reference internal" href="../developer-guides/primer.html#pv-mmu-memory-mapping-in-vms">PV (MMU) Memory Mapping in VMs</a></li>
<li class="toctree-l4"><a class="reference internal" href="../developer-guides/primer.html#host-guest-ept-memory-mapping">Host-Guest (EPT) Memory Mapping</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../developer-guides/primer.html#graphic-mediation">Graphic mediation</a></li>
<li class="toctree-l3"><a class="reference internal" href="../developer-guides/primer.html#i-o-emulation">I/O emulation</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../developer-guides/primer.html#device-assignment-management">Device Assignment Management</a></li>
<li class="toctree-l4"><a class="reference internal" href="../developer-guides/primer.html#pio-mmio-trap-flow">PIO/MMIO trap Flow</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../developer-guides/primer.html#virtual-interrupt">Virtual interrupt</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../developer-guides/primer.html#virtual-lapic">Virtual LAPIC</a></li>
<li class="toctree-l4"><a class="reference internal" href="../developer-guides/primer.html#virtual-ioapic">Virtual IOAPIC</a></li>
<li class="toctree-l4"><a class="reference internal" href="../developer-guides/primer.html#virtual-pic">Virtual PIC</a></li>
<li class="toctree-l4"><a class="reference internal" href="../developer-guides/primer.html#virtual-interrupt-injection">Virtual Interrupt Injection</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../developer-guides/primer.html#vt-x-and-vt-d">VT-x and VT-d</a></li>
<li class="toctree-l3"><a class="reference internal" href="../developer-guides/primer.html#hypercall">Hypercall</a></li>
<li class="toctree-l3"><a class="reference internal" href="../developer-guides/primer.html#device-emulation">Device emulation</a></li>
<li class="toctree-l3"><a class="reference internal" href="../developer-guides/primer.html#virtio-devices">Virtio Devices</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../developer-guides/primer.html#virtio-rnd">Virtio-rnd</a></li>
<li class="toctree-l4"><a class="reference internal" href="../developer-guides/primer.html#virtio-blk">Virtio-blk</a></li>
<li class="toctree-l4"><a class="reference internal" href="../developer-guides/primer.html#virtio-net">Virtio-net</a></li>
<li class="toctree-l4"><a class="reference internal" href="../developer-guides/primer.html#virtio-console">Virtio-console</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../api/index.html">API Documentation</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../api/hypercall_api.html">Hypercall APIs</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/devicemodel_api.html">Device Model APIs</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/GVT-g_api.html">ACRN GVT-g APIs</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/GVT-g_api.html#core-driver-infrastructure">Core Driver Infrastructure</a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/GVT-g_api.html#vhm-apis-called-from-acrn-gt">VHM APIs called from ACRN-GT</a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/GVT-g_api.html#acrn-gt-mediated-pass-through-mpt-interface">ACRN-GT mediated pass-through (MPT) interface</a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/GVT-g_api.html#gvt-g-intel-gvt-ops-interface">GVT-g intel_gvt_ops interface</a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/GVT-g_api.html#acrn-gt-sysfs-interface">ACRN-GT sysfs interface</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../reference/kconfig/index.html">Configuration Symbol Reference</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../reference/kconfig/index.html#introduction">Introduction</a></li>
<li class="toctree-l3"><a class="reference internal" href="../reference/kconfig/index.html#supported-options">Supported Options</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../developer-guides/index.html#high-level-design-guides">High-Level Design Guides</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../developer-guides/memmgt-hld.html">Memory Management high-level design</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../developer-guides/memmgt-hld.html#overview">Overview</a></li>
<li class="toctree-l4"><a class="reference internal" href="../developer-guides/memmgt-hld.html#hypervisor-memory-management">Hypervisor Memory Management</a></li>
<li class="toctree-l4"><a class="reference internal" href="../developer-guides/memmgt-hld.html#service-os-memory-management">Service OS Memory Management</a></li>
<li class="toctree-l4"><a class="reference internal" href="../developer-guides/memmgt-hld.html#user-os-memory-management">User OS Memory Management</a></li>
<li class="toctree-l4"><a class="reference internal" href="../developer-guides/memmgt-hld.html#memory-interaction">Memory Interaction</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../developer-guides/virtio-hld.html">Virtio high-level design</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../developer-guides/virtio-hld.html#virtio-device">Virtio Device</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../developer-guides/virtio-console.html">Virtio-Console High-Level design</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../developer-guides/virtio-console.html#console-backend-use-cases">Console Backend Use Cases</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../developer-guides/uart-virtualization.html">UART Virtualization</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../developer-guides/uart-virtualization.html#architecture">Architecture</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../developer-guides/ACPI-virt-hld.html">ACPI Virtualization high-level design</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../developer-guides/ACPI-virt-hld.html#acpi-introduction">ACPI introduction</a></li>
<li class="toctree-l4"><a class="reference internal" href="../developer-guides/ACPI-virt-hld.html#acpi-virtualization">ACPI virtualization</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../developer-guides/interrupt-hld.html">Interrupt Management high-level design</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../developer-guides/interrupt-hld.html#overview">Overview</a></li>
<li class="toctree-l4"><a class="reference internal" href="../developer-guides/interrupt-hld.html#hypervisor-physical-interrupt-management">Hypervisor Physical Interrupt Management</a></li>
<li class="toctree-l4"><a class="reference internal" href="../developer-guides/interrupt-hld.html#guest-virtual-interrupt-management">Guest Virtual Interrupt Management</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../developer-guides/APL_GVT-g-hld.html">GVT-G high-level design</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../developer-guides/APL_GVT-g-hld.html#introduction">Introduction</a></li>
<li class="toctree-l4"><a class="reference internal" href="../developer-guides/APL_GVT-g-hld.html#background">Background</a></li>
<li class="toctree-l4"><a class="reference internal" href="../developer-guides/APL_GVT-g-hld.html#mediated-pass-through">Mediated Pass-Through</a></li>
<li class="toctree-l4"><a class="reference internal" href="../developer-guides/APL_GVT-g-hld.html#high-level-architecture">High Level Architecture</a></li>
<li class="toctree-l4"><a class="reference internal" href="../developer-guides/APL_GVT-g-hld.html#key-techniques">Key Techniques</a></li>
<li class="toctree-l4"><a class="reference internal" href="../developer-guides/APL_GVT-g-hld.html#acrn-gt">ACRN-GT</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../developer-guides/GVT-G-porting.html">GVT-G Enabling and Porting Guide</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../developer-guides/GVT-G-porting.html#introduction">Introduction</a></li>
<li class="toctree-l4"><a class="reference internal" href="../developer-guides/GVT-G-porting.html#purpose-of-this-document">Purpose of this document</a></li>
<li class="toctree-l4"><a class="reference internal" href="../developer-guides/GVT-G-porting.html#overall-components">Overall Components</a></li>
<li class="toctree-l4"><a class="reference internal" href="../developer-guides/GVT-G-porting.html#core-scenario-interaction-sequences">Core scenario interaction sequences</a></li>
<li class="toctree-l4"><a class="reference internal" href="../developer-guides/GVT-G-porting.html#api-details">API details</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../developer-guides/index.html#contributing-to-the-project">Contributing to the project</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../developer-guides/contribute_guidelines.html">Contribution Guidelines</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../developer-guides/contribute_guidelines.html#licensing">Licensing</a></li>
<li class="toctree-l4"><a class="reference internal" href="../developer-guides/contribute_guidelines.html#developer-certification-of-origin-dco">Developer Certification of Origin (DCO)</a></li>
<li class="toctree-l4"><a class="reference internal" href="../developer-guides/contribute_guidelines.html#prerequisites">Prerequisites</a></li>
<li class="toctree-l4"><a class="reference internal" href="../developer-guides/contribute_guidelines.html#repository-layout">Repository layout</a></li>
<li class="toctree-l4"><a class="reference internal" href="../developer-guides/contribute_guidelines.html#submitting-issues">Submitting Issues</a></li>
<li class="toctree-l4"><a class="reference internal" href="../developer-guides/contribute_guidelines.html#contribution-tools-and-git-setup">Contribution Tools and Git Setup</a></li>
<li class="toctree-l4"><a class="reference internal" href="../developer-guides/contribute_guidelines.html#coding-style">Coding Style</a></li>
<li class="toctree-l4"><a class="reference internal" href="../developer-guides/contribute_guidelines.html#contribution-workflow">Contribution Workflow</a></li>
<li class="toctree-l4"><a class="reference internal" href="../developer-guides/contribute_guidelines.html#commit-guidelines">Commit Guidelines</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../developer-guides/doc_guidelines.html">Documentation Guidelines</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../developer-guides/doc_guidelines.html#headings">Headings</a></li>
<li class="toctree-l4"><a class="reference internal" href="../developer-guides/doc_guidelines.html#content-highlighting">Content Highlighting</a></li>
<li class="toctree-l4"><a class="reference internal" href="../developer-guides/doc_guidelines.html#lists">Lists</a></li>
<li class="toctree-l4"><a class="reference internal" href="../developer-guides/doc_guidelines.html#multi-column-lists">Multi-column lists</a></li>
<li class="toctree-l4"><a class="reference internal" href="../developer-guides/doc_guidelines.html#file-names-and-commands">File names and Commands</a></li>
<li class="toctree-l4"><a class="reference internal" href="../developer-guides/doc_guidelines.html#internal-cross-reference-linking">Internal Cross-Reference Linking</a></li>
<li class="toctree-l4"><a class="reference internal" href="../developer-guides/doc_guidelines.html#non-ascii-characters">Non-ASCII Characters</a></li>
<li class="toctree-l4"><a class="reference internal" href="../developer-guides/doc_guidelines.html#code-and-command-examples">Code and Command Examples</a></li>
<li class="toctree-l4"><a class="reference internal" href="../developer-guides/doc_guidelines.html#tabs-spaces-and-indenting">Tabs, spaces, and indenting</a></li>
<li class="toctree-l4"><a class="reference internal" href="../developer-guides/doc_guidelines.html#drawings">Drawings</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../developer-guides/graphviz.html">Drawings using graphviz</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../developer-guides/graphviz.html#simple-directed-graph">Simple directed graph</a></li>
<li class="toctree-l4"><a class="reference internal" href="../developer-guides/graphviz.html#adding-edge-labels">Adding edge labels</a></li>
<li class="toctree-l4"><a class="reference internal" href="../developer-guides/graphviz.html#tables">Tables</a></li>
<li class="toctree-l4"><a class="reference internal" href="../developer-guides/graphviz.html#finite-state-machine">Finite-State Machine</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../tutorials/index.html">Tutorials</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../tutorials/docbuild.html">ACRN documentation generation</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../tutorials/docbuild.html#documentation-overview">Documentation overview</a></li>
<li class="toctree-l3"><a class="reference internal" href="../tutorials/docbuild.html#set-up-the-documentation-working-folders">Set up the documentation working folders</a></li>
<li class="toctree-l3"><a class="reference internal" href="../tutorials/docbuild.html#installing-the-documentation-tools">Installing the documentation tools</a></li>
<li class="toctree-l3"><a class="reference internal" href="../tutorials/docbuild.html#documentation-presentation-theme">Documentation presentation theme</a></li>
<li class="toctree-l3"><a class="reference internal" href="../tutorials/docbuild.html#running-the-documentation-processors">Running the documentation processors</a></li>
<li class="toctree-l3"><a class="reference internal" href="../tutorials/docbuild.html#publishing-content">Publishing content</a></li>
<li class="toctree-l3"><a class="reference internal" href="../tutorials/docbuild.html#filtering-expected-warnings">Filtering expected warnings</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../tutorials/static-ip.html">Using a static IP address</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../tutorials/static-ip.html#acrn-network-setup">ACRN Network Setup</a></li>
<li class="toctree-l3"><a class="reference internal" href="../tutorials/static-ip.html#setting-up-the-static-ip-address">Setting up the static IP address</a></li>
<li class="toctree-l3"><a class="reference internal" href="../tutorials/static-ip.html#activate-the-new-configuration">Activate the new configuration</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../tutorials/using_ubuntu_as_sos.html">Using Ubuntu as the Service OS</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../tutorials/using_ubuntu_as_sos.html#install-ubuntu-natively">Install Ubuntu (natively)</a></li>
<li class="toctree-l3"><a class="reference internal" href="../tutorials/using_ubuntu_as_sos.html#install-acrn">Install ACRN</a></li>
<li class="toctree-l3"><a class="reference internal" href="../tutorials/using_ubuntu_as_sos.html#install-the-service-os-kernel">Install the Service OS kernel</a></li>
<li class="toctree-l3"><a class="reference internal" href="../tutorials/using_ubuntu_as_sos.html#prepare-the-user-os-uos">Prepare the User OS (UOS)</a></li>
<li class="toctree-l3"><a class="reference internal" href="../tutorials/using_ubuntu_as_sos.html#start-the-user-os-uos">Start the User OS (UOS)</a></li>
<li class="toctree-l3"><a class="reference internal" href="../tutorials/using_ubuntu_as_sos.html#enabling-network-sharing">Enabling network sharing</a></li>
<li class="toctree-l3"><a class="reference internal" href="../tutorials/using_ubuntu_as_sos.html#enabling-usb-keyboard-and-mouse">Enabling USB keyboard and mouse</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../release_notes.html">Release Notes</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../release_notes.html#version-0-1-release-july-2018">Version 0.1 release (July 2018)</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../release_notes.html#version-0-1-new-features">Version 0.1 new features</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../release_notes.html#hardware-support">Hardware Support</a></li>
<li class="toctree-l4"><a class="reference internal" href="../release_notes.html#gvt-g-for-acrn">GVT-g for ACRN</a></li>
<li class="toctree-l4"><a class="reference internal" href="../release_notes.html#virtio-standard-is-supported">Virtio standard is supported</a></li>
<li class="toctree-l4"><a class="reference internal" href="../release_notes.html#device-pass-through-support">Device pass-through support</a></li>
<li class="toctree-l4"><a class="reference internal" href="../release_notes.html#hypervisor-configuration">Hypervisor configuration</a></li>
<li class="toctree-l4"><a class="reference internal" href="../release_notes.html#new-acrn-tools">New ACRN tools</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../release_notes.html#known-issues">Known Issues</a></li>
<li class="toctree-l3"><a class="reference internal" href="../release_notes.html#change-log">Change Log</a></li>
</ul>
</li>
</ul>
</li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Project ACRN™</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
      <li>Introduction to Project ACRN</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="introduction-to-project-acrn">
<span id="introduction"></span><h1>Introduction to Project ACRN<a class="headerlink" href="#introduction-to-project-acrn" title="Permalink to this headline">¶</a></h1>
<p>The open source project ACRN defines a device hypervisor reference stack
and an architecture for running multiple software subsystems, managed
securely, on a consolidated system by means of a virtual machine
manager. It also defines a reference framework implementation for
virtual device emulation, called the “ACRN Device Model”.</p>
<p>The ACRN Hypervisor is a Type 1 reference hypervisor stack, running
directly on the bare-metal hardware, and is suitable for a variety of
IoT and embedded device solutions. The ACRN hypervisor addresses the gap
that currently exists between datacenter hypervisors, and hard
partitioning hypervisors. The ACRN hypervisor architecture partitions
the system into different functional domains, with carefully selected
guest OS sharing optimizations for IoT and embedded devices.</p>
<div class="section" id="automotive-use-case-example">
<h2>Automotive Use Case Example<a class="headerlink" href="#automotive-use-case-example" title="Permalink to this headline">¶</a></h2>
<p>An interesting use case example for the ACRN Hypervisor is in an automotive
scenario.  The ACRN hypervisor can be used for building a Software
Defined Cockpit (SDC) or an In-Vehicle Experience (IVE) solution.  As a
reference implementation, ACRN provides the basis for embedded
hypervisor vendors to build solutions with a reference I/O mediation
solution.</p>
<p>In this scenario, an automotive SDC system consists of the Instrument
Cluster (IC) system, the In-Vehicle Infotainment (IVI) system, and one
or more Rear Seat Entertainment (RSE) systems. Each system is running as
an isolated Virtual Machine (VM) for overall system safety
considerations.</p>
<p>An <strong>Instrument Cluster (IC)</strong> system is used to show the driver operational
information about the vehicle, such as:</p>
<ul class="simple">
<li>the speed, the fuel level, trip mile and other driving information of
the car;</li>
<li>projecting heads-up images on the windshield, with alerts for low
fuel or tire pressure;</li>
<li>showing rear-view camera, and surround-view for parking assistance.</li>
</ul>
<p>An <strong>In-Vehicle Infotainment (IVI)</strong> system’s capabilities can include:</p>
<ul class="simple">
<li>navigation systems, radios, and other entertainment systems;</li>
<li>connection to mobile devices for phone calls, music, and applications
via voice recognition;</li>
<li>control interaction by gesture recognition or touch.</li>
</ul>
<p>A <strong>Rear Seat Entertainment (RSE)</strong> system could run:</p>
<ul class="simple">
<li>entertainment system;</li>
<li>virtual office;</li>
<li>connection to the front-seat IVI system and mobile devices (cloud
connectivity).</li>
<li>connection to mobile devices for phone calls, music, and
applications via voice recognition;</li>
<li>control interaction by gesture recognition or touch</li>
</ul>
<p>The ACRN hypervisor can support both Linux* VM and Android* VM as a
User OS, with the User OS managed by the ACRN hypervisor. Developers and
OEMs can use this reference stack to run their own VMs, together with
IC, IVI, and RSE VMs. The Service OS runs as VM0 (also known as Dom0 in
other hypervisors) and the User OS runs as VM1, (also known as DomU).</p>
<p><a class="reference internal" href="#ivi-block"><span class="std std-numref">Figure 1</span></a> shows an example block diagram of using the ACRN
hypervisor.</p>
<div class="figure align-center" id="ivi-block">
<img alt="../_images/IVI-block.png" src="../_images/IVI-block.png" />
<p class="caption"><span class="caption-number">Figure 1 </span><span class="caption-text">Service OS and User OS on top of ACRN hypervisor</span></p>
</div>
<p>This ACRN hypervisor block diagram shows:</p>
<ul class="simple">
<li>The ACRN hypervisor sits right on top of the bootloader for fast
booting capabilities.</li>
<li>Partitioning of resources to ensure safety-critical and non-safety
critical domains are able to coexist on one platform.</li>
<li>Rich I/O mediators allows various I/O devices shared across VMs, and
thus delivers a comprehensive user experience</li>
<li>Multiple operating systems are supported by one SoC through efficient
virtualization.</li>
</ul>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>The yellow color parts in <a class="reference internal" href="#ivi-block"><span class="std std-numref">Figure 1</span></a> are part of the project
ACRN software stack. This is a reference architecture diagram and not
all features mentioned are fully functional. Other blocks will come from
other (open source) projects and are listed here for reference only.</p>
<p>For example: the Service OS and Linux Guest can come from the Clear
Linux project at <a class="reference external" href="https://clearlinux.org">https://clearlinux.org</a> and (in later updates) the
Android as a Guest support can come from <a class="reference external" href="https://01.org/projectceladon">https://01.org/projectceladon</a>.</p>
<p class="last">For the current ACRN-supported feature list, please see
<a class="reference internal" href="../release_notes.html#release-notes"><span class="std std-ref">Release Notes</span></a>.</p>
</div>
</div>
<div class="section" id="licensing">
<h2>Licensing<a class="headerlink" href="#licensing" title="Permalink to this headline">¶</a></h2>
<p>Both the ACRN hypervisor and ACRN Device model software are provided
under the permissive <a class="reference external" href="https://opensource.org/licenses/BSD-3-Clause">BSD-3-Clause</a> license, which allows
<em>“redistribution and use in source and binary forms, with or without
modification”</em> together with the intact copyright notice and
disclaimers noted in the license.</p>
</div>
<div class="section" id="acrn-device-model-service-os-and-user-os">
<h2>ACRN Device Model, Service OS, and User OS<a class="headerlink" href="#acrn-device-model-service-os-and-user-os" title="Permalink to this headline">¶</a></h2>
<p>To keep the hypervisor code base as small and efficient as possible, the
bulk of the device model implementation resides in the Service OS to
provide sharing and other capabilities. The details of which devices are
shared and the mechanism used for their sharing is described in
<a class="reference internal" href="#pass-through">pass-through</a> section below.</p>
<p>The Service OS runs with the system’s highest virtual machine priority
to ensure required device time-sensitive requirements and system quality
of service (QoS). Service OS tasks run with mixed priority. Upon a
callback servicing a particular User OS request, the corresponding
software (or mediator) in the Service OS inherits the User OS priority.
There may also be additional low-priority background tasks within the
Service OS.</p>
<p>In the automotive example we described above, the User OS is the central
hub of vehicle control and in-vehicle entertainment. It provides support
for radio and entertainment options, control of the vehicle climate
control, and vehicle navigation displays. It also provides connectivity
options for using USB, Bluetooth, and WiFi for third-party device
interaction with the vehicle, such as Android Auto* or Apple CarPlay*,
and many other features.</p>
</div>
<div class="section" id="boot-sequence">
<h2>Boot Sequence<a class="headerlink" href="#boot-sequence" title="Permalink to this headline">¶</a></h2>
<p>In <a class="reference internal" href="#boot-flow"><span class="std std-numref">Figure 2</span></a> we show a verified Boot Sequence with UEFI
on an Intel® Architecture platform NUC (see <a class="reference internal" href="../hardware.html#hardware"><span class="std std-ref">Supported Hardware</span></a>).</p>
<div class="figure align-center" id="boot-flow">
<img src="../_images/graphviz-48c6066ca27bb426e74c19722e9a7fdffe363ffe.png" alt="digraph G {
   rankdir=LR;
   bgcolor=&quot;transparent&quot;;
   UEFI -&gt; &quot;acrn.efi&quot; -&gt; &quot;OS\nBootloader&quot; -&gt;
     &quot;SOS\nKernel&quot; -&gt; &quot;ACRN\nDevice Model&quot; -&gt; &quot;Virtual\nBootloader&quot;;
}" />
<p class="caption"><span class="caption-number">Figure 2 </span><span class="caption-text">ACRN Hypervisor Boot Flow</span><a class="headerlink" href="#boot-flow" title="Permalink to this image">¶</a></p>
</div>
<p>The Boot process proceeds as follows:</p>
<ol class="arabic simple">
<li>UEFI verifies and boots the ACRN hypervisor and Service OS Bootloader</li>
<li>UEFI (or Service OS Bootloader) verifies and boots Service OS kernel</li>
<li>Service OS kernel verifies and loads ACRN Device Model and Virtual
bootloader through dm-verity</li>
<li>Virtual bootloader starts the User-side verified boot process</li>
</ol>
</div>
<div class="section" id="acrn-hypervisor-architecture">
<h2>ACRN Hypervisor Architecture<a class="headerlink" href="#acrn-hypervisor-architecture" title="Permalink to this headline">¶</a></h2>
<p>ACRN hypervisor is a Type 1 hypervisor, running directly on bare-metal
hardware. It implements a hybrid VMM architecture, using a privileged
service VM, running the Service OS that manages the I/O devices and
provides I/O mediation. Multiple User VMs are supported, with each of
them running Linux* or Android* OS as the User OS .</p>
<p>Running systems in separate VMs provides isolation between other VMs and
their applications, reducing potential attack surfaces and minimizing
safety interference.  However, running the systems in separate VMs may
introduce additional latency for applications.</p>
<p><a class="reference internal" href="#acrn-architecture"><span class="std std-numref">Figure 3</span></a> shows the ACRN hypervisor architecture, with
the automotive example IC VM and service VM together. The Service OS
(SOS) owns most of the devices including the platform devices, and
provides I/O mediation. Some of the PCIe devices may be passed through
to the User OSes via the VM configuration. The SOS runs the IC
applications and hypervisor-specific applications together, such as the
ACRN device model, and ACRN VM manager.</p>
<p>ACRN hypervisor also runs the ACRN VM manager to collect running
information of the User OS, and controls the User VM such as starting,
stopping, and pausing a VM, pausing or resuming a virtual CPU.</p>
<div class="figure align-center" id="acrn-architecture">
<img alt="../_images/architecture.png" src="../_images/architecture.png" />
<p class="caption"><span class="caption-number">Figure 3 </span><span class="caption-text">ACRN Hypervisor Architecture</span></p>
</div>
<p>ACRN hypervisor takes advantage of Intel Virtualization Technology
(Intel VT), and ACRN hypervisor runs in Virtual Machine Extension (VMX)
root operation, or host mode, or VMM mode. All the guests, including
UOS and SOS, run in VMX non-root operation, or guest mode. (Hereafter,
we use the terms VMM mode and Guest mode for simplicity).</p>
<p>The VMM mode has 4 protection rings, but runs the ACRN hypervisor in
ring 0 privilege only, leaving rings 1-3 unused. The guest (including
SOS &amp; UOS), running in Guest mode, also has its own four protection
rings (ring 0 to 3). The User kernel runs in ring 0 of guest mode, and
user land applications run in ring 3 of User mode (ring 1 &amp; 2 are
usually not used by commercial OSes).</p>
<div class="figure align-center" id="vmx-brief">
<img alt="../_images/VMX-brief.png" src="../_images/VMX-brief.png" />
<p class="caption"><span class="caption-number">Figure 4 </span><span class="caption-text">VMX Brief</span></p>
</div>
<p>As shown in <a class="reference internal" href="#vmx-brief"><span class="std std-numref">Figure 4</span></a>, VMM mode and guest mode are switched
through VM Exit and VM Entry. When the bootloader hands off control to
the ACRN hypervisor, the processor hasn’t enabled VMX operation yet. The
ACRN hypervisor needs to enable VMX operation thru a VMXON instruction
first. Initially, the processor stays in VMM mode when the VMX operation
is enabled. It enters guest mode thru a VM resume instruction (or first
time VM launch), and returns back to VMM mode thru a VM exit event. VM
exit occurs in response to certain instructions and events.</p>
<p>The behavior of processor execution in guest mode is controlled by a
virtual machine control structure (VMCS). VMCS contains the guest state
(loaded at VM Entry, and saved at VM Exit), the host state, (loaded at
the time of VM exit), and the guest execution controls. ACRN hypervisor
creates a VMCS data structure for each virtual CPU, and uses the VMCS to
configure the behavior of the processor running in guest mode.</p>
<p>When the execution of the guest hits a sensitive instruction, a VM exit
event may happen as defined in the VMCS configuration. Control goes back
to the ACRN hypervisor when the VM exit happens. The ACRN hypervisor
emulates the guest instruction (if the exit was due to privilege issue)
and resumes the guest to its next instruction, or fixes the VM exit
reason (for example if a guest memory page is not mapped yet) and resume
the guest to re-execute the instruction.</p>
<p>Note that the address space used in VMM mode is different from that in
guest mode. The guest mode and VMM mode use different memory mapping
tables, and therefore the ACRN hypervisor is protected from guest
access. The ACRN hypervisor uses EPT to map the guest address, using the
guest page table to map from guest linear address to guest physical
address, and using the EPT table to map from guest physical address to
machine physical address or host physical address (HPA).</p>
</div>
<div class="section" id="acrn-device-model-architecture">
<h2>ACRN Device Model Architecture<a class="headerlink" href="#acrn-device-model-architecture" title="Permalink to this headline">¶</a></h2>
<p>Because devices may need to be shared between VMs, device emulation is
used to give VM applications (and OSes) access to these shared devices.
Traditionally there are three architectural approaches to device
emulation:</p>
<ul class="simple">
<li>The first architecture is <strong>device emulation within the hypervisor</strong> which
is a common method implemented within the VMware* workstation product
(an operating system-based hypervisor). In this method, the hypervisor
includes emulations of common devices that the various guest operating
systems can share, including virtual disks, virtual network adapters,
and other necessary platform elements.</li>
<li>The second architecture is called <strong>user space device emulation</strong>. As the
name implies, rather than the device emulation being embedded within
the hypervisor, it is instead implemented in a separate user space
application. QEMU, for example, provides this kind of device emulation
also used by a large number of independent hypervisors. This model is
advantageous, because the device emulation is independent of the
hypervisor and can therefore be shared for other hypervisors. It also
permits arbitrary device emulation without having to burden the
hypervisor (which operates in a privileged state) with this
functionality.</li>
<li>The third variation on hypervisor-based device emulation is
<strong>paravirtualized (PV) drivers</strong>. In this model introduced by the <a class="reference external" href="https://wiki.xenproject.org/wiki/Understanding_the_Virtualization_Spectrum">XEN
project</a> the hypervisor includes the physical drivers, and each guest
operating system includes a hypervisor-aware driver that works in
concert with the hypervisor drivers.</li>
</ul>
<p>In the device emulation models discussed above, there’s a price to pay
for sharing devices. Whether device emulation is performed in the
hypervisor, or in user space within an independent VM, overhead exists.
This overhead is worthwhile as long as the devices need to be shared by
multiple guest operating systems. If sharing is not necessary, then
there are more efficient methods for accessing devices, for example
“pass-through”.</p>
<p>ACRN device model is a placeholder of the UOS. It allocates memory for
the User OS, configures and initializes the devices used by the UOS,
loads the virtual firmware, initializes the virtual CPU state, and
invokes the ACRN hypervisor service to execute the guest instructions.
ACRN Device model is an application running in the Service OS that
emulates devices based on command line configuration, as shown in
the architecture diagram <a class="reference internal" href="#device-model"><span class="std std-numref">Figure 5</span></a> below:</p>
<div class="figure align-center" id="device-model">
<img alt="../_images/device-model.png" src="../_images/device-model.png" />
<p class="caption"><span class="caption-number">Figure 5 </span><span class="caption-text">ACRN Device Model</span></p>
</div>
<p>ACRN Device model incorporates these three aspects:</p>
<dl class="docutils">
<dt><strong>Device Emulation</strong>:</dt>
<dd>ACRN Device model provides device emulation routines that register
their I/O handlers to the I/O dispatcher. When there is an I/O request
from the User OS device, the I/O dispatcher sends this request to the
corresponding device emulation routine.</dd>
<dt><strong>I/O Path</strong>:</dt>
<dd>see <a class="reference internal" href="#acrn-io-mediator">ACRN-io-mediator</a> below</dd>
<dt><strong>VHM</strong>:</dt>
<dd><p class="first">The Virtio and Hypervisor Service Module is a kernel module in the
Service OS acting as a middle layer to support the device model. The VHM
and its client handling flow is described below:</p>
<ol class="last arabic simple">
<li>ACRN hypervisor IOREQ is forwarded to the VHM by an upcall
notification to the SOS.</li>
<li>VHM will mark the IOREQ as “in process” so that the same IOREQ will
not pick up again. The IOREQ will be sent to the client for handling.
Meanwhile, the VHM is ready for another IOREQ.</li>
<li>IOREQ clients are either an SOS Userland application or a Service OS
Kernel space module. Once the IOREQ is processed and completed, the
Client will issue an IOCTL call to the VHM to notify an IOREQ state
change. The VHM then checks and hypercalls to ACRN hypervisor
notifying it that the IOREQ has completed.</li>
</ol>
</dd>
</dl>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>Userland: dm as ACRN Device Model.</p>
<p class="last">Kernel space: VBS-K, MPT Service, VHM itself</p>
</div>
</div>
<div class="section" id="device-pass-through">
<span id="pass-through"></span><h2>Device pass through<a class="headerlink" href="#device-pass-through" title="Permalink to this headline">¶</a></h2>
<p>At the highest level, device pass-through is about providing isolation
of a device to a given guest operating system so that the device can be
used exclusively by that guest.</p>
<div class="figure align-center" id="device-passthrough">
<img alt="../_images/device-passthrough.png" src="../_images/device-passthrough.png" />
<p class="caption"><span class="caption-number">Figure 6 </span><span class="caption-text">Device Passthrough</span></p>
</div>
<p>Near-native performance can be achieved by using device passthrough.
This is ideal for networking applications (or those with high disk I/O
needs) that have not adopted virtualization because of contention and
performance degradation through the hypervisor (using a driver in the
hypervisor or through the hypervisor to a user space emulation).
Assigning devices to specific guests is also useful when those devices
inherently wouldn’t be shared. For example, if a system includes
multiple video adapters, those adapters could be passed through to
unique guest domains.</p>
<p>Finally, there may be specialized PCI devices that only one guest domain
uses, so they should be passed through to the guest. Individual USB
ports could be isolated to a given domain too, or a serial port (which
is itself not shareable) could be isolated to a particular guest. In
ACRN hypervisor, we support USB controller Pass through only and we
don’t support pass through for a legacy serial port, (for example
0x3f8).</p>
<div class="section" id="hardware-support-for-device-passthrough">
<h3>Hardware support for device passthrough<a class="headerlink" href="#hardware-support-for-device-passthrough" title="Permalink to this headline">¶</a></h3>
<p>Intel’s current processor architectures provides support for device
pass-through with VT-d. VT-d maps guest physical address to machine
physical address, so device can use guest physical address directly.
When this mapping occurs, the hardware takes care of access (and
protection), and the guest operating system can use the device as if it
were a non-virtualized system. In addition to mapping guest to physical
memory, isolation prevents this device from accessing memory belonging
to other guests or the hypervisor.</p>
<p>Another innovation that helps interrupts scale to large numbers of VMs
is called Message Signaled Interrupts (MSI). Rather than relying on
physical interrupt pins to be associated with a guest, MSI transforms
interrupts into messages that are more easily virtualized (scaling to
thousands of individual interrupts). MSI has been available since PCI
version 2.2 but is also available in PCI Express (PCIe), where it allows
fabrics to scale to many devices. MSI is ideal for I/O virtualization,
as it allows isolation of interrupt sources (as opposed to physical pins
that must be multiplexed or routed through software).</p>
</div>
<div class="section" id="hypervisor-support-for-device-passthrough">
<h3>Hypervisor support for device passthrough<a class="headerlink" href="#hypervisor-support-for-device-passthrough" title="Permalink to this headline">¶</a></h3>
<p>By using the latest virtualization-enhanced processor architectures,
hypervisors and virtualization solutions can support device
pass-through (using VT-d), including Xen, KVM, and ACRN hypervisor.
In most cases, the guest operating system (User
OS) must be compiled to support pass-through, by using
kernel build-time options. Hiding the devices from the host VM may also
be required (as is done with Xen using pciback). Some restrictions apply
in PCI, for example, PCI devices behind a PCIe-to-PCI bridge must be
assigned to the same guest OS. PCIe does not have this restriction.</p>
</div>
</div>
<div class="section" id="acrn-i-o-mediator">
<span id="acrn-io-mediator"></span><h2>ACRN I/O mediator<a class="headerlink" href="#acrn-i-o-mediator" title="Permalink to this headline">¶</a></h2>
<p><a class="reference internal" href="#io-emulation-path"><span class="std std-numref">Figure 7</span></a> shows the flow of an example I/O emulation path.</p>
<div class="figure align-center" id="io-emulation-path">
<img alt="../_images/io-emulation-path.png" src="../_images/io-emulation-path.png" />
<p class="caption"><span class="caption-number">Figure 7 </span><span class="caption-text">I/O Emulation Path</span></p>
</div>
<p>Following along with the numbered items in <a class="reference internal" href="#io-emulation-path"><span class="std std-numref">Figure 7</span></a>:</p>
<ol class="arabic simple">
<li>When a guest execute an I/O instruction (PIO or MMIO), a VM exit happens.
ACRN hypervisor takes control, and analyzes the the VM
exit reason, which is a VMX_EXIT_REASON_IO_INSTRUCTION for PIO access.</li>
<li>ACRN hypervisor fetches and analyzes the guest instruction, and
notices it is a PIO instruction (<code class="docutils literal notranslate"><span class="pre">in</span> <span class="pre">AL,</span> <span class="pre">20h</span></code> in this example), and put
the decoded information (including the PIO address, size of access,
read/write, and target register) into the shared page, and
notify/interrupt the SOS to process.</li>
<li>The Virtio and hypervisor service module (VHM) in SOS receives the
interrupt, and queries the IO request ring to get the PIO instruction
details.</li>
<li>It checks to see if any kernel device claims
ownership of the IO port: if a kernel module claimed it, the kernel
module is activated to execute its processing APIs. Otherwise, the VHM
module leaves the IO request in the shared page and wakes up the
device model thread to process.</li>
<li>The ACRN device model follow the same mechanism as the VHM. The I/O
processing thread of device model queries the IO request ring to get the
PIO instruction details and checks to see if any (guest) device emulation
module claims ownership of the IO port: if a module claimed it,
the module is invoked to execute its processing APIs.</li>
<li>After the ACRN device module completes the emulation (port IO 20h access
in this example), (say uDev1 here), uDev1 puts the result into the
shared page (in register AL in this example).</li>
<li>ACRN device model then returns control to ACRN hypervisor to indicate the
completion of an IO instruction emulation, typically thru VHM/hypercall.</li>
<li>The ACRN hypervisor then knows IO emulation is complete, and copies
the result to the guest register context.</li>
<li>The ACRN hypervisor finally advances the guest IP to
indicate completion of instruction execution, and resumes the guest.</li>
</ol>
<p>The MMIO path is very similar, except the VM exit reason is different. MMIO
access usually is trapped thru VMX_EXIT_REASON_EPT_VIOLATION in
the hypervisor.</p>
</div>
<div class="section" id="virtio-framework-architecture">
<h2>Virtio framework architecture<a class="headerlink" href="#virtio-framework-architecture" title="Permalink to this headline">¶</a></h2>
<p>Virtio is an abstraction for a set of common emulated devices in any
type of hypervisor. In the ACRN reference stack, our
implementation is compatible with <a class="reference external" href="http://docs.oasis-open.org/virtio/virtio/v1.0/virtio-v1.0.html">Virtio spec</a> 0.9 and 1.0. By
following this spec, virtual environments and guests
should have a straightforward, efficient, standard and extensible
mechanism for virtual devices, rather than boutique per-environment or
per-OS mechanisms.</p>
<p>Virtio provides a common frontend driver framework which not only
standardizes device interfaces, but also increases code reuse across
different virtualization platforms.</p>
<div class="figure align-center" id="virtio-architecture">
<img alt="../_images/virtio-architecture.png" src="../_images/virtio-architecture.png" />
<p class="caption"><span class="caption-number">Figure 8 </span><span class="caption-text">Virtio Architecture</span></p>
</div>
<p>To better understand Virtio, especially its usage in
the ACRN project, several key concepts of Virtio are highlighted
here:</p>
<dl class="docutils">
<dt><strong>Front-End Virtio driver</strong> (a.k.a. frontend driver, or FE driver in this document)</dt>
<dd>Virtio adopts a frontend-backend architecture, which enables a simple
but flexible framework for both frontend and backend Virtio driver. The
FE driver provides APIs to configure the interface, pass messages, produce
requests, and notify backend Virtio driver. As a result, the FE driver
is easy to implement and the performance overhead of emulating device is
eliminated.</dd>
<dt><strong>Back-End Virtio driver</strong> (a.k.a. backend driver, or BE driver in this document)</dt>
<dd>Similar to FE driver, the BE driver, runs either in user-land or
kernel-land of host OS. The BE driver consumes requests from FE driver
and send them to the host’s native device driver. Once the requests are
done by the host native device driver, the BE driver notifies the FE
driver about the completeness of the requests.</dd>
<dt><strong>Straightforward</strong>: Virtio devices as standard devices on existing Buses</dt>
<dd>Instead of creating new device buses from scratch, Virtio devices are
built on existing buses. This gives a straightforward way for both FE
and BE drivers to interact with each other. For example, FE driver could
read/write registers of the device, and the virtual device could
interrupt FE driver, on behalf of the BE driver, in case of something is
happening.  Currently Virtio supports PCI/PCIe bus and MMIO bus. In
ACRN project, only PCI/PCIe bus is supported, and all the Virtio devices
share the same vendor ID 0x1AF4.</dd>
<dt><strong>Efficient</strong>: batching operation is encouraged</dt>
<dd>Batching operation and deferred notification are important to achieve
high-performance I/O, since notification between FE and BE driver
usually involves an expensive exit of the guest. Therefore batching
operating and notification suppression are highly encouraged if
possible. This will give an efficient implementation for the performance
critical devices.</dd>
<dt><strong>Standard: virtqueue</strong></dt>
<dd><p class="first">All the Virtio devices share a standard ring buffer and descriptor
mechanism, called a virtqueue, shown in Figure 6. A virtqueue
is a queue of scatter-gather buffers. There are three important
methods on virtqueues:</p>
<ul class="simple">
<li><code class="docutils literal notranslate"><span class="pre">add_buf</span></code> is for adding a request/response buffer in a virtqueue</li>
<li><code class="docutils literal notranslate"><span class="pre">get_buf</span></code> is for getting a response/request in a virtqueue, and</li>
<li><code class="docutils literal notranslate"><span class="pre">kick</span></code> is for notifying the other side for a virtqueue to
consume buffers.</li>
</ul>
<p>The virtqueues are created in guest physical memory by the FE drivers.
The BE drivers only need to parse the virtqueue structures to obtain
the requests and get the requests done. How virtqueue is organized is
specific to the User OS. In the implementation of Virtio in Linux, the
virtqueue is implemented as a ring buffer structure called vring.</p>
<p class="last">In ACRN, the virtqueue APIs can be leveraged
directly so users don’t need to worry about the details of the
virtqueue. Refer to the User OS for
more details about the virtqueue implementations.</p>
</dd>
<dt><strong>Extensible: feature bits</strong></dt>
<dd>A simple extensible feature negotiation mechanism exists for each virtual
device and its driver. Each virtual device could claim its
device specific features while the corresponding driver could respond to
the device with the subset of features the driver understands. The
feature mechanism enables forward and backward compatibility for the
virtual device and driver.</dd>
</dl>
<p>In the ACRN reference stack, we implement user-land and kernel
space as shown in <a class="reference internal" href="#virtio-framework-userland"><span class="std std-numref">Figure 9</span></a>:</p>
<div class="figure align-center" id="virtio-framework-userland">
<img alt="../_images/virtio-framework-userland.png" src="../_images/virtio-framework-userland.png" />
<p class="caption"><span class="caption-number">Figure 9 </span><span class="caption-text">Virtio Framework - User Land</span></p>
</div>
<p>In the Virtio user-land framework, the implementation is compatible with
Virtio Spec 0.9/1.0. The VBS-U is statically linked with Device Model,
and communicates with Device Model through the PCIe interface: PIO/MMIO
or MSI/MSIx. VBS-U accesses Virtio APIs through user space vring service
API helpers. User space vring service API helpers access shared ring
through remote memory map (mmap). VHM maps UOS memory with the help of
ACRN Hypervisor.</p>
<div class="figure align-center" id="virtio-framework-kernel">
<img alt="../_images/virtio-framework-kernel.png" src="../_images/virtio-framework-kernel.png" />
<p class="caption"><span class="caption-number">Figure 10 </span><span class="caption-text">Virtio Framework - Kernel Space</span></p>
</div>
<p>VBS-U offloads data plane processing to VBS-K. VBS-U initializes VBS-K
at the right timings, for example. The FE driver sets
VIRTIO_CONFIG_S_DRIVER_OK to avoid unnecessary device configuration
changes while running. VBS-K can access shared rings through VBS-K
virtqueue APIs. VBS-K virtqueue APIs are similar to VBS-U virtqueue
APIs. VBS-K registers as VHM client(s) to handle a continuous range of
registers</p>
<p>There may be one or more VHM-clients for each VBS-K, and there can be a
single VHM-client for all VBS-Ks as well. VBS-K notifies FE through VHM
interrupt APIs.</p>
</div>
</div>


           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2018, Project ACRN.
      Last updated on Aug 29, 2018.

    </p>
  </div> 

</footer>

        </div>
      </div>

    </section>

  </div>
  
  <div class="rst-versions" data-toggle="rst-versions" role="note" aria-label="versions">
    <span class="rst-current-version" data-toggle="rst-current-version">
      <span class="fa fa-book"> Project ACRN</span>
      v: latest
      <span class="fa fa-caret-down"></span>
    </span>
    <div class="rst-other-versions">
      <dl>
        <dt>Versions</dt>
        
          <dd><a href="/latest/">latest</a></dd>
        
          <dd><a href="/0.1/">0.1</a></dd>
        
      </dl>
      <dl>
        <dt>On projectacrn.org</dt>
          <dd>
            <a href="https://www.projectacrn.org/">Project Home</a>
          </dd>
          <dd>
            <a href="https://github.com/projectacrn/acrn-hypervisor/wiki">Wiki</a>
          </dd>
      </dl>
    </div>
  </div>

  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../',
            VERSION:'v 0.2-unstable',
            LANGUAGE:'None',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="../_static/jquery.js"></script>
      <script type="text/javascript" src="../_static/underscore.js"></script>
      <script type="text/javascript" src="../_static/doctools.js"></script>
      <script type="text/javascript" src="../_static/acrn-custom.js"></script>

  

  <script type="text/javascript" src="../_static/js/theme.js"></script>

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>